<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM de Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDK - Versão 9.6.0 compat -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script> <!-- Adicionado Firebase Auth -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* Texto cinza escuro padrão */
            margin: 0; /* Reset margin for full width */
        }
        #crmApp {
            max-width: none !important; /* Override max-w */
            width: 100% !important; /* Ensure full width */
            margin: 0 auto; /* Center if needed */
            padding: 1rem; /* Add some padding around the app */
        }
        @media (min-width: 640px) { /* sm */
            #crmApp {
                padding: 2rem;
            }
        }
        @media (min-width: 768px) { /* md */
            #crmApp {
                padding: 3rem;
            }
        }
        /* Estilo para a coluna fixa */
        #clientTable th:first-child {
            position: sticky;
            left: 0;
            background-color: #f3f4f6; /* Define explicitamente o fundo para o thead fixo */
            z-index: 2; /* Increased z-index to ensure it's always on top */
            border-right: 1px solid #e5e7eb; /* Opcional: Adiciona uma linha separadora */
        }
        #clientTable td:first-child {
            position: sticky;
            left: 0;
            /* background-color será definido via JS para acompanhar a cor da linha */
            z-index: 1; /* Garante que fique acima de outras células durante a rolagem, mas abaixo do thead sticky */
            border-right: 1px solid #e5e7eb; /* Opcional: Adiciona uma linha separadora */
        }
        /* Ajusta o padding para alinhamento visual com a coluna fixa */
        #clientTable th:not(:first-child),
        #clientTable td:not(:first-child) {
            padding-left: 1rem; /* Ajusta conforme necessário */
        }
        /* Estilo para o spinner de carregamento */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para o modo de edição do formulário */
        .edit-mode-border {
            border: 2px solid #3b82f6; /* Borda azul para indicar modo de edição */
        }
        /* Estilos para campos de edição rápida na tabela */
        .quick-edit-container {
            display: flex;
            align-items: center;
            gap: 4px; /* Espaçamento entre o input e o botão */
            flex-wrap: nowrap; /* Impede que os itens quebrem para a próxima linha */
        }
        .quick-edit-input {
            flex-grow: 1; /* Permite que o input cresça para preencher o espaço */
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.75rem; /* text-sm */
            background-color: #f0f4f8; /* Um cinza claro para destacar */
        }
        /* Ajuste específico para o select de status na edição rápida */
        .quick-edit-status .quick-edit-input {
            min-width: 120px; /* Largura mínima para o select de status */
        }

        .quick-edit-btn {
            background-color: #10b981; /* Verde */
            color: white;
            padding: 4px 8px;
            border: none; /* Remove borda padrão */
            border-radius: 4px;
            font-size: 0.625rem; /* text-xs */
            cursor: pointer;
            flex-shrink: 0; /* Não encolhe o botão */
        }
        .quick-edit-btn:hover {
            background-color: #059669; /* Verde mais escuro */
        }
        /* Estilos para a barra de mensagens fixa */
        #messageBox {
            position: fixed !important; /* Força a posição fixa */
            bottom: 20px !important;
            right: 20px !important;
            z-index: 1000 !important;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #333 !important; /* Fundo escuro para destacar */
            color: white !important; /* Texto branco */
            padding: 10px 15px; /* Mais padding para ser visível */
            border-radius: 8px; /* Cantos arredondados */
        }

        /* Novas classes para destaque de linhas */
        .in-progress-row { /* Adicionado para status 'Em Andamento' */
            background-color: #fffde7; /* Amarelo claro */
        }
        .meeting-scheduled-row {
            background-color: #fffbeb; /* bg-amber-100 */
        }
        .contract-signed-row {
            background-color: #dcfce7; /* bg-green-100 */
        }
        /* Garante que o background padrão da linha seja branco, se não for sobrescrito */
        #clientTable tbody tr {
            /* background-color será definido no JS via classes Tailwind */
        }

        /* Estilos para o modal de confirmação */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 44px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .modal-button {
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .modal-button.confirm {
            background-color: #ef4444; /* red-500 */
            color: white;
        }

        .modal-button.cancel {
            background-color: #6b7280; /* gray-500 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <div id="crmApp" class="bg-white rounded-xl shadow-lg">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 py-6">Cadastro de Clientes CRM</h1>

        <!-- Removido o display do ID de Usuário para simplificar a interface -->
        <!-- <div class="mb-2 p-4 md:p-6 bg-white rounded-lg border border-gray-200">
            <p class="text-sm text-gray-600 text-center">Seu ID de Usuário: <span id="userIdDisplay" class="font-bold text-blue-600">Carregando...</span></p>
        </div> -->

        <div class="mb-6 p-4 md:p-6 bg-white rounded-lg border border-gray-200">
            <label for="rawDataInput" class="block text-lg font-semibold text-gray-700 mb-3">
                Cole os dados do Google Meu Negócio aqui:
            </label>
            <textarea id="rawDataInput" rows="6" md:rows="8"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900 placeholder-gray-400"
                      placeholder="Ex: Nome da Empresa: Minha Loja Ltda.&#10;Telefone: (11) 98765-4321&#10;Site: www.minhaloja.com.br&#10;Endereço: Rua Exemplo, 123, Centro, Cidade - SP&#10;Email: contato@minhaloja.com.br&#10;Nome de Contato: João Silva&#10;Data do Primeiro Contato: 2024-07-01&#10;Data da Consultoria Gratuita: 2024-07-05&#10;Horário da Consultoria Gratuita: 10:00&#10;Data da Segunda Reunião: 2024-07-10&#10;Horário da Segunda Reunião: 14:30&#10;Data de Início do Contrato: 2023-01-15&#10;Status: Novo Cliente&#10;Último Contato: 2023-05-15"></textarea>
            <button id="fillFormButton"
                    class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                Preencher Formulário
            </button>
        </div>

        <div id="clientDetailsContainer" class="mb-6 p-4 md:p-6 bg-white rounded-xl border border-gray-200">
            <h2 class="text-xl md:text-2xl font-bold text-center text-gray-800 mb-4 md:mb-6">Detalhes do Cliente</h2>
            <form id="clientForm" class="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-6">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa:</label>
                    <input type="text" id="companyName"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="contactName" class="block text-sm font-medium text-gray-700 mb-1">Nome de Contato:</label>
                    <input type="text" id="contactName"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone:</label>
                    <input type="text" id="phone"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                    <input type="email" id="email"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="website" class="block text-sm font-medium text-gray-700 mb-1">Site:</label>
                    <input type="url" id="website"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="md:col-span-2">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Endereço:</label>
                    <input type="text" id="address"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="firstContactDate" class="block text-sm font-medium text-gray-700 mb-1">Data do Primeiro Contato:</label>
                    <input type="date" id="firstContactDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="freeConsultationDate" class="block text-sm font-medium text-gray-700 mb-1">Data da Consultoria Gratuita:</label>
                    <input type="date" id="freeConsultationDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="freeConsultationTime" class="block text-sm font-medium text-gray-700 mb-1">Horário da Consultoria Gratuita:</label>
                    <input type="time" id="freeConsultationTime"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="secondMeetingDate" class="block text-sm font-medium text-gray-700 mb-1">Data da Segunda Reunião:</label>
                    <input type="date" id="secondMeetingDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="secondMeetingTime" class="block text-sm font-medium text-gray-700 mb-1">Horário da Segunda Reunião:</label>
                    <input type="time" id="secondMeetingTime"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="contractStartDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Início do Contrato:</label>
                    <input type="date" id="contractStartDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                    <select id="status"
                            class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                        <option value="Novo Cliente">Novo Cliente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Perdido">Perdido</option>
                        <option value="Reunião Agendada">Reunião Agendada</option>
                        <option value="Consultoria Gratuita Agendada">Consultoria Gratuita Agendada</option>
                        <option value="Segunda Reunião Agendada">Segunda Reunião Agendada</option>
                        <option value="Contrato Assinado">Contrato Assinado</option>
                    </select>
                </div>
                <div>
                    <label for="lastContactDate" class="block text-sm font-medium text-gray-700 mb-1">Data Último Contato:</label>
                    <input type="date" id="lastContactDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="md:col-span-2">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Observações:</label>
                    <textarea id="notes" rows="3" md:rows="4"
                              class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900"></textarea>
                </div>
            </form>
            <div class="mt-4 md:mt-6 flex justify-center space-x-2 md:space-x-4">
                <button id="addClientButton"
                        class="w-1/2 md:w-1/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center" disabled>
                    Cadastrar
                    <span id="loadingSpinner" class="loading-spinner hidden"></span>
                </button>
                <button id="updateClientButton"
                        class="w-1/2 md:w-1/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center" disabled>
                    Atualizar
                    <span id="updateLoadingSpinner" class="loading-spinner hidden"></span>
                </button>
                <button id="cancelEditButton"
                        class="w-full md:w-auto bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                    Cancelar
                </button>
            </div>
        </div>

        <div class="p-4 md:p-6 bg-white rounded-lg border border-gray-200">
            <h2 class="text-xl md:text-2xl font-bold text-center text-gray-800 mb-4 md:mb-6">Clientes Cadastrados</h2>

            <div class="mb-4 p-3 md:p-4 bg-gray-50 rounded-lg border border-gray-200 flex flex-wrap items-end gap-2 md:gap-4">
                <div class="flex-1 min-w-[150px]">
                    <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Status:</label>
                    <select id="filterStatus" multiple size="4"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                        <option value="">Todos</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Novo Cliente">Novo Cliente</option>
                        <option value="Perdido">Perdido</option>
                        <option value="Reunião Agendada">Reunião Agendada</option>
                        <option value="Consultoria Gratuita Agendada">Consultoria Gratuita Agendada</option>
                        <option value="Segunda Reunião Agendada">Segunda Reunião Agendada</option>
                        <option value="Contrato Assinado">Contrato Assinado</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label for="filterDateFrom" class="block text-sm font-medium text-gray-700 mb-1">Último Contato De:</label>
                    <input type="date" id="filterDateFrom"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label for="filterDateTo" class="block text-sm font-medium text-gray-700 mb-1">Último Contato Até:</label>
                    <input type="date" id="filterDateTo"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="flex-none mt-2 md:mt-0">
                    <button id="applyFiltersButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                        Aplicar Filtros
                    </button>
                </div>
                <div class="flex-none mt-2 md:mt-0">
                    <button id="clearFiltersButton"
                            class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                        Limpar Filtros
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label for="generalSearchInput" class="block text-lg font-semibold text-gray-700 mb-2">Pesquisa Geral:</label>
                <div class="flex gap-2 md:gap-4">
                    <input type="text" id="generalSearchInput" placeholder="Pesquisar por nome, telefone, email, etc."
                           class="flex-1 p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900 text-sm">
                    <button id="searchButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                        Pesquisar
                    </button>
                </div>
            </div>

            <div class="mb-3 md:mb-4 text-right flex justify-end space-x-2">
                <button id="exportExcelButton"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                    Exportar Excel
                </button>
                <button id="deleteClientButton"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm flex items-center justify-center" disabled>
                    Excluir
                    <span id="deleteLoadingSpinner" class="loading-spinner hidden"></span>
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table id="clientTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider rounded-tl-lg">Nome da Empresa</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nome de Contato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider min-w-[120px]">Telefone</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Site</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Endereço</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data Primeiro Contato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data Consultoria Gratuita</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Horário Consultoria Gratuita</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data Segunda Reunião</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Horário Segunda Reunião</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Início Contrato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Tempo de Contrato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider min-w-[120px]">Status</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Último Contato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider rounded-tr-lg">Observações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200" id="clientTableBody">
                        </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-3 md:mt-4 space-x-2 md:space-x-4">
                <button id="prevPageButton"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm" disabled>
                    Anterior
                </button>
                <button id="nextPageButton"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm" disabled>
                    Próxima
                </button>
            </div>
            <div id="messageBox" class="hidden mt-2 md:mt-4 p-3 text-center text-sm rounded-lg" role="alert"></div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="modal-button confirm">Confirmar</button>
                <button id="modalCancelBtn" class="modal-button cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Define a configuração do Firebase (API Key e outros detalhes)
        // Prioriza as configurações do ambiente Canvas, se disponíveis.
        let firebaseConfig;
        let appId; // Renomeado de canvasAppId para appId para ser consistente com o resto do código

        // Default hardcoded configuration
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyABjUhnHsga9jPyl0Vz57BLam06j8a0KYY",
            authDomain: "crm-vizione-firestore.firebaseapp.com",
            projectId: "crm-vizione-firestore",
            storageBucket: "crm-vizione-firestore.firebasestorage.app",
            messagingSenderId: "232305324276",
            appId: "1:232305324276:web:5bd26e12569449bb5eeea1"
        };

        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                // Use __app_id if available, otherwise fallback to projectId from Canvas config
                appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
            } catch (e) {
                console.error("Erro ao analisar __firebase_config do Canvas:", e);
                // Fallback to default hardcoded config if parsing fails
                firebaseConfig = defaultFirebaseConfig;
                appId = firebaseConfig.projectId; // Use projectId as fallback for appId
            }
        } else {
            // Use the default hardcoded configuration for environments outside Canvas
            firebaseConfig = defaultFirebaseConfig;
            appId = firebaseConfig.projectId; // Use projectId as fallback for appId
        }

        // Inicializa o Firebase, se ainda não foi inicializado
        let firebaseApp;
        try {
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app(); // Se já inicializado, apenas pega a instância
            }
        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
            // Pode ser um erro de inicialização duplicada ou configuração inválida
            if (error.code === 'app/duplicate-app') {
                firebaseApp = firebase.app();
            } else {
                // Se for outro erro, exibe mensagem e desabilita funcionalidades
                // Note: showMessage might not be fully initialized yet if this is a very early error
                // console.error is the most reliable way to report here.
                document.getElementById('addClientButton').disabled = true;
                document.getElementById('updateClientButton').disabled = true;
                document.getElementById('deleteClientButton').disabled = true;
                isAuthReady = false;
            }
        }
        
        // Pega as instâncias do Firestore e Auth
        const db = firebase.firestore();
        const auth = firebase.auth();


        // Constantes e variáveis globais
        const CLIENTES_POR_PAGINA = 10; // Define quantos clientes serão exibidos por página
        let clients = []; // Array que armazena os clientes atualmente exibidos na tabela
        let lastVisibleDoc = null; // Referência ao último documento da página atual para paginação 'próxima'
        let firstVisibleDoc = null; // Referência ao primeiro documento da página atual para paginação 'anterior'
        let paginationHistory = []; // Histórico de documentos de início de página para navegação "voltar"
        let currentPage = 0; // Índice da página atual (0-based)

        let editingClientId = null; // Armazena o ID do cliente sendo editado no formulário
        let userId = null; // Armazena o ID do usuário autenticado
        let isAuthReady = false; // Flag para indicar se a autenticação está pronta

        // Variável para controlar o elemento de edição rápida atualmente ativo
        let activeQuickEditElement = null;

        // Mapeamento dos elementos do DOM
        const rawDataInput = document.getElementById('rawDataInput');
        const fillFormButton = document.getElementById('fillFormButton');
        const clientForm = document.getElementById('clientForm');
        const addClientButton = document.getElementById('addClientButton');
        const updateClientButton = document.getElementById('updateClientButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const clientTableBody = document.getElementById('clientTableBody');
        const messageBox = document.getElementById('messageBox'); // Elemento para exibir mensagens ao usuário
        const exportExcelButton = document.getElementById('exportExcelButton');
        const deleteClientButton = document.getElementById('deleteClientButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const updateLoadingSpinner = document.getElementById('updateLoadingSpinner');
        const deleteLoadingSpinner = document.getElementById('deleteLoadingSpinner');

        const clientDetailsContainer = document.getElementById('clientDetailsContainer');

        // Campos do formulário
        const companyNameField = document.getElementById('companyName');
        const contactNameField = document.getElementById('contactName');
        const phoneField = document.getElementById('phone');
        const emailField = document.getElementById('email');
        const websiteField = document.getElementById('website');
        const addressField = document.getElementById('address');
        const firstContactDateField = document.getElementById('firstContactDate');
        const freeConsultationDateField = document.getElementById('freeConsultationDate');
        const freeConsultationTimeField = document.getElementById('freeConsultationTime');
        const secondMeetingDateField = document.getElementById('secondMeetingDate');
        const secondMeetingTimeField = document.getElementById('secondMeetingTime');
        const contractStartDateField = document.getElementById('contractStartDate');
        const statusField = document.getElementById('status');
        const lastContactDateField = document.getElementById('lastContactDate');
        const notesField = document.getElementById('notes');

        // Campos de filtro e pesquisa
        const filterStatusField = document.getElementById('filterStatus');
        const filterDateFromField = document.getElementById('filterDateFrom');
        const filterDateToField = document.getElementById('filterDateTo');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const generalSearchInput = document.getElementById('generalSearchInput');
        const searchButton = document.getElementById('searchButton');
        const prevPageButton = document.getElementById('prevPageButton');
        const nextPageButton = document.getElementById('nextPageButton');

        // Elementos do modal de confirmação
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        /**
         * Exibe uma mensagem para o usuário.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - O tipo de mensagem ('success', 'error', 'info').
         * @param {HTMLElement} [targetBox=messageBox] - O elemento HTML onde a mensagem será exibida.
         */
        function showMessage(message, type, targetBox = messageBox) {
            targetBox.textContent = message;
            targetBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            if (type === 'success') {
                targetBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                targetBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                targetBox.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            targetBox.classList.remove('hidden');
            // Oculta a mensagem após 3 segundos
            setTimeout(() => {
                targetBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Exibe um modal de confirmação personalizado.
         * @param {string} message - A mensagem a ser exibida no modal.
         * @returns {Promise<boolean>} Uma Promise que resolve para true se confirmado, false caso contrário.
         */
        function showConfirmationModal(message) {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                confirmationModal.classList.remove('hidden');

                const handleConfirm = () => {
                    confirmationModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    confirmationModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                modalConfirmBtn.addEventListener('click', handleConfirm);
                modalCancelBtn.addEventListener('click', handleCancel);
            });
        }

        /**
         * Limpa todos os campos do formulário e redefine o estado de edição.
         */
        function clearForm() {
            companyNameField.value = '';
            contactNameField.value = '';
            phoneField.value = '';
            emailField.value = '';
            websiteField.value = '';
            addressField.value = '';
            firstContactDateField.value = '';
            freeConsultationDateField.value = '';
            freeConsultationTimeField.value = '';
            secondMeetingDateField.value = '';
            secondMeetingTimeField.value = '';
            contractStartDateField.value = '';
            statusField.value = 'Novo Cliente';
            lastContactDateField.value = '';
            notesField.value = '';
            editingClientId = null;
            
            // Desabilita botões de atualização e exclusão
            updateClientButton.disabled = true;
            deleteClientButton.disabled = true;
            clientDetailsContainer.classList.remove('edit-mode-border');
        }

        /**
         * Preenche o formulário com os dados de um cliente.
         * @param {Object} client - O objeto cliente contendo os dados a serem preenchidos.
         */
        function fillForm(client) {
            companyNameField.value = client.companyName || '';
            contactNameField.value = client.contactName || '';
            phoneField.value = client.phone || '';
            emailField.value = client.email || '';
            websiteField.value = client.website || '';
            addressField.value = client.address || '';

            if (client.firstContactDate && client.firstContactDate.toDate) {
                firstContactDateField.value = client.firstContactDate.toDate().toISOString().split('T')[0];
            } else {
                firstContactDateField.value = '';
            }
            if (client.freeConsultationDate && client.freeConsultationDate.toDate) {
                freeConsultationDateField.value = client.freeConsultationDate.toDate().toISOString().split('T')[0];
            } else {
                freeConsultationDateField.value = '';
            }
            freeConsultationTimeField.value = client.freeConsultationTime || '';
            if (client.secondMeetingDate && client.secondMeetingDate.toDate) {
                secondMeetingDateField.value = client.secondMeetingDate.toDate().toISOString().split('T')[0];
            } else {
                secondMeetingDateField.value = '';
            }
            secondMeetingTimeField.value = client.secondMeetingTime || '';

            if (client.contractStartDate && client.contractStartDate.toDate) {
                contractStartDateField.value = client.contractStartDate.toDate().toISOString().split('T')[0];
            } else {
                contractStartDateField.value = '';
            }

            statusField.value = client.status || 'Novo Cliente';
            if (client.lastContactDate && client.lastContactDate.toDate) {
                lastContactDateField.value = client.lastContactDate.toDate().toISOString().split('T')[0];
            } else {
                lastContactDateField.value = '';
            }
            notesField.value = client.notes || '';
            editingClientId = client.id; // Corrigido: Agora define o ID do cliente para edição
            
            updateClientButton.disabled = false;
            deleteClientButton.disabled = false;
            clientDetailsContainer.classList.add('edit-mode-border');
        }

        /**
         * Analisa o texto bruto do Google Meu Negócio e extrai informações do cliente.
         * @param {string} rawText - O texto bruto a ser analisado.
         * @returns {Object} Um objeto com os dados do cliente extraídos.
         */
        function parseRawData(rawText) {
            const data = {};
            const companyNameMatch = rawText.match(/(?:Nome da Empresa:|Empresa:)\s*([^\n]+)/i) || rawText.match(/^([^\n]+)/);
            if (companyNameMatch) {
                data.companyName = companyNameMatch[1].trim();
            }
            const contactNameMatch = rawText.match(/(?:Nome de Contato:|Contato:)\s*([^\n]+)/i);
            if (contactNameMatch) {
                data.contactName = contactNameMatch[1].trim();
            }
            const phoneMatch = rawText.match(/(?:\(?\d{2}\)?\s*\d{4,5}[-\s]?\d{4}|\+\d{2}\s*\d{2}\s*\d{4,5}[-\s]?\d{4})/);
            if (phoneMatch) {
                data.phone = phoneMatch[0].trim();
            }
            const emailMatch = rawText.match(/[\w\.-]+@[\w\.-]+\.\w+/);
            if (emailMatch) {
                data.email = emailMatch[0].trim();
            }
            const websiteMatch = rawText.match(/(?:https?:\/\/)?(?:www\.)?([a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+(?:\/[^\s]*)?)/);
            if (websiteMatch) {
                data.website = websiteMatch[0].trim();
                if (!data.website.startsWith('http://') && !data.website.startsWith('https://')) {
                    data.website = 'http://' + data.website;
                }
            }
            const addressMatch = rawText.match(/(?:Endereço:|Rua|Av\.|Avenida|Travessa|Praça)\s*([^\n]+(?:,\s*\d+)?(?:,\s*[^\n]+)?(?:-\s*[^\n]+)?(?:,\s*CEP\s*\d{5}-?\d{3})?)/i);
            if (addressMatch) {
                data.address = addressMatch[0].trim();
            } else {
                const genericAddressMatch = rawText.match(/(\d{1,5}\s+[A-Za-z\s]+\s+(?:Rua|Av\.|Avenida|Travessa|Praça|Bairro|Centro|Cidade|Estado)[^\n]*)/i);
                if (genericAddressMatch) {
                    data.address = genericAddressMatch[0].trim();
                }
            }
            const firstContactDateMatch = rawText.match(/(?:Data do Primeiro Contato:|Primeiro Contato:)\s*(\d{4}-\d{2}-\d{2})/i);
            if (firstContactDateMatch) {
                data.firstContactDate = firstContactDateMatch[1].trim();
            }
            const freeConsultationDateMatch = rawText.match(/(?:Data da Consultoria Gratuita:|Consultoria Gratuita Data:)\s*(\d{4}-\d{2}-\d{2})/i);
            if (freeConsultationDateMatch) {
                data.freeConsultationDate = freeConsultationDateMatch[1].trim();
            }
            const freeConsultationTimeMatch = rawText.match(/(?:Horário da Consultoria Gratuita:|Consultoria Gratuita Horário:)\s*(\d{2}:\d{2})/i);
            if (freeConsultationTimeMatch) {
                data.freeConsultationTime = freeConsultationTimeMatch[1].trim();
            }
            const secondMeetingDateMatch = rawText.match(/(?:Data da Segunda Reunião:|Segunda Reunião Data:)\s*(\d{4}-\d{2}-\d{2})/i);
            if (secondMeetingDateMatch) {
                data.secondMeetingDate = secondMeetingDateMatch[1].trim();
            }
            const secondMeetingTimeMatch = rawText.match(/(?:Horário da Segunda Reunião:|Segunda Reunião Horário:)\s*(\d{2}:\d{2})/i);
            if (secondMeetingTimeMatch) {
                data.secondMeetingTime = secondMeetingTimeMatch[1].trim();
            }

            const contractStartDateMatch = rawText.match(/(?:Data de Início do Contrato:|Início Contrato:)\s*(\d{4}-\d{2}-\d{2})/i);
            if (contractStartDateMatch) {
                data.contractStartDate = contractStartDateMatch[1].trim();
            }
            const statusMatch = rawText.match(/(?:Status:)\s*([^\n]+)/i);
            if (statusMatch) {
                data.status = statusMatch[1].trim();
            }
            const lastContactDateMatch = rawText.match(/(?:Último Contato:)\s*(\d{4}-\d{2}-\d{2})/i);
            if (lastContactDateMatch) {
                data.lastContactDate = lastContactDateMatch[1].trim();
            }
            const notesMatch = rawText.match(/(?:Observações:|Notas:)\s*([^\n]+)/i);
            if (notesMatch) {
                data.notes = notesMatch[1].trim();
            }
            return data;
        }

        /**
         * Calcula o tempo de contrato em anos e meses.
         * @param {string} startDateString - A data de início do contrato no formato ISO (YYYY-MM-DD).
         * @returns {string} O tempo de contrato formatado (ex: "2 anos e 3 meses").
         */
        function calculateContractDuration(startDateString) {
            if (!startDateString) {
                return 'N/A';
            }
            const startDate = new Date(startDateString);
            const today = new Date();

            let years = today.getFullYear() - startDate.getFullYear();
            let months = today.getMonth() - startDate.getMonth();

            if (months < 0 || (months === 0 && today.getDate() < startDate.getDate())) {
                years--;
                months += 12;
            }

            if (today.getDate() < startDate.getDate()) {
                months--;
            }
            
            if (months < 0) {
                months = 0;
            }

            const parts = [];
            if (years > 0) {
                parts.push(`${years} ano${years > 1 ? 's' : ''}`);
            }
            if (months > 0) {
                parts.push(`${months} mes${months > 1 ? 'es' : ''}`);
            }

            if (parts.length === 0) {
                return 'Menos de 1 mês';
            }
            return parts.join(' e ');
        }

        /**
         * Desativa o modo de edição rápida para um elemento específico.
         * @param {HTMLElement} container - O elemento .quick-edit-container a ser desativado.
         */
        function deactivateQuickEdit(container) {
            if (!container) return; // Garante que há um container para desativar

            const displaySpan = container.querySelector('.quick-edit-display');
            const inputField = container.querySelector('.quick-edit-input:not(select)');
            const selectField = container.querySelector('.quick-edit-input.quick-edit-status');
            const saveButton = container.querySelector('.quick-edit-btn');

            if (displaySpan) displaySpan.classList.remove('hidden');
            if (inputField) inputField.classList.add('hidden');
            if (selectField) selectField.classList.add('hidden');
            if (saveButton) saveButton.classList.add('hidden');

            activeQuickEditElement = null; // Reseta o elemento ativo
        }

        /**
         * Renderiza a tabela de clientes com os dados fornecidos.
         * @param {Array<Object>} clientsToRender - Array de objetos cliente a serem exibidos.
         */
        function renderClientTable(clientsToRender) {
            clientTableBody.innerHTML = ''; // Limpa o corpo da tabela
            if (clientsToRender.length === 0) {
                clientTableBody.innerHTML = `<tr><td colspan="16" class="px-6 py-4 text-center text-gray-500">Nenhum cliente encontrado.</td></tr>`;
                return;
            }

            clientsToRender.forEach(client => {
                const row = clientTableBody.insertRow();
                row.dataset.id = client.id; // Armazena o ID do documento no elemento da linha
                row.classList.add('hover:bg-gray-50', 'transition-colors', 'duration-150', 'ease-in-out');

                // Adiciona classes de destaque baseadas no status
                if (client.status === 'Em Andamento') {
                    row.classList.add('in-progress-row');
                } else if (client.status === 'Reunião Agendada' || client.status === 'Consultoria Gratuita Agendada' || client.status === 'Segunda Reunião Agendada') {
                    row.classList.add('meeting-scheduled-row');
                } else if (client.status === 'Contrato Assinado') {
                    row.classList.add('contract-signed-row');
                } else {
                    row.classList.add('bg-white'); // Default background for other rows
                }

                // Cria a primeira célula (Nome da Empresa) separadamente para controle de estilo
                const firstCell = row.insertCell();
                firstCell.classList.add('px-3', 'md:px-6', 'py-2', 'md:py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-800', 'font-medium', 'text-gray-900');
                firstCell.innerHTML = client.companyName;

                // Define a cor de fundo da primeira célula para corresponder à cor da linha
                if (row.classList.contains('in-progress-row')) {
                    firstCell.style.backgroundColor = '#fffde7'; // Amarelo claro
                } else if (row.classList.contains('meeting-scheduled-row')) {
                    firstCell.style.backgroundColor = '#fffbeb'; // Ambar
                } else if (row.classList.contains('contract-signed-row')) {
                    firstCell.style.backgroundColor = '#dcfce7'; // Verde claro
                } else {
                    firstCell.style.backgroundColor = '#ffffff'; // Branco padrão
                }

                // Cria as demais células da tabela
                const remainingCellsContent = [
                    client.contactName,
                    client.phone,
                    client.email,
                    client.website ? `<a href="${client.website}" target="_blank" class="text-blue-600 hover:underline">${client.website}</a>` : '',
                    client.address,
                    client.firstContactDate ? new Date(client.firstContactDate.toDate()).toLocaleDateString('pt-BR') : '',
                    client.freeConsultationDate ? new Date(client.freeConsultationDate.toDate()).toLocaleDateString('pt-BR') : '',
                    client.freeConsultationTime || '',
                    client.secondMeetingDate ? new Date(client.secondMeetingDate.toDate()).toLocaleDateString('pt-BR') : '',
                    client.secondMeetingTime || '',
                    client.contractStartDate ? new Date(client.contractStartDate.toDate()).toLocaleDateString('pt-BR') : '',
                    calculateContractDuration(client.contractStartDate ? client.contractStartDate.toDate().toISOString().split('T')[0] : null),
                    client.status,
                    client.lastContactDate ? new Date(client.lastContactDate.toDate()).toLocaleDateString('pt-BR') : '',
                    client.notes
                ];

                remainingCellsContent.forEach((cellContent, index) => {
                    const cell = row.insertCell();
                    cell.classList.add('px-3', 'md:px-6', 'py-2', 'md:py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-800');

                    // Ajusta o índice para mapear corretamente os campos após a primeira coluna
                    let actualFieldName = '';
                    let inputType = 'text';
                    switch(index + 1) { // +1 porque a primeira coluna já foi tratada
                        case 6: actualFieldName = 'firstContactDate'; inputType = 'date'; break;
                        case 7: actualFieldName = 'freeConsultationDate'; inputType = 'date'; break;
                        case 8: actualFieldName = 'freeConsultationTime'; inputType = 'time'; break;
                        case 9: actualFieldName = 'secondMeetingDate'; inputType = 'date'; break;
                        case 10: actualFieldName = 'secondMeetingTime'; inputType = 'time'; break;
                        case 13: actualFieldName = 'status'; break;
                        case 14: actualFieldName = 'lastContactDate'; inputType = 'date'; break;
                        case 15: actualFieldName = 'notes'; break;
                        default: break;
                    }

                    if (actualFieldName) {
                        let displayValue = cellContent;
                        if (inputType === 'date' && client[actualFieldName] && client[actualFieldName].toDate) {
                            displayValue = client[actualFieldName].toDate().toLocaleDateString('pt-BR');
                        } else if (inputType === 'time') {
                            displayValue = client[actualFieldName] || '';
                        } else if (actualFieldName === 'notes') {
                            displayValue = client[actualFieldName] || 'Clique para editar';
                        }
                        
                        cell.innerHTML = `
                            <div class="quick-edit-container">
                                <span class="quick-edit-display">${displayValue || 'Clique para editar'}</span>
                                ${actualFieldName === 'status' ? `
                                    <select class="quick-edit-input quick-edit-status hidden">
                                        <option value="Novo Cliente">Novo Cliente</option>
                                        <option value="Em Andamento">Em Andamento</option>
                                        <option value="Aguardando Contato">Aguardando Contato</option>
                                        <option value="Perdido">Perdido</option>
                                        <option value="Reunião Agendada">Reunião Agendada</option>
                                        <option value="Consultoria Gratuita Agendada">Consultoria Gratuita Agendada</option>
                                        <option value="Segunda Reunião Agendada">Segunda Reunião Agendada</option>
                                        <option value="Contrato Assinado">Contrato Assinado</option>
                                    </select>
                                ` : `<input type="${inputType}" class="quick-edit-input hidden" value="${client[actualFieldName] ? (inputType === 'date' ? client[actualFieldName].toDate().toISOString().split('T')[0] : client[actualFieldName]) : ''}">`}
                                <button class="quick-edit-btn hidden" data-field="${actualFieldName}" data-id="${client.id}">Salvar</button>
                            </div>
                        `;
                        const quickEditContainer = cell.querySelector('.quick-edit-container');
                        const displaySpan = cell.querySelector('.quick-edit-display');
                        const inputField = cell.querySelector('.quick-edit-input:not(select)');
                        const selectField = cell.querySelector('.quick-edit-input.quick-edit-status');
                        const saveButton = cell.querySelector('.quick-edit-btn');

                        displaySpan.addEventListener('click', (event) => {
                            // Se já houver um elemento de edição ativa diferente, desative-o
                            if (activeQuickEditElement && activeQuickEditElement !== quickEditContainer) {
                                deactivateQuickEdit(activeQuickEditElement);
                            }

                            // Ativa o elemento atual
                            displaySpan.classList.add('hidden');
                            if (selectField) {
                                selectField.value = client[actualFieldName] || '';
                                selectField.classList.remove('hidden');
                                selectField.focus();
                            } else if (inputField) {
                                inputField.value = client[actualFieldName] ? (inputType === 'date' ? client[actualFieldName].toDate().toISOString().split('T')[0] : client[actualFieldName]) : '';
                                inputField.classList.remove('hidden');
                                inputField.focus();
                            }
                            saveButton.classList.remove('hidden');
                            activeQuickEditElement = quickEditContainer; // Define o elemento atual como ativo
                            event.stopPropagation(); // Impede que o clique se propague para o document.body imediatamente
                        });

                        saveButton.addEventListener('click', async (event) => {
                            let newValue;
                            if (selectField && !selectField.classList.contains('hidden')) {
                                newValue = selectField.value;
                            } else if (inputField && !inputField.classList.contains('hidden')) {
                                newValue = inputField.value;
                            } else {
                                return; // Não há campo de edição visível para salvar
                            }

                            const updateData = {};
                            if (inputType === 'date') {
                                updateData[actualFieldName] = newValue ? firebase.firestore.Timestamp.fromDate(new Date(newValue)) : null;
                            } else {
                                updateData[actualFieldName] = newValue;
                            }
                            
                            try {
                                // O appId será o projectId do seu Firebase
                                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients').doc(client.id).update(updateData);
                                showMessage('Campo atualizado com sucesso!', 'success');
                                deactivateQuickEdit(quickEditContainer); // Desativa após salvar
                                fetchClients(); 
                            } catch (error) {
                                console.error("Erro ao atualizar campo rápido:", error);
                                showMessage('Erro ao atualizar campo.', 'error');
                            }
                            event.stopPropagation(); // Impede que o clique se propague para o document.body
                        });
                    } else {
                        cell.innerHTML = cellContent;
                    }
                });

                row.addEventListener('click', () => {
                    document.querySelectorAll('#clientTableBody tr').forEach(r => r.classList.remove('bg-blue-100'));
                    row.classList.add('bg-blue-100');
                    fillForm(client);
                });
            });
        }

        /**
         * Busca clientes do Firestore com base nos filtros e termos de pesquisa.
         * Gerencia a paginação.
         * @param {string} [direction='current'] - 'next', 'prev' ou 'current' para controle de paginação.
         */
        async function fetchClients(direction = 'current') {
            if (!isAuthReady || !userId) {
                clientTableBody.innerHTML = `<tr><td colspan="16" class="px-6 py-4 text-center text-gray-500">Aguardando autenticação...</td></tr>`;
                return;
            }

            clientTableBody.innerHTML = `<tr><td colspan="16" class="px-6 py-4 text-center text-gray-500">Carregando clientes...</td></tr>`;
            
            // O appId será o projectId do seu Firebase
            let queryRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients');

            const selectedStatuses = Array.from(filterStatusField.selectedOptions).map(option => option.value).filter(value => value !== '');
            if (selectedStatuses.length > 0) {
                queryRef = queryRef.where('status', 'in', selectedStatuses);
            }

            const filterDateFrom = filterDateFromField.value;
            const filterDateTo = filterDateToField.value;

            if (filterDateFrom) {
                queryRef = queryRef.where('lastContactDate', '>=', firebase.firestore.Timestamp.fromDate(new Date(filterDateFrom)));
            }
            if (filterDateTo) {
                const dateTo = new Date(filterDateTo);
                dateTo.setDate(dateTo.getDate() + 1);
                queryRef = queryRef.where('lastContactDate', '<', firebase.firestore.Timestamp.fromDate(dateTo));
            }

            queryRef = queryRef.orderBy('companyName');

            if (direction === 'next' && lastVisibleDoc) {
                paginationHistory.push(firstVisibleDoc);
                queryRef = queryRef.startAfter(lastVisibleDoc);
                currentPage++;
            } else if (direction === 'prev' && paginationHistory.length > 0) {
                queryRef = queryRef.startAt(paginationHistory.pop());
                currentPage--;
            } else if (direction === 'current') {
                paginationHistory = [];
                currentPage = 0;
            }

            queryRef = queryRef.limit(CLIENTES_POR_PAGINA);

            try {
                const snapshot = await queryRef.get();
                clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                let filteredClients = clients;
                const searchTerm = generalSearchInput.value.toLowerCase();

                if (searchTerm) {
                    filteredClients = clients.filter(client =>
                        (client.companyName && client.companyName.toLowerCase().includes(searchTerm)) ||
                        (client.contactName && client.contactName.toLowerCase().includes(searchTerm)) ||
                        (client.phone && client.phone.toLowerCase().includes(searchTerm)) ||
                        (client.email && client.email.toLowerCase().includes(searchTerm)) ||
                        (client.address && client.address.toLowerCase().includes(searchTerm)) ||
                        (client.notes && client.notes.toLowerCase().includes(searchTerm)) ||
                        (client.status && client.status.toLowerCase().includes(searchTerm)) ||
                        (client.firstContactDate && new Date(client.firstContactDate.toDate()).toLocaleDateString('pt-BR').toLowerCase().includes(searchTerm)) ||
                        (client.freeConsultationDate && new Date(client.freeConsultationDate.toDate()).toLocaleDateString('pt-BR').toLowerCase().includes(searchTerm)) ||
                        (client.freeConsultationTime && client.freeConsultationTime.toLowerCase().includes(searchTerm)) ||
                        (client.secondMeetingDate && new Date(client.secondMeetingDate.toDate()).toLocaleDateString('pt-BR').toLowerCase().includes(searchTerm)) ||
                        (client.secondMeetingTime && client.secondMeetingTime.toLowerCase().includes(searchTerm))
                    );
                }

                renderClientTable(filteredClients);

                if (snapshot.docs.length > 0) {
                    firstVisibleDoc = snapshot.docs[0];
                    lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
                } else {
                    firstVisibleDoc = null;
                    lastVisibleDoc = null;
                }

                prevPageButton.disabled = currentPage === 0;
                const nextQuerySnapshot = await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients')
                                                .orderBy('companyName')
                                                .startAfter(lastVisibleDoc)
                                                .limit(1)
                                                .get();
                nextPageButton.disabled = nextQuerySnapshot.empty;

            } catch (error) {
                console.error("Erro ao buscar clientes:", error);
                showMessage('Erro ao carregar clientes. Verifique as permissões do Firestore.', 'error');
                clientTableBody.innerHTML = `<tr><td colspan="16" class="px-6 py-4 text-center text-red-500">Erro ao carregar clientes. Tente novamente.</td></tr>`;
            }
        });

        /**
         * Adiciona um novo cliente ao Firestore.
         */
        addClientButton.addEventListener('click', async () => {
            if (!isAuthReady || !userId) {
                showMessage('Autenticação não pronta. Tente novamente.', 'error');
                return;
            }
            loadingSpinner.classList.remove('hidden');
            addClientButton.disabled = true;

            const clientData = {
                companyName: companyNameField.value,
                contactName: contactNameField.value,
                phone: phoneField.value,
                email: emailField.value,
                website: websiteField.value,
                address: addressField.value,
                firstContactDate: firstContactDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(firstContactDateField.value)) : null,
                freeConsultationDate: freeConsultationDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(freeConsultationDateField.value)) : null,
                freeConsultationTime: freeConsultationTimeField.value,
                secondMeetingDate: secondMeetingDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(secondMeetingDateField.value)) : null,
                secondMeetingTime: secondMeetingTimeField.value,
                contractStartDate: contractStartDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(contractStartDateField.value)) : null,
                status: statusField.value,
                lastContactDate: lastContactDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(lastContactDateField.value)) : null,
                notes: notesField.value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // O appId será o projectId do seu Firebase
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients').add(clientData);
                showMessage('Cliente adicionado com sucesso!', 'success');
                clearForm();
                fetchClients();
            }
            catch (error) {
                console.error("Erro ao adicionar cliente:", error);
                showMessage('Erro ao adicionar cliente.', 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
                addClientButton.disabled = false;
            }
        });

        /**
         * Atualiza um cliente existente no Firestore.
         */
        updateClientButton.addEventListener('click', async () => {
            if (!editingClientId) {
                showMessage('Nenhum cliente selecionado para atualização.', 'info');
                return;
            }
            if (!isAuthReady || !userId) {
                showMessage('Autenticação não pronta. Tente novamente.', 'error');
                return;
            }

            updateLoadingSpinner.classList.remove('hidden');
            updateClientButton.disabled = true;

            const clientData = {
                companyName: companyNameField.value,
                contactName: contactNameField.value,
                phone: phoneField.value,
                email: emailField.value,
                website: websiteField.value,
                address: addressField.value,
                firstContactDate: firstContactDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(firstContactDateField.value)) : null,
                freeConsultationDate: freeConsultationDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(freeConsultationDateField.value)) : null,
                freeConsultationTime: freeConsultationTimeField.value,
                secondMeetingDate: secondMeetingDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(secondMeetingDateField.value)) : null,
                secondMeetingTime: secondMeetingTimeField.value,
                contractStartDate: contractStartDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(contractStartDateField.value)) : null,
                status: statusField.value,
                lastContactDate: lastContactDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(lastContactDateField.value)) : null,
                notes: notesField.value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // O appId será o projectId do seu Firebase
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients').doc(editingClientId).update(clientData);
                showMessage('Campo atualizado com sucesso!', 'success');
                clearForm();
                fetchClients();
            } catch (error) {
                console.error("Erro ao atualizar cliente:", error);
                showMessage('Erro ao atualizar campo.', 'error');
            } finally {
                updateLoadingSpinner.classList.add('hidden');
                updateClientButton.disabled = false;
            }
        });

        /**
         * Exclui um cliente do Firestore.
         */
        deleteClientButton.addEventListener('click', async () => {
            if (!editingClientId) {
                showMessage('Nenhum cliente selecionado para exclusão.', 'info');
                return;
            }
            if (!isAuthReady || !userId) {
                showMessage('Autenticação não pronta. Tente novamente.', 'error');
                return;
            }

            const confirmed = await showConfirmationModal('Tem certeza que deseja excluir este cliente?');
            if (!confirmed) {
                return;
            }

            deleteLoadingSpinner.classList.remove('hidden');
            deleteClientButton.disabled = true;

            try {
                // O appId será o projectId do seu Firebase
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients').doc(editingClientId).delete();
                showMessage('Cliente excluído com sucesso!', 'success');
                clearForm();
                fetchClients();
            } catch (error) {
                console.error("Erro ao excluir cliente:", error);
                showMessage('Erro ao excluir cliente.', 'error');
            } finally {
                deleteLoadingSpinner.classList.add('hidden');
                deleteClientButton.disabled = false;
            }
        });

        /**
         * Event listener para o botão "Preencher Formulário".
         * Analisa o texto bruto e preenche os campos do formulário.
         */
        fillFormButton.addEventListener('click', () => {
            const rawText = rawDataInput.value;
            const clientData = parseRawData(rawText);
            
            companyNameField.value = clientData.companyName || '';
            contactNameField.value = clientData.contactName || '';
            phoneField.value = clientData.phone || '';
            emailField.value = clientData.email || '';
            websiteField.value = clientData.website || '';
            addressField.value = clientData.address || '';
            firstContactDateField.value = clientData.firstContactDate || '';
            freeConsultationDateField.value = clientData.freeConsultationDate || '';
            freeConsultationTimeField.value = clientData.freeConsultationTime || '';
            secondMeetingDateField.value = clientData.secondMeetingDate || '';
            secondMeetingTimeField.value = clientData.secondMeetingTime || '';
            contractStartDateField.value = clientData.contractStartDate || '';
            statusField.value = clientData.status || 'Novo Cliente';
            lastContactDateField.value = clientData.lastContactDate || '';
            notesField.value = clientData.notes || '';

            showMessage('Formulário preenchido com dados brutos.', 'info');
        });

        /**
         * Event listener para o botão "Cancelar Edição".
         * Limpa o formulário e redefine o estado de edição.
         */
        cancelEditButton.addEventListener('click', clearForm);

        /**
         * Event listener para o botão "Exportar Excel".
         * Exporta os dados da tabela para um arquivo Excel.
         */
        exportExcelButton.addEventListener('click', () => {
            const ws = XLSX.utils.json_to_sheet(clients.map(client => {
                const formattedClient = { ...client };
                if (formattedClient.firstContactDate && formattedClient.firstContactDate.toDate) {
                    formattedClient.firstContactDate = formattedClient.firstContactDate.toDate().toLocaleDateString('pt-BR');
                }
                if (formattedClient.freeConsultationDate && formattedClient.freeConsultationDate.toDate) {
                    formattedClient.freeConsultationDate = formattedClient.freeConsultationDate.toDate().toLocaleDateString('pt-BR');
                }
                if (formattedClient.secondMeetingDate && formattedClient.secondMeetingDate.toDate) {
                    formattedClient.secondMeetingDate = formattedClient.secondMeetingDate.toDate().toLocaleDateString('pt-BR');
                }
                if (formattedClient.contractStartDate && formattedClient.contractStartDate.toDate) {
                    formattedClient.contractStartDate = formattedClient.contractStartDate.toDate().toLocaleDateString('pt-BR');
                }
                if (formattedClient.lastContactDate && formattedClient.lastContactDate.toDate) {
                    formattedClient.lastContactDate = formattedClient.lastContactDate.toDate().toLocaleDateString('pt-BR');
                }
                formattedClient['Tempo de Contrato'] = calculateContractDuration(client.contractStartDate ? client.contractStartDate.toDate().toISOString().split('T')[0] : null);
                return formattedClient;
            }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Clientes CRM");
            XLSX.writeFile(wb, "clientes_crm.xlsx");
            showMessage('Dados exportados para Excel!', 'success');
        });

        /**
         * Event listeners para os botões de paginação.
         */
        prevPageButton.addEventListener('click', () => fetchClients('prev'));
        nextPageButton.addEventListener('click', () => fetchClients('next'));

        /**
         * Event listeners para os botões de filtro e pesquisa.
         */
        applyFiltersButton.addEventListener('click', () => {
            currentPage = 0;
            paginationHistory = [];
            fetchClients('current');
        });

        clearFiltersButton.addEventListener('click', () => {
            filterStatusField.querySelectorAll('option').forEach(option => option.selected = false);
            filterDateFromField.value = '';
            filterDateToField.value = '';
            generalSearchInput.value = '';
            currentPage = 0;
            paginationHistory = [];
            fetchClients('current');
        });

        searchButton.addEventListener('click', () => {
            currentPage = 0;
            paginationHistory = [];
            fetchClients('current');
        });

        // Inicializa a autenticação e carrega os clientes
        window.onload = function() { // Alterado para função tradicional
            // Verifica se o Firebase foi inicializado com sucesso antes de tentar a autenticação
            if (typeof firebaseApp === 'undefined') {
                console.error("Firebase App não inicializado. Não é possível prosseguir com a autenticação.");
                return;
            }

            auth.onAuthStateChanged(function(user) { // Alterado para função tradicional
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    addClientButton.disabled = false; // Habilita o botão de adicionar após a autenticação
                    fetchClients();
                } else {
                    try {
                        // Tenta autenticar anonimamente
                        auth.signInAnonymously(); // Removido await para evitar possíveis problemas de ambiente
                    } catch (error) {
                        console.error("Erro ao autenticar no Firebase:", error);
                        // Mensagem de erro mais específica para o caso de autenticação anônima restrita
                        if (error.code === 'auth/admin-restricted-operation') {
                            showMessage('Erro de autenticação: A autenticação anônima pode não estar ativada no seu projeto Firebase. Por favor, verifique as configurações.', 'error');
                        } else {
                            showMessage('Erro ao autenticar. Verifique sua conexão ou permissões.', 'error');
                        }
                        addClientButton.disabled = true; // Mantém desabilitado em caso de erro de autenticação
                    }
                }
            });
        };

        // Adiciona um listener de clique ao corpo do documento para fechar edições rápidas
        document.body.addEventListener('click', (event) => {
            // Se houver um elemento de edição rápida ativo e o clique não foi dentro dele
            if (activeQuickEditElement && !activeQuickEditElement.contains(event.target)) {
                deactivateQuickEdit(activeQuickEditElement);
            }
        });
    </script>
</body>
</html>
