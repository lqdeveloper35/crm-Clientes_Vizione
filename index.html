<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM de Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDK - Versão 9.6.0 compat -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script> <!-- Adicionado Firebase Auth -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* Texto cinza escuro padrão */
            margin: 0; /* Reset margin for full width */
        }
        #crmApp {
            max-width: none !important; /* Override max-w */
            width: 100% !important; /* Ensure full width */
            margin: 0 auto; /* Center if needed */
            padding: 1rem; /* Add some padding around the app */
        }
        @media (min-width: 640px) { /* sm */
            #crmApp {
                padding: 2rem;
            }
        }
        @media (min-width: 768px) { /* md */
            #crmApp {
                padding: 3rem;
            }
        }
        /* Estilo para a coluna fixa */
        #clientTable th:first-child {
            position: sticky;
            left: 0;
            background-color: #f3f4f6; /* Define explicitamente o fundo para o thead fixo */
            z-index: 2; /* Increased z-index to ensure it's always on top */
            border-right: 1px solid #e5e7eb; /* Opcional: Adiciona uma linha separadora */
        }
        #clientTable td:first-child {
            position: sticky;
            left: 0;
            /* background-color será definido via JS para acompanhar a cor da linha */
            z-index: 1; /* Garante que fique acima de outras células durante a rolagem, mas abaixo do thead sticky */
            border-right: 1px solid #e5e7eb; /* Opcional: Adiciona uma linha separadora */
        }
        /* Ajusta o padding para alinhamento visual com a coluna fixa */
        #clientTable th:not(:first-child),
        #clientTable td:not(:first-child) {
            padding-left: 1rem; /* Ajusta conforme necessário */
        }
        /* Estilo para o spinner de carregamento */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para o modo de edição do formulário */
        .edit-mode-border {
            border: 2px solid #3b82f6; /* Borda azul para indicar modo de edição */
        }
        /* Estilos para campos de edição rápida na tabela */
        .quick-edit-container {
            display: flex;
            align-items: center;
            gap: 4px; /* Espaçamento entre o input e o botão */
            flex-wrap: nowrap; /* Impede que os itens quebrem para a próxima linha */
        }
        .quick-edit-input {
            flex-grow: 1; /* Permite que o input cresça para preencher o espaço */
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.75rem; /* text-sm */
            background-color: #f0f4f8; /* Um cinza claro para destacar */
        }
        /* Ajuste específico para o select de status na edição rápida */
        .quick-edit-status .quick-edit-input {
            min-width: 120px; /* Largura mínima para o select de status */
        }

        .quick-edit-btn {
            background-color: #10b981; /* Verde */
            color: white;
            padding: 4px 8px;
            border: none; /* Remove borda padrão */
            border-radius: 4px;
            font-size: 0.625rem; /* text-xs */
            cursor: pointer;
            flex-shrink: 0; /* Não encolhe o botão */
        }
        .quick-edit-btn:hover {
            background-color: #059669; /* Verde mais escuro */
        }
        /* Estilos para a barra de mensagens fixa */
        #messageBox {
            position: fixed !important; /* Força a posição fixa */
            bottom: 20px !important;
            right: 20px !important;
            z-index: 1000 !important;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #333 !important; /* Fundo escuro para destacar */
            color: white !important; /* Texto branco */
            padding: 10px 15px; /* Mais padding para ser visível */
            border-radius: 8px; /* Cantos arredondados */
        }

        /* Novas classes para destaque de linhas */
        .in-progress-row { /* Adicionado para status 'Em Andamento' */
            background-color: #fffde7; /* Amarelo claro */
        }
        .meeting-scheduled-row {
            background-color: #fffbeb; /* bg-amber-100 */
        }
        .contract-signed-row {
            background-color: #dcfce7; /* bg-green-100 */
        }
        /* Garante que o background padrão da linha seja branco, se não for sobrescrito */
        #clientTable tbody tr {
            /* background-color será definido no JS via classes Tailwind */
        }

        /* Estilos para o modal de confirmação */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 44px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .modal-button {
            /* REMOVIDO: padding: 8px 15px; */
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .modal-button.confirm {
            background-color: #ef4444; /* red-500 */
            color: white;
        }

        .modal-button.cancel {
            background-color: #6b7280; /* gray-500 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <div id="crmApp" class="bg-white rounded-xl shadow-lg">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 py-6">Cadastro de Clientes CRM</h1>

        <div class="mb-6 p-4 md:p-6 bg-white rounded-lg border border-gray-200">
            <label for="rawDataInput" class="block text-lg font-semibold text-gray-700 mb-3">
                Cole os dados do Google Meu Negócio aqui:
            </label>
            <textarea id="rawDataInput" rows="6" md:rows="8"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900 placeholder-gray-400"
                      placeholder="Ex: Nome da Empresa: Minha Loja Ltda.&#10;Telefone: (11) 98765-4321&#10;Site: www.minhaloja.com.br&#10;Endereço: Rua Exemplo, 123, Centro, Cidade - SP&#10;Email: contato@minhaloja.com.br&#10;Nome de Contato: João Silva&#10;Data do Primeiro Contato: 2024-07-01&#10;Data da Consultoria Gratuita: 2024-07-05&#10;Horário da Consultoria Gratuita: 10:00&#10;Data da Segunda Reunião: 2024-07-10&#10;Horário da Segunda Reunião: 14:30&#10;Data de Início do Contrato: 2023-01-15&#10;Status: Novo Cliente&#10;Último Contato: 2023-05-15&#10;&#10;Dica para ditado por voz: Fale o nome do campo seguido da informação. Ex: 'Nome da empresa: Minha Loja Ltda. Telefone: 11 98765-4321.'"></textarea>
            
            <div class="mt-3 flex flex-col md:flex-row justify-center items-center gap-3">
                <button id="fillFormButton"
                        class="w-full md:w-40 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                    Preencher Formulário
                </button>
                <button id="voiceInputButton"
                        class="w-full md:w-40 py-2 px-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                    Falar para Preencher
                </button>
                <button id="formatDataButton"
                        class="w-full md:w-40 py-2 px-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                    Formatar Dados
                </button>
            </div>
        </div>

        <div id="clientDetailsContainer" class="mb-6 p-4 md:p-6 bg-white rounded-xl border border-gray-200">
            <h2 class="text-xl md:text-2xl font-bold text-center text-gray-800 mb-4 md:mb-6">Detalhes do Cliente</h2>
            <form id="clientForm" class="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-6">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa:</label>
                    <input type="text" id="companyName"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="contactName" class="block text-sm font-medium text-gray-700 mb-1">Nome de Contato:</label>
                    <input type="text" id="contactName"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone:</label>
                    <input type="text" id="phone"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                    <input type="email" id="email"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="website" class="block text-sm font-medium text-gray-700 mb-1">Site:</label>
                    <input type="url" id="website"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="md:col-span-2">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Endereço:</label>
                    <input type="text" id="address"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="firstContactDate" class="block text-sm font-medium text-gray-700 mb-1">Data do Primeiro Contato:</label>
                    <input type="date" id="firstContactDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="freeConsultationDate" class="block text-sm font-medium text-gray-700 mb-1">Data da Consultoria Gratuita:</label>
                    <input type="date" id="freeConsultationDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="freeConsultationTime" class="block text-sm font-medium text-gray-700 mb-1">Horário da Consultoria Gratuita:</label>
                    <input type="time" id="freeConsultationTime"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="secondMeetingDate" class="block text-sm font-medium text-gray-700 mb-1">Data da Segunda Reunião:</label>
                    <input type="date" id="secondMeetingDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="secondMeetingTime" class="block text-sm font-medium text-gray-700 mb-1">Horário da Segunda Reunião:</label>
                    <input type="time" id="secondMeetingTime"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="contractStartDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Início do Contrato:</label>
                    <input type="date" id="contractStartDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                    <select id="status"
                            class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                        <option value="Novo Cliente">Novo Cliente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Perdido">Perdido</option>
                        <option value="Reunião Agendada">Reunião Agendada</option>
                        <option value="Consultoria Gratuita Agendada">Consultoria Gratuita Agendada</option>
                        <option value="Segunda Reunião Agendada">Segunda Reunião Agendada</option>
                        <option value="Contrato Assinado">Contrato Assinado</option>
                    </select>
                </div>
                <div>
                    <label for="lastContactDate" class="block text-sm font-medium text-gray-700 mb-1">Data Último Contato:</label>
                    <input type="date" id="lastContactDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="md:col-span-2">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Observações:</label>
                    <textarea id="notes" rows="3" md:rows="4"
                              class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900"></textarea>
                </div>
            </form>
            <div class="mt-4 md:mt-6 flex justify-center space-x-2 md:space-x-4">
                <button id="addClientButton"
                        class="w-full md:w-40 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center" disabled>
                    Cadastrar
                    <span id="loadingSpinner" class="loading-spinner hidden"></span>
                </button>
                <button id="updateClientButton"
                        class="w-full md:w-40 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center" disabled>
                    Atualizar
                    <span id="updateLoadingSpinner" class="loading-spinner hidden"></span>
                </button>
                <button id="cancelEditButton"
                        class="w-full md:w-40 py-2 px-3 bg-gray-400 hover:bg-gray-500 text-white font-bold rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                    Cancelar
                </button>
            </div>
        </div>

        <div class="p-4 md:p-6 bg-white rounded-lg border border-gray-200">
            <h2 class="text-xl md:text-2xl font-bold text-center text-gray-800 mb-4 md:mb-6">Clientes Cadastrados</h2>

            <div class="mb-4 p-3 md:p-4 bg-gray-50 rounded-lg border border-gray-200 flex flex-wrap items-end gap-2 md:gap-4">
                <div class="flex-1 min-w-[150px]">
                    <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Status:</label>
                    <select id="filterStatus" multiple size="4"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                        <option value="">Todos</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Novo Cliente">Novo Cliente</option>
                        <option value="Perdido">Perdido</option>
                        <option value="Reunião Agendada">Reunião Agendada</option>
                        <option value="Consultoria Gratuita Agendada">Consultoria Gratuita Agendada</option>
                        <option value="Segunda Reunião Agendada">Segunda Reunião Agendada</option>
                        <option value="Contrato Assinado">Contrato Assinado</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label for="filterDateFrom" class="block text-sm font-medium text-gray-700 mb-1">Último Contato De:</label>
                    <input type="date" id="filterDateFrom"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label for="filterDateTo" class="block text-sm font-medium text-gray-700 mb-1">Último Contato Até:</label>
                    <input type="date" id="filterDateTo"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="flex-none mt-2 md:mt-0">
                    <button id="applyFiltersButton"
                            class="w-full md:w-40 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                        Aplicar Filtros
                    </button>
                </div>
                <div class="flex-none mt-2 md:mt-0">
                    <button id="clearFiltersButton"
                            class="w-full md:w-40 py-2 px-3 bg-gray-400 hover:bg-gray-500 text-white font-bold rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                        Limpar Filtros
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label for="generalSearchInput" class="block text-lg font-semibold text-gray-700 mb-2">Pesquisa Geral:</label>
                <div class="flex gap-2 md:gap-4">
                    <input type="text" id="generalSearchInput" placeholder="Pesquisar por nome, telefone, email, etc."
                           class="flex-1 p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900 text-sm">
                    <button id="searchButton"
                            class="w-full md:w-40 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                        Pesquisar
                    </button>
                </div>
            </div>

            <div class="mb-3 md:mb-4 text-right flex justify-end space-x-2">
                <button id="exportExcelButton"
                        class="w-full md:w-40 py-2 px-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                    Exportar Excel
                </button>
                <button id="deleteClientButton"
                        class="w-full md:w-40 py-2 px-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-300 ease-in-out shadow-md text-sm flex items-center justify-center" disabled>
                    Excluir
                    <span id="deleteLoadingSpinner" class="loading-spinner hidden"></span>
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table id="clientTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider rounded-tl-lg">Nome da Empresa</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nome de Contato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider min-w-[120px]">Telefone</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Site</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Endereço</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data Primeiro Contato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data Consultoria Gratuita</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Horário Consultoria Gratuita</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data Segunda Reunião</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Horário Segunda Reunião</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Início Contrato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Tempo de Contrato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider min-w-[120px]">Status</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Último Contato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider rounded-tr-lg">Observações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200" id="clientTableBody">
                        </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-3 md:mt-4 space-x-2 md:space-x-4">
                <button id="prevPageButton"
                        class="w-full md:w-40 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-300 ease-in-out shadow-md text-sm" disabled>
                    Anterior
                </button>
                <button id="nextPageButton"
                        class="w-full md:w-40 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-300 ease-in-out shadow-md text-sm" disabled>
                    Próxima
                </button>
            </div>
            <div id="messageBox" class="hidden mt-2 md:mt-4 p-3 text-center text-sm rounded-lg" role="alert"></div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="modal-button confirm w-full md:w-40 py-2 px-3">Confirmar</button>
                <button id="modalCancelBtn" class="modal-button cancel w-full md:w-40 py-2 px-3">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables for Firebase instances
        let db;
        let auth;
        let firebaseApp;
        let appId; // Variável global para o ID da aplicação

        // Constantes e variáveis globais
        const CLIENTES_POR_PAGINA = 10;
        let clients = [];
        let lastVisibleDoc = null;
        let firstVisibleDoc = null;
        let paginationHistory = [];
        let currentPage = 0;

        let editingClientId = null;
        let userId = null;
        let isAuthReady = false;

        let activeQuickEditElement = null;

        // Mapeamento dos elementos do DOM
        const rawDataInput = document.getElementById('rawDataInput');
        const fillFormButton = document.getElementById('fillFormButton');
        const voiceInputButton = document.getElementById('voiceInputButton'); // Novo botão de input de voz
        const formatDataButton = document.getElementById('formatDataButton'); // Novo botão de formatação
        const clientForm = document.getElementById('clientForm');
        const addClientButton = document.getElementById('addClientButton');
        const updateClientButton = document.getElementById('updateClientButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const clientTableBody = document.getElementById('clientTableBody');
        const messageBox = document.getElementById('messageBox');
        const exportExcelButton = document.getElementById('exportExcelButton');
        const deleteClientButton = document.getElementById('deleteClientButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const updateLoadingSpinner = document.getElementById('updateLoadingSpinner');
        const deleteLoadingSpinner = document.getElementById('deleteLoadingSpinner');

        const clientDetailsContainer = document.getElementById('clientDetailsContainer');

        // Campos do formulário
        const companyNameField = document.getElementById('companyName');
        const contactNameField = document.getElementById('contactName');
        const phoneField = document.getElementById('phone');
        const emailField = document.getElementById('email');
        const websiteField = document.getElementById('website');
        const addressField = document.getElementById('address');
        const firstContactDateField = document.getElementById('firstContactDate');
        const freeConsultationDateField = document.getElementById('freeConsultationDate');
        const freeConsultationTimeField = document.getElementById('freeConsultationTime');
        const secondMeetingDateField = document.getElementById('secondMeetingDate');
        const secondMeetingTimeField = document.getElementById('secondMeetingTime');
        const contractStartDateField = document.getElementById('contractStartDate');
        const statusField = document.getElementById('status');
        const lastContactDateField = document.getElementById('lastContactDate');
        const notesField = document.getElementById('notes');

        // Campos de filtro e pesquisa
        const filterStatusField = document.getElementById('filterStatus');
        const filterDateFromField = document.getElementById('filterDateFrom');
        const filterDateToField = document.getElementById('filterDateTo');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const generalSearchInput = document.getElementById('generalSearchInput');
        const searchButton = document.getElementById('searchButton');
        const prevPageButton = document.getElementById('prevPageButton');
        const nextPageButton = document.getElementById('nextPageButton');

        // Elementos do modal de confirmação
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        // Variáveis para o reconhecimento de fala
        let recognition;
        let isRecognizing = false;
        let finalTranscriptAccumulated = ''; // Variável para acumular o texto final

        /**
         * Exibe uma mensagem para o usuário.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - O tipo de mensagem ('success', 'error', 'info').
         * @param {HTMLElement} [targetBox=messageBox] - O elemento HTML onde a mensagem será exibida.
         */
        function showMessage(message, type, targetBox = messageBox) {
            console.log(`[showMessage] Tipo: ${type}, Mensagem: ${message}`);
            targetBox.textContent = message;
            targetBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            if (type === 'success') {
                targetBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                targetBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                targetBox.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            targetBox.classList.remove('hidden');
            setTimeout(() => {
                targetBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Exibe um modal de confirmação personalizado.
         * @param {string} message - A mensagem a ser exibida no modal.
         * @returns {Promise<boolean>} Uma Promise que resolve para true se confirmado, false caso contrário.
         */
        function showConfirmationModal(message) {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                confirmationModal.classList.remove('hidden');

                const handleConfirm = () => {
                    confirmationModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    confirmationModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                modalConfirmBtn.addEventListener('click', handleConfirm);
                modalCancelBtn.addEventListener('click', handleCancel);
            });
        }

        /**
         * Limpa todos os campos do formulário e redefine o estado de edição.
         */
        function clearForm() {
            console.log("Limpando formulário...");
            companyNameField.value = '';
            contactNameField.value = '';
            phoneField.value = '';
            emailField.value = '';
            websiteField.value = '';
            addressField.value = '';
            firstContactDateField.value = '';
            freeConsultationDateField.value = '';
            freeConsultationTimeField.value = '';
            secondMeetingDateField.value = '';
            secondMeetingTimeField.value = '';
            contractStartDateField.value = '';
            statusField.value = 'Novo Cliente';
            lastContactDateField.value = '';
            notesField.value = '';
            editingClientId = null;
            
            updateClientButton.disabled = true;
            deleteClientButton.disabled = true;
            clientDetailsContainer.classList.remove('edit-mode-border');
            console.log("Formulário limpo.");
        }

        /**
         * Preenche o formulário com os dados de um cliente.
         * @param {Object} client - O objeto cliente contendo os dados a serem preenchidos.
         */
        function fillForm(client) {
            console.log("Preenchendo formulário com dados do cliente:", client.id);
            companyNameField.value = client.companyName || '';
            contactNameField.value = client.contactName || '';
            phoneField.value = client.phone || '';
            emailField.value = client.email || '';
            websiteField.value = client.website || '';
            addressField.value = client.address || '';

            if (client.firstContactDate && client.firstContactDate.toDate) {
                firstContactDateField.value = client.firstContactDate.toDate().toISOString().split('T')[0];
            } else {
                firstContactDateField.value = '';
            }
            if (client.freeConsultationDate && client.freeConsultationDate.toDate) {
                freeConsultationDateField.value = client.freeConsultationDate.toDate().toISOString().split('T')[0];
            } else {
                freeConsultationDateField.value = '';
            }
            freeConsultationTimeField.value = client.freeConsultationTime || '';
            if (client.secondMeetingDate && client.secondMeetingDate.toDate) {
                secondMeetingDateField.value = client.secondMeetingDate.toDate().toISOString().split('T')[0];
            } else {
                secondMeetingDateField.value = '';
            }
            secondMeetingTimeField.value = '';
            if (client.contractStartDate && client.contractStartDate.toDate) {
                contractStartDateField.value = client.contractStartDate.toDate().toISOString().split('T')[0];
            } else {
                contractStartDateField.value = '';
            }

            statusField.value = client.status || 'Novo Cliente';
            if (client.lastContactDate && client.lastContactDate.toDate) {
                lastContactDateField.value = client.lastContactDate.toDate().toISOString().split('T')[0];
            } else {
                lastContactDateField.value = '';
            }
            notesField.value = client.notes || '';
            editingClientId = client.id;
            
            updateClientButton.disabled = false;
            deleteClientButton.disabled = false;
            clientDetailsContainer.classList.add('edit-mode-border');
            console.log("Formulário preenchido e modo de edição ativado.");
        }

        /**
         * Analisa o texto bruto do Google Meu Negócio e extrai informações do cliente.
         * Esta função foi aprimorada para ser mais flexível na identificação de dados.
         * @param {string} rawText - O texto bruto a ser analisado.
         * @returns {Object} Um objeto com os dados do cliente extraídos.
         */
        function parseRawData(rawText) {
            console.log("Analisando dados brutos com lógica aprimorada...");
            const data = {};
            let remainingText = rawText; // Usaremos esta variável para remover o texto à medida que é extraído

            // Helper para extrair e remover o primeiro match
            const extractAndRemove = (text, regex) => {
                const match = text.match(regex);
                if (match) {
                    const value = match[1] ? match[1].trim() : match[0].trim(); // Captura o grupo se houver, senão o match inteiro
                    // Substitui o texto encontrado por espaços para não afetar outras regex, mas o remove logicamente
                    const newText = text.replace(match[0], ' '.repeat(match[0].length));
                    return { value, newText };
                }
                return { value: null, newText: text };
            };

            // 1. Extrair e-mail (padrão mais robusto)
            let result = extractAndRemove(remainingText, /\b([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})\b/i);
            if (result.value) {
                data.email = result.value;
                remainingText = result.newText;
                console.log("Email extraído:", data.email);
            }

            // 2. Extrair telefone (padrão mais flexível, incluindo com e sem DDD, com e sem hífen/espaço)
            result = extractAndRemove(remainingText, /\b(?:\(?\d{2}\)?[\s.-]?)?\d{4,5}[-\s.]?\d{4}\b/);
            if (result.value) {
                data.phone = result.value.replace(/[\s.-]/g, ''); // Remove espaços e hífens para padronizar
                remainingText = result.newText;
                console.log("Telefone extraído:", data.phone);
            }

            // 3. Extrair site (padrão mais flexível, com ou sem http/https/www)
            result = extractAndRemove(remainingText, /\b(?:https?:\/\/(?:www\.)?|www\.)?([a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+(?:\/[^\s]*)?)\b/i);
            if (result.value) {
                data.website = result.value;
                if (!data.website.startsWith('http://') && !data.website.startsWith('https://')) {
                    data.website = 'http://' + data.website; // Adiciona http se não houver
                }
                remainingText = result.newText;
                console.log("Site extraído:", data.website);
            }

            // 4. Extrair datas (YYYY-MM-DD ou DD/MM/YYYY)
            // Prioriza YYYY-MM-DD
            result = extractAndRemove(remainingText, /\b(\d{4}-\d{2}-\d{2})\b/);
            if (result.value) {
                data.firstContactDate = result.value; // Pode ser qualquer data, vamos atribuir à primeira
                remainingText = result.newText;
                console.log("Data (YYYY-MM-DD) extraída:", data.firstContactDate);
            } else {
                // Tenta DD/MM/YYYY
                result = extractAndRemove(remainingText, /\b(\d{2}\/\d{2}\/\d{4})\b/);
                if (result.value) {
                    // Converte para YYYY-MM-DD para o campo de data HTML
                    const parts = result.value.split('/');
                    data.firstContactDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    remainingText = result.newText;
                    console.log("Data (DD/MM/YYYY) extraída e convertida:", data.firstContactDate);
                }
            }

            // 5. Extrair horários (HH:MM)
            result = extractAndRemove(remainingText, /\b(\d{2}:\d{2})\b/);
            if (result.value) {
                data.freeConsultationTime = result.value; // Atribui ao primeiro horário encontrado
                remainingText = result.newText;
                console.log("Horário extraído:", data.freeConsultationTime);
            }

            // 6. Extrair Status (procura por palavras-chave de status conhecidas)
            const statusKeywords = ['Novo Cliente', 'Em Andamento', 'Aguardando Contato', 'Perdido', 'Reunião Agendada', 'Consultoria Gratuita Agendada', 'Segunda Reunião Agendada', 'Contrato Assinado'];
            for (const status of statusKeywords) {
                const statusRegex = new RegExp(`\\b${status}\\b`, 'i');
                result = extractAndRemove(remainingText, statusRegex);
                if (result.value) {
                    data.status = status; // Garante que o status seja um dos valores válidos
                    remainingText = result.newText;
                    console.log("Status extraído:", data.status);
                    break; // Sai do loop assim que um status é encontrado
                }
            }

            // 7. Extrair Nome da Empresa (primeira linha ou texto antes de um rótulo conhecido)
            // Se já tiver um companyName de um rótulo, mantém. Senão, tenta inferir.
            if (!data.companyName) {
                const companyNameMatch = rawText.match(/(?:Nome da Empresa:|Empresa:)\s*([^\n]+)/i);
                if (companyNameMatch) {
                    data.companyName = companyNameMatch[1].trim();
                    remainingText = remainingText.replace(companyNameMatch[0], ' '.repeat(companyNameMatch[0].length));
                } else {
                    // Tenta pegar a primeira linha não vazia como nome da empresa, se não houver rótulo
                    const lines = remainingText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                    if (lines.length > 0 && !data.email && !data.phone && !data.website) { // Evita pegar email/tel/site como nome da empresa
                        data.companyName = lines[0];
                        remainingText = remainingText.replace(lines[0], ' '.repeat(lines[0].length));
                        console.log("Nome da Empresa inferido:", data.companyName);
                    }
                }
            }


            // 8. Extrair Nome de Contato (procura por "Nome de Contato:" ou "Contato:")
            result = extractAndRemove(remainingText, /(?:Nome de Contato:|Contato:)\s*([^\n]+)/i);
            if (result.value) {
                data.contactName = result.value;
                remainingText = result.newText;
                console.log("Nome de Contato extraído:", data.contactName);
            }

            // 9. Extrair Endereço (procura por rótulos ou padrões de endereço)
            result = extractAndRemove(remainingText, /(?:Endereço:|Rua|Av\.|Avenida|Travessa|Praça)\s*([^\n]+(?:,\s*\d+)?(?:,\s*[^\n]+)?(?:-\s*[^\n]+)?(?:,\s*CEP\s*\d{5}-?\d{3})?)/i);
            if (result.value) {
                data.address = result.value;
                remainingText = result.newText;
                console.log("Endereço extraído:", data.address);
            } else {
                // Tenta um padrão mais genérico para endereço se o rótulo não for encontrado
                result = extractAndRemove(remainingText, /(\d{1,5}\s+[A-Za-z\s]+\s+(?:Rua|Av\.|Avenida|Travessa|Praça|Bairro|Centro|Cidade|Estado)[^\n]*)/i);
                if (result.value) {
                    data.address = result.value;
                    remainingText = result.newText;
                    console.log("Endereço genérico extraído:", data.address);
                }
            }


            // 10. Atribuir o restante do texto às Observações
            data.notes = remainingText.replace(/\s+/g, ' ').trim(); // Remove múltiplos espaços e trim
            console.log("Observações (texto restante):", data.notes);

            console.log("Dados brutos analisados (final):", data);
            return data;
        }

        /**
         * Calcula o tempo de contrato em anos e meses.
         * @param {string} startDateString - A data de início do contrato no formato ISO (YYYY-MM-DD).
         * @returns {string} O tempo de contrato formatado (ex: "2 anos e 3 meses").
         */
        function calculateContractDuration(startDateString) {
            if (!startDateString) {
                return 'N/A';
            }
            const startDate = new Date(startDateString);
            const today = new Date();

            let years = today.getFullYear() - startDate.getFullYear();
            let months = today.getMonth() - startDate.getMonth();

            if (months < 0 || (months === 0 && today.getDate() < startDate.getDate())) {
                years--;
                months += 12;
            }

            if (today.getDate() < startDate.getDate()) {
                months--;
            }
            
            if (months < 0) {
                months = 0;
            }

            const parts = [];
            if (years > 0) {
                parts.push(`${years} ano${years > 1 ? 's' : ''}`);
            }
            if (months > 0) {
                parts.push(`${months} mes${months > 1 ? 'es' : ''}`);
            }

            if (parts.length === 0) {
                return 'Menos de 1 mês';
            }
            return parts.join(' e ');
        }

        /**
         * Desativa o modo de edição rápida para um elemento específico.
         * @param {HTMLElement} container - O elemento .quick-edit-container a ser desativado.
         */
        function deactivateQuickEdit(container) {
            if (!container) return;
            console.log("Desativando edição rápida para o container:", container);

            const displaySpan = container.querySelector('.quick-edit-display');
            const inputField = container.querySelector('.quick-edit-input:not(select)');
            const selectField = container.querySelector('.quick-edit-input.quick-edit-status');
            const saveButton = container.querySelector('.quick-edit-btn');

            if (displaySpan) displaySpan.classList.remove('hidden');
            if (inputField) inputField.classList.add('hidden');
            if (selectField) selectField.classList.add('hidden');
            if (saveButton) saveButton.classList.add('hidden');

            activeQuickEditElement = null;
            console.log("Edição rápida desativada.");
        }

        /**
         * Renderiza a tabela de clientes com os dados fornecidos.
         * @param {Array<Object>} clientsToRender - Array de objetos cliente a serem exibidos.
         */
        function renderClientTable(clientsToRender) {
            console.log("Renderizando tabela de clientes. Clientes a renderizar:", clientsToRender.length);
            clientTableBody.innerHTML = '';
            if (clientsToRender.length === 0) {
                clientTableBody.innerHTML = `<tr><td colspan="16" class="px-6 py-4 text-center text-gray-500">Nenhum cliente encontrado.</td></tr>`;
                console.log("Nenhum cliente encontrado para renderizar.");
                return;
            }

            clientsToRender.forEach(client => {
                const row = clientTableBody.insertRow();
                row.dataset.id = client.id;
                row.classList.add('hover:bg-gray-50', 'transition-colors', 'duration-150', 'ease-in-out');

                if (client.status === 'Em Andamento') {
                    row.classList.add('in-progress-row');
                } else if (client.status === 'Reunião Agendada' || client.status === 'Consultoria Gratuita Agendada' || client.status === 'Segunda Reunião Agendada') {
                    row.classList.add('meeting-scheduled-row');
                } else if (client.status === 'Contrato Assinado') {
                    row.classList.add('contract-signed-row');
                } else {
                    row.classList.add('bg-white');
                }

                const firstCell = row.insertCell();
                firstCell.classList.add('px-3', 'md:px-6', 'py-2', 'md:py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-800', 'font-medium', 'text-gray-900');
                firstCell.innerHTML = client.companyName;

                if (row.classList.contains('in-progress-row')) {
                    firstCell.style.backgroundColor = '#fffde7';
                } else if (row.classList.contains('meeting-scheduled-row')) {
                    firstCell.style.backgroundColor = '#fffbeb';
                } else if (row.classList.contains('contract-signed-row')) {
                    firstCell.style.backgroundColor = '#dcfce7';
                } else {
                    firstCell.style.backgroundColor = '#ffffff';
                }

                const remainingCellsContent = [
                    client.contactName,
                    client.phone,
                    client.email,
                    client.website ? `<a href="${client.website}" target="_blank" class="text-blue-600 hover:underline">${client.website}</a>` : '',
                    client.address,
                    client.firstContactDate ? new Date(client.firstContactDate.toDate()).toLocaleDateString('pt-BR') : '',
                    client.freeConsultationDate ? new Date(client.freeConsultationDate.toDate()).toLocaleDateString('pt-BR') : '',
                    client.freeConsultationTime || '',
                    client.secondMeetingDate ? new Date(client.secondMeetingDate.toDate()).toLocaleDateString('pt-BR') : '',
                    client.secondMeetingTime || '',
                    client.contractStartDate ? new Date(client.contractStartDate.toDate()).toLocaleDateString('pt-BR') : '',
                    calculateContractDuration(client.contractStartDate ? client.contractStartDate.toDate().toISOString().split('T')[0] : null),
                    client.status,
                    client.lastContactDate ? new Date(client.lastContactDate.toDate()).toLocaleDateString('pt-BR') : '',
                    client.notes
                ];

                remainingCellsContent.forEach((cellContent, index) => {
                    const cell = row.insertCell();
                    cell.classList.add('px-3', 'md:px-6', 'py-2', 'md:py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-800');

                    let actualFieldName = '';
                    let inputType = 'text';
                    switch(index + 1) {
                        case 6: actualFieldName = 'firstContactDate'; inputType = 'date'; break;
                        case 7: actualFieldName = 'freeConsultationDate'; inputType = 'date'; break;
                        case 8: actualFieldName = 'freeConsultationTime'; inputType = 'time'; break;
                        case 9: actualFieldName = 'secondMeetingDate'; inputType = 'date'; break;
                        case 10: actualFieldName = 'secondMeetingTime'; inputType = 'time'; break;
                        case 13: actualFieldName = 'status'; break;
                        case 14: actualFieldName = 'lastContactDate'; inputType = 'date'; break;
                        case 15: actualFieldName = 'notes'; break;
                        default: break;
                    }

                    if (actualFieldName) {
                        let displayValue = cellContent;
                        if (inputType === 'date' && client[actualFieldName] && client[actualFieldName].toDate) {
                            displayValue = client[actualFieldName].toDate().toLocaleDateString('pt-BR');
                        } else if (inputType === 'time') {
                            displayValue = client[actualFieldName] || '';
                        } else if (actualFieldName === 'notes') {
                            displayValue = client[actualFieldName] || 'Clique para editar';
                        }
                        
                        cell.innerHTML = `
                            <div class="quick-edit-container">
                                <span class="quick-edit-display">${displayValue || 'Clique para editar'}</span>
                                ${actualFieldName === 'status' ? `
                                    <select class="quick-edit-input quick-edit-status hidden">
                                        <option value="Novo Cliente">Novo Cliente</option>
                                        <option value="Em Andamento">Em Andamento</option>
                                        <option value="Aguardando Contato">Aguardando Contato</option>
                                        <option value="Perdido">Perdido</option>
                                        <option value="Reunião Agendada">Reunião Agendada</option>
                                        <option value="Consultoria Gratuita Agendada">Consultoria Gratuita Agendada</option>
                                        <option value="Segunda Reunião Agendada">Segunda Reunião Agendada</option>
                                        <option value="Contrato Assinado">Contrato Assinado</option>
                                    </select>
                                ` : `<input type="${inputType}" class="quick-edit-input hidden" value="${client[actualFieldName] ? (inputType === 'date' ? client[actualFieldName].toDate().toISOString().split('T')[0] : client[actualFieldName]) : ''}">`}
                                <button class="quick-edit-btn hidden" data-field="${actualFieldName}" data-id="${client.id}">Salvar</button>
                            </div>
                        `;
                        const quickEditContainer = cell.querySelector('.quick-edit-container');
                        const displaySpan = cell.querySelector('.quick-edit-display');
                        const inputField = cell.querySelector('.quick-edit-input:not(select)');
                        const selectField = cell.querySelector('.quick-edit-input.quick-edit-status');
                        const saveButton = cell.querySelector('.quick-edit-btn');

                        displaySpan.addEventListener('click', (event) => {
                            if (activeQuickEditElement && activeQuickEditElement !== quickEditContainer) {
                                deactivateQuickEdit(activeQuickEditElement);
                            }

                            displaySpan.classList.add('hidden');
                            if (selectField) {
                                selectField.value = client[actualFieldName] || '';
                                selectField.classList.remove('hidden');
                                selectField.focus();
                            } else if (inputField) {
                                inputField.value = client[actualFieldName] ? (inputType === 'date' ? client[actualFieldName].toDate().toISOString().split('T')[0] : client[actualFieldName]) : '';
                                inputField.classList.remove('hidden');
                                inputField.focus();
                            }
                            saveButton.classList.remove('hidden');
                            activeQuickEditElement = quickEditContainer;
                            event.stopPropagation();
                        });

                        saveButton.addEventListener('click', async (event) => {
                            let newValue;
                            if (selectField && !selectField.classList.contains('hidden')) {
                                newValue = selectField.value;
                            } else if (inputField && !inputField.classList.contains('hidden')) {
                                newValue = inputField.value;
                            } else {
                                return;
                            }

                            const updateData = {};
                            if (inputType === 'date') {
                                updateData[actualFieldName] = newValue ? firebase.firestore.Timestamp.fromDate(new Date(newValue)) : null;
                            } else {
                                updateData[actualFieldName] = newValue;
                            }
                            
                            try {
                                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients').doc(client.id).update(updateData);
                                showMessage('Campo atualizado com sucesso!', 'success');
                                deactivateQuickEdit(quickEditContainer);
                                fetchClients();
                            } catch (error) {
                                console.error("Erro ao atualizar campo rápido:", error);
                                showMessage('Erro ao atualizar campo.', 'error');
                            }
                            event.stopPropagation();
                        });
                    } else {
                        cell.innerHTML = cellContent;
                    }
                });

                row.addEventListener('click', () => {
                    document.querySelectorAll('#clientTableBody tr').forEach(r => r.classList.remove('bg-blue-100'));
                    row.classList.add('bg-blue-100');
                    fillForm(client);
                });
            });
            console.log("Tabela de clientes renderizada.");
        }

        /**
         * Busca clientes do Firestore com base nos filtros e termos de pesquisa.
         * Gerencia a paginação.
         * @param {string} [direction='current'] - 'next', 'prev' ou 'current' para controle de paginação.
         */
        async function fetchClients(direction = 'current') {
            console.log(`[fetchClients] Chamado com direção: ${direction}. isAuthReady: ${isAuthReady}, userId: ${userId}`);
            if (!isAuthReady || !userId) {
                console.log("[fetchClients] Autenticação não pronta ou userId ausente. Abortando busca.");
                clientTableBody.innerHTML = `<tr><td colspan="16" class="px-6 py-4 text-center text-gray-500">Aguardando autenticação...</td></tr>`;
                return;
            }

            clientTableBody.innerHTML = `<tr><td colspan="16" class="px-6 py-4 text-center text-gray-500">Carregando clientes...</td></tr>`;
            
            let queryRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients');
            console.log(`[fetchClients] Caminho da coleção: artifacts/${appId}/users/${userId}/clients`);

            const selectedStatuses = Array.from(filterStatusField.selectedOptions).map(option => option.value).filter(value => value !== '');
            if (selectedStatuses.length > 0) {
                queryRef = queryRef.where('status', 'in', selectedStatuses);
                console.log("[fetchClients] Filtro de status aplicado:", selectedStatuses);
            }

            const filterDateFrom = filterDateFromField.value;
            const filterDateTo = filterDateToField.value;

            if (filterDateFrom) {
                queryRef = queryRef.where('lastContactDate', '>=', firebase.firestore.Timestamp.fromDate(new Date(filterDateFrom)));
                console.log("[fetchClients] Filtro de data 'de' aplicado:", filterDateFrom);
            }
            if (filterDateTo) {
                const dateTo = new Date(filterDateTo);
                dateTo.setDate(dateTo.getDate() + 1);
                queryRef = queryRef.where('lastContactDate', '<', firebase.firestore.Timestamp.fromDate(dateTo));
                console.log("[fetchClients] Filtro de data 'até' aplicado:", filterDateTo);
            }

            queryRef = queryRef.orderBy('companyName');
            console.log("[fetchClients] Ordenando por 'companyName'.");

            if (direction === 'next' && lastVisibleDoc) {
                paginationHistory.push(firstVisibleDoc);
                queryRef = queryRef.startAfter(lastVisibleDoc);
                currentPage++;
                console.log("[fetchClients] Paginação: Próxima página. currentPage:", currentPage);
            } else if (direction === 'prev' && paginationHistory.length > 0) {
                queryRef = queryRef.startAt(paginationHistory.pop());
                currentPage--;
                console.log("[fetchClients] Paginação: Página anterior. currentPage:", currentPage);
            } else if (direction === 'current') {
                paginationHistory = [];
                currentPage = 0;
                console.log("[fetchClients] Paginação: Página atual (reset). currentPage:", currentPage);
            }

            queryRef = queryRef.limit(CLIENTES_POR_PAGINA);
            console.log("[fetchClients] Limite de clientes por página:", CLIENTES_POR_PAGINA);

            try {
                const snapshot = await queryRef.get();
                console.log("[fetchClients] Snapshot do Firestore recebido. Docs:", snapshot.docs.length);
                clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                let filteredClients = clients;
                const searchTerm = generalSearchInput.value.toLowerCase();

                if (searchTerm) {
                    console.log("[fetchClients] Termo de pesquisa geral aplicado:", searchTerm);
                    filteredClients = clients.filter(client =>
                        (client.companyName && client.companyName.toLowerCase().includes(searchTerm)) ||
                        (client.contactName && client.contactName.toLowerCase().includes(searchTerm)) ||
                        (client.phone && client.phone.toLowerCase().includes(searchTerm)) ||
                        (client.email && client.email.toLowerCase().includes(searchTerm)) ||
                        (client.address && client.address.toLowerCase().includes(searchTerm)) ||
                        (client.notes && client.notes.toLowerCase().includes(searchTerm)) ||
                        (client.status && client.status.toLowerCase().includes(searchTerm)) ||
                        (client.firstContactDate && new Date(client.firstContactDate.toDate()).toLocaleDateString('pt-BR').toLowerCase().includes(searchTerm)) ||
                        (client.freeConsultationDate && new Date(client.freeConsultationDate.toDate()).toLocaleDateString('pt-BR').toLowerCase().includes(searchTerm)) ||
                        (client.freeConsultationTime && client.freeConsultationTime.toLowerCase().includes(searchTerm)) ||
                        (client.secondMeetingDate && new Date(client.secondMeetingDate.toDate()).toLocaleDateString('pt-BR').toLowerCase().includes(searchTerm)) ||
                        (client.secondMeetingTime && client.secondMeetingTime.toLowerCase().includes(searchTerm))
                    );
                }

                renderClientTable(filteredClients);

                if (snapshot.docs.length > 0) {
                    firstVisibleDoc = snapshot.docs[0];
                    lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
                    console.log("[fetchClients] firstVisibleDoc e lastVisibleDoc definidos.");
                } else {
                    firstVisibleDoc = null;
                    lastVisibleDoc = null;
                    console.log("[fetchClients] Nenhum documento no snapshot, firstVisibleDoc e lastVisibleDoc nulos.");
                }

                prevPageButton.disabled = currentPage === 0;
                const nextQuerySnapshot = await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients')
                                                .orderBy('companyName')
                                                .startAfter(lastVisibleDoc)
                                                .limit(1)
                                                .get();
                nextPageButton.disabled = nextQuerySnapshot.empty;
                console.log("[fetchClients] Botões de paginação atualizados.");

            } catch (error) {
                console.error("[fetchClients] Erro ao buscar clientes:", error);
                showMessage('Erro ao carregar clientes. Verifique as permissões do Firestore.', 'error');
                clientTableBody.innerHTML = `<tr><td colspan="16" class="px-6 py-4 text-center text-red-500">Erro ao carregar clientes. Tente novamente.</td></tr>`;
            }
        }

        /**
         * Adiciona um novo cliente ao Firestore.
         */
        addClientButton.addEventListener('click', async () => {
            console.log("[addClientButton] Clicado. isAuthReady:", isAuthReady, "userId:", userId);
            if (!isAuthReady || !userId) {
                showMessage('Autenticação não pronta. Tente novamente.', 'error');
                console.error("[addClientButton] Abortando: Autenticação não pronta ou userId ausente.");
                return;
            }
            loadingSpinner.classList.remove('hidden');
            addClientButton.disabled = true;

            const clientData = {
                companyName: companyNameField.value,
                contactName: contactNameField.value,
                phone: phoneField.value,
                email: emailField.value,
                website: websiteField.value,
                address: addressField.value,
                firstContactDate: firstContactDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(firstContactDateField.value)) : null,
                freeConsultationDate: freeConsultationDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(freeConsultationDateField.value)) : null,
                freeConsultationTime: freeConsultationTimeField.value,
                secondMeetingDate: secondMeetingDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(secondMeetingDateField.value)) : null,
                secondMeetingTime: secondMeetingTimeField.value,
                contractStartDate: contractStartDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(contractStartDateField.value)) : null,
                status: statusField.value,
                lastContactDate: lastContactDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(lastContactDateField.value)) : null,
                notes: notesField.value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            console.log("[addClientButton] Dados do cliente para adicionar:", clientData);

            try {
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients').add(clientData);
                showMessage('Cliente adicionado com sucesso!', 'success');
                console.log("[addClientButton] Cliente adicionado com sucesso.");
                clearForm();
                fetchClients();
            }
            catch (error) {
                console.error("[addClientButton] Erro ao adicionar cliente:", error);
                showMessage('Erro ao adicionar cliente.', 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
                addClientButton.disabled = false;
                console.log("[addClientButton] Operação de adicionar finalizada.");
            }
        });

        /**
         * Atualiza um cliente existente no Firestore.
         */
        updateClientButton.addEventListener('click', async () => {
            console.log("[updateClientButton] Clicado. editingClientId:", editingClientId);
            if (!editingClientId) {
                showMessage('Nenhum cliente selecionado para atualização.', 'info');
                return;
            }
            if (!isAuthReady || !userId) {
                showMessage('Autenticação não pronta. Tente novamente.', 'error');
                console.error("[updateClientButton] Abortando: Autenticação não pronta ou userId ausente.");
                return;
            }

            updateLoadingSpinner.classList.remove('hidden');
            updateClientButton.disabled = true;

            const clientData = {
                companyName: companyNameField.value,
                contactName: contactNameField.value,
                phone: phoneField.value,
                email: emailField.value,
                website: websiteField.value,
                address: addressField.value,
                firstContactDate: firstContactDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(firstContactDateField.value)) : null,
                freeConsultationDate: freeConsultationDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(freeConsultationDateField.value)) : null,
                freeConsultationTime: freeConsultationTimeField.value,
                secondMeetingDate: secondMeetingDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(secondMeetingDateField.value)) : null,
                secondMeetingTime: secondMeetingTimeField.value,
                contractStartDate: contractStartDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(contractStartDateField.value)) : null,
                status: statusField.value,
                lastContactDate: lastContactDateField.value ? firebase.firestore.Timestamp.fromDate(new Date(lastContactDateField.value)) : null,
                notes: notesField.value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            console.log("[updateClientButton] Dados do cliente para atualizar:", clientData);

            try {
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients').doc(editingClientId).update(clientData);
                showMessage('Campo atualizado com sucesso!', 'success');
                console.log("[updateClientButton] Cliente atualizado com sucesso.");
                clearForm();
                fetchClients();
            } catch (error) {
                console.error("[updateClientButton] Erro ao atualizar cliente:", error);
                showMessage('Erro ao atualizar campo.', 'error');
            } finally {
                updateLoadingSpinner.classList.add('hidden');
                updateClientButton.disabled = false;
                console.log("[updateClientButton] Operação de atualização finalizada.");
            }
        });

        /**
         * Exclui um cliente do Firestore.
         */
        deleteClientButton.addEventListener('click', async () => {
            console.log("[deleteClientButton] Clicado. editingClientId:", editingClientId);
            if (!editingClientId) {
                showMessage('Nenhum cliente selecionado para exclusão.', 'info');
                return;
            }
            if (!isAuthReady || !userId) {
                showMessage('Autenticação não pronta. Tente novamente.', 'error');
                console.error("[deleteClientButton] Abortando: Autenticação não pronta ou userId ausente.");
                return;
            }

            const confirmed = await showConfirmationModal('Tem certeza que deseja excluir este cliente?');
            if (!confirmed) {
                console.log("[deleteClientButton] Exclusão cancelada pelo usuário.");
                return;
            }

            deleteLoadingSpinner.classList.remove('hidden');
            deleteClientButton.disabled = true;

            try {
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('clients').doc(editingClientId).delete();
                showMessage('Cliente excluído com sucesso!', 'success');
                console.log("[deleteClientButton] Cliente excluído com sucesso.");
                clearForm();
                fetchClients();
            } catch (error) {
                console.error("[deleteClientButton] Erro ao excluir cliente:", error);
                showMessage('Erro ao excluir cliente.', 'error');
            } finally {
                deleteLoadingSpinner.classList.add('hidden');
                deleteClientButton.disabled = false;
                console.log("[deleteClientButton] Operação de exclusão finalizada.");
            }
        });

        /**
         * Event listener para o botão "Preencher Formulário".
         * Analisa o texto bruto e preenche os campos do formulário.
         */
        fillFormButton.addEventListener('click', () => {
            console.log("[fillFormButton] Clicado.");
            const rawText = rawDataInput.value;
            const clientData = parseRawData(rawText);
            
            companyNameField.value = clientData.companyName || '';
            contactNameField.value = clientData.contactName || '';
            phoneField.value = clientData.phone || '';
            emailField.value = clientData.email || '';
            websiteField.value = clientData.website || '';
            addressField.value = clientData.address || '';
            firstContactDateField.value = clientData.firstContactDate || '';
            freeConsultationDateField.value = clientData.freeConsultationDate || '';
            freeConsultationTimeField.value = clientData.freeConsultationTime || '';
            secondMeetingDateField.value = clientData.secondMeetingDate || '';
            secondMeetingTimeField.value = clientData.secondMeetingTime || '';
            contractStartDateField.value = clientData.contractStartDate || '';
            statusField.value = clientData.status || 'Novo Cliente';
            lastContactDateField.value = clientData.lastContactDate || '';
            notesField.value = clientData.notes || '';

            showMessage('Formulário preenchido com dados brutos.', 'info');
            console.log("[fillFormButton] Formulário preenchido.");
        });

        /**
         * Event listener para o botão "Cancelar Edição".
         * Limpa o formulário e redefine o estado de edição.
         */
        cancelEditButton.addEventListener('click', () => {
            console.log("[cancelEditButton] Clicado.");
            clearForm();
            showMessage('Edição cancelada. Formulário limpo.', 'info');
        });

        /**
         * Event listener para o botão "Exportar Excel".
         * Exporta os dados da tabela para um arquivo Excel.
         */
        exportExcelButton.addEventListener('click', () => {
            console.log("[exportExcelButton] Clicado. Exportando para Excel...");
            const ws = XLSX.utils.json_to_sheet(clients.map(client => {
                const formattedClient = { ...client };
                if (formattedClient.firstContactDate && formattedClient.firstContactDate.toDate) {
                    formattedClient.firstContactDate = formattedClient.firstContactDate.toDate().toLocaleDateString('pt-BR');
                }
                if (formattedClient.freeConsultationDate && formattedClient.freeConsultationDate.toDate) {
                    formattedClient.freeConsultationDate = formattedClient.freeConsultationDate.toDate().toLocaleDateString('pt-BR');
                }
                if (formattedClient.secondMeetingDate && formattedClient.secondMeetingDate.toDate) {
                    formattedClient.secondMeetingDate = formattedClient.secondMeetingDate.toDate().toLocaleDateString('pt-BR');
                }
                if (formattedClient.contractStartDate && formattedClient.contractStartDate.toDate) {
                    formattedClient.contractStartDate = formattedClient.contractStartDate.toDate().toLocaleDateString('pt-BR');
                }
                if (formattedClient.lastContactDate && formattedClient.lastContactDate.toDate) {
                    formattedClient.lastContactDate = formattedClient.lastContactDate.toDate().toLocaleDateString('pt-BR');
                }
                formattedClient['Tempo de Contrato'] = calculateContractDuration(client.contractStartDate ? client.contractStartDate.toDate().toISOString().split('T')[0] : null);
                return formattedClient;
            }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Clientes CRM");
            XLSX.writeFile(wb, "clientes_crm.xlsx");
            showMessage('Dados exportados para Excel!', 'success');
            console.log("[exportExcelButton] Exportação para Excel concluída.");
        });

        /**
         * Event listeners para os botões de paginação.
         */
        prevPageButton.addEventListener('click', () => {
            console.log("[prevPageButton] Clicado.");
            fetchClients('prev');
        });
        nextPageButton.addEventListener('click', () => {
            console.log("[nextPageButton] Clicado.");
            fetchClients('next');
        });

        /**
         * Event listeners para os botões de filtro e pesquisa.
         */
        applyFiltersButton.addEventListener('click', () => {
            console.log("[applyFiltersButton] Clicado.");
            currentPage = 0;
            paginationHistory = [];
            fetchClients('current');
        });

        clearFiltersButton.addEventListener('click', () => {
            console.log("[clearFiltersButton] Clicado.");
            filterStatusField.querySelectorAll('option').forEach(option => option.selected = false);
            filterDateFromField.value = '';
            filterDateToField.value = '';
            generalSearchInput.value = '';
            currentPage = 0;
            paginationHistory = [];
            fetchClients('current');
        });

        searchButton.addEventListener('click', () => {
            console.log("[searchButton] Clicado.");
            currentPage = 0;
            paginationHistory = [];
            fetchClients('current');
        });

        // Função para inicializar o reconhecimento de fala
        function initializeSpeechRecognition() {
            // Verifica a compatibilidade do navegador
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showMessage('Seu navegador não suporta reconhecimento de fala. Use o Chrome para esta funcionalidade.', 'error');
                voiceInputButton.disabled = true;
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true; // Continua a capturar fala até ser parado explicitamente
            recognition.interimResults = true; // Mostra resultados provisórios
            recognition.lang = 'pt-BR'; // Define o idioma para Português do Brasil

            recognition.onstart = () => {
                isRecognizing = true;
                voiceInputButton.textContent = 'Parar de Falar';
                voiceInputButton.classList.remove('bg-purple-600');
                voiceInputButton.classList.add('bg-red-600');
                showMessage('Ouvindo... Fale agora.', 'info');
                console.log("[SpeechRecognition] Reconhecimento iniciado.");
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscriptAccumulated += event.results[i][0].transcript + ' '; // Acumula o texto final
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                // Atualiza a área de texto com o texto final acumulado mais o texto provisório atual
                rawDataInput.value = finalTranscriptAccumulated + interimTranscript;
                rawDataInput.scrollTop = rawDataInput.scrollHeight; // Rola para o final
                console.log("[SpeechRecognition] Resultado provisório:", interimTranscript);
                console.log("[SpeechRecognition] Resultado final acumulado:", finalTranscriptAccumulated);
            };

            recognition.onerror = (event) => {
                isRecognizing = false;
                voiceInputButton.textContent = 'Falar para Preencher';
                voiceInputButton.classList.remove('bg-red-600');
                voiceInputButton.classList.add('bg-purple-600');
                console.error("[SpeechRecognition] Erro no reconhecimento de fala:", event.error);
                if (event.error === 'not-allowed') {
                    showMessage('Permissão para usar o microfone negada. Por favor, permita o acesso ao microfone nas configurações do navegador.', 'error');
                } else if (event.error === 'no-speech') {
                    showMessage('Nenhuma fala detectada. Tente novamente.', 'info');
                } else {
                    showMessage(`Erro no reconhecimento de fala: ${event.error}`, 'error');
                }
                // Tenta reiniciar o reconhecimento se a interrupção não for por erro de permissão ou parada intencional
                if (event.error !== 'not-allowed' && voiceInputButton.dataset.mode === 'continuous') {
                    console.log("[SpeechRecognition] Tentando reiniciar devido a erro não crítico.");
                    setTimeout(() => {
                        if (voiceInputButton.dataset.mode === 'continuous') { // Verifica novamente
                            recognition.start();
                        }
                    }, 500);
                }
            };

            recognition.onend = () => {
                isRecognizing = false;
                voiceInputButton.textContent = 'Falar para Preencher';
                voiceInputButton.classList.remove('bg-red-600');
                voiceInputButton.classList.add('bg-purple-600');
                showMessage('Reconhecimento de fala finalizado (pausado).', 'info');
                console.log("[SpeechRecognition] Reconhecimento finalizado (pausado).");

                // Reinicia o reconhecimento se o modo contínuo estiver ativo
                if (voiceInputButton.dataset.mode === 'continuous') {
                    console.log("[SpeechRecognition] Reiniciando reconhecimento automaticamente.");
                    setTimeout(() => {
                        if (voiceInputButton.dataset.mode === 'continuous') { // Verifica novamente antes de reiniciar
                            recognition.start();
                        }
                    }, 500); // Pequeno atraso antes de reiniciar
                }
            };
        }

        // Event listener para o botão de input de voz
        voiceInputButton.addEventListener('click', () => {
            if (!recognition) {
                showMessage('Reconhecimento de fala não inicializado. Tente recarregar a página.', 'error');
                return;
            }
            if (isRecognizing) {
                recognition.stop();
                voiceInputButton.dataset.mode = 'stopped'; // Marca como parado intencionalmente
                console.log("[VoiceInputButton] Parando reconhecimento intencionalmente.");
            } else {
                // Se não está reconhecendo, é um novo início ou continuação
                // Se o campo está vazio, limpa o acumulador para uma nova sessão limpa
                if (rawDataInput.value.trim() === '') {
                    finalTranscriptAccumulated = '';
                } else {
                    // Se o campo já tem conteúdo, inicia o acumulador com ele
                    finalTranscriptAccumulated = rawDataInput.value.trim() + ' ';
                }
                voiceInputButton.dataset.mode = 'continuous'; // Marca como modo contínuo
                recognition.start();
                console.log("[VoiceInputButton] Iniciando reconhecimento (modo contínuo).");
            }
        });

        /**
         * Formata o texto bruto na textarea adicionando rótulos explícitos.
         */
        formatDataButton.addEventListener('click', () => {
            console.log("[formatDataButton] Clicado. Formatando dados...");
            const rawText = rawDataInput.value;
            const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            let formattedText = [];

            const fieldLabels = {
                companyName: 'Nome da Empresa:',
                contactName: 'Nome de Contato:',
                phone: 'Telefone:',
                email: 'Email:',
                website: 'Site:',
                address: 'Endereço:',
                firstContactDate: 'Data do Primeiro Contato:',
                freeConsultationDate: 'Data da Consultoria Gratuita:',
                freeConsultationTime: 'Horário da Consultoria Gratuita:',
                secondMeetingDate: 'Data da Segunda Reunião:',
                secondMeetingTime: 'Horário da Segunda Reunião:',
                contractStartDate: 'Data de Início do Contrato:',
                status: 'Status:',
                lastContactDate: 'Último Contato:',
                notes: 'Observações:'
            };

            const tempParsedData = {};
            let currentField = null;

            // Tentativa de identificar campos e seus valores
            lines.forEach(line => {
                let foundMatch = false;
                for (const key in fieldLabels) {
                    const label = fieldLabels[key];
                    const labelRegex = new RegExp(`^${label}\\s*(.*)`, 'i');
                    const match = line.match(labelRegex);
                    if (match) {
                        tempParsedData[key] = match[1].trim();
                        currentField = key;
                        foundMatch = true;
                        break;
                    }
                }
                // Se não encontrou um rótulo, tenta inferir com base no conteúdo
                if (!foundMatch) {
                    if (line.includes('@') && !tempParsedData.email) {
                        tempParsedData.email = line;
                    } else if (/\b(?:\(?\d{2}\)?[\s.-]?)?\d{4,5}[-\s.]?\d{4}\b/.test(line) && !tempParsedData.phone) {
                        tempParsedData.phone = line;
                    } else if (/(?:https?:\/\/|www\.)/.test(line) && !tempParsedData.website) {
                        tempParsedData.website = line;
                    } else if (/\b(\d{4}-\d{2}-\d{2})\b|\b(\d{2}\/\d{2}\/\d{4})\b/.test(line) && !tempParsedData.firstContactDate) {
                        // Prioriza YYYY-MM-DD
                        let dateMatch = line.match(/\b(\d{4}-\d{2}-\d{2})\b/);
                        if (dateMatch) {
                            tempParsedData.firstContactDate = dateMatch[1];
                        } else {
                            dateMatch = line.match(/\b(\d{2}\/\d{2}\/\d{4})\b/);
                            if (dateMatch) {
                                const parts = dateMatch[1].split('/');
                                tempParsedData.firstContactDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                            }
                        }
                    } else if (/\b(\d{2}:\d{2})\b/.test(line) && !tempParsedData.freeConsultationTime) {
                        tempParsedData.freeConsultationTime = line.match(/\b(\d{2}:\d{2})\b/)[1];
                    } else if (line.toLowerCase().includes('empresa') && !tempParsedData.companyName) {
                        tempParsedData.companyName = line;
                    } else if (line.toLowerCase().includes('contato') && !tempParsedData.contactName) {
                        tempParsedData.contactName = line;
                    } else if (line.toLowerCase().includes('endereço') || line.toLowerCase().includes('rua') || line.toLowerCase().includes('avenida') && !tempParsedData.address) {
                        tempParsedData.address = line;
                    } else {
                        // Se não for nenhum dos acima, adiciona às notas ou ao campo atual
                        if (currentField && !tempParsedData[currentField]) {
                            tempParsedData[currentField] = line;
                        } else if (!tempParsedData.notes) {
                            tempParsedData.notes = line;
                        } else {
                            tempParsedData.notes += '\n' + line;
                        }
                    }
                }
            });

            // Reconstroi o texto com a formatação desejada
            for (const key in fieldLabels) {
                if (tempParsedData[key]) {
                    formattedText.push(`${fieldLabels[key]} ${tempParsedData[key]}`);
                }
            }

            rawDataInput.value = formattedText.join('\n');
            showMessage('Dados formatados com sucesso!', 'success');
            console.log("[formatDataButton] Dados formatados.");
        });

        // Função principal para inicializar Firebase e autenticação
        async function initializeFirebaseAndAuth() {
            console.log("--- Iniciando initializeFirebaseAndAuth ---");

            // Define a configuração do Firebase (API Key e outros detalhes)
            let firebaseConfig;
            let currentAppId;

            const defaultFirebaseConfig = {
                apiKey: "AIzaSyABjUhnHsga9jPyl0Vz57BLam06j8a0KYY",
                authDomain: "crm-vizione-firestore.firebaseapp.com",
                projectId: "crm-vizione-firestore",
                storageBucket: "crm-vizione-firestore.firebasestorage.app",
                messagingSenderId: "232305324276",
                appId: "1:232305324276:web:5bd26e12569449bb5eeea1"
            };

            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                    currentAppId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                    console.log("[initializeFirebaseAndAuth] Usando configuração Firebase do Canvas.");
                } catch (e) {
                    console.error("[initializeFirebaseAndAuth] Erro ao analisar __firebase_config do Canvas:", e);
                    firebaseConfig = defaultFirebaseConfig;
                    currentAppId = firebaseConfig.projectId;
                    console.log("[initializeFirebaseAndAuth] Fallback para configuração Firebase padrão devido a erro de análise do Canvas.");
                }
            } else {
                firebaseConfig = defaultFirebaseConfig;
                currentAppId = firebaseConfig.projectId;
                console.log("[initializeFirebaseAndAuth] Usando configuração Firebase padrão (fora do Canvas).");
            }

            appId = currentAppId;
            console.log("[initializeFirebaseAndAuth] App ID definido como:", appId);

            try {
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    console.log("[initializeFirebaseAndAuth] Aplicativo Firebase inicializado com sucesso.");
                } else {
                    firebaseApp = firebase.app();
                    console.log("[initializeFirebaseAndAuth] Aplicativo Firebase já inicializado, obtendo instância existente.");
                }
                db = firebase.firestore();
                auth = firebase.auth();
                console.log("[initializeFirebaseAndAuth] Instâncias Firestore e Auth obtidas com sucesso.");

                // *** Adição para persistência da sessão ***
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .then(() => {
                        console.log("[initializeFirebaseAndAuth] Persistência de autenticação definida para LOCAL.");
                    })
                    .catch((error) => {
                        console.error("[initializeFirebaseAndAuth] Erro ao definir persistência de autenticação:", error);
                        showMessage('Erro ao configurar persistência de login. Alguns recursos podem não funcionar.', 'error');
                    });

                // Ouve as mudanças no estado de autenticação
                auth.onAuthStateChanged(async (user) => {
                    console.log(`[onAuthStateChanged] Estado de autenticação alterado. Usuário: ${user ? user.uid : "null"}`);
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        addClientButton.disabled = false; // Habilita o botão de adicionar
                        console.log("[onAuthStateChanged] Usuário autenticado:", userId);
                        console.log("[onAuthStateChanged] auth.currentUser.metadata:", auth.currentUser.metadata); // Log de metadados do usuário
                        await fetchClients(); // Garante que os clientes sejam buscados somente após a autenticação estar pronta
                    } else {
                        // Se nenhum usuário, tenta fazer login
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                console.log("[onAuthStateChanged] Tentando fazer login com token personalizado do Canvas...");
                                await auth.signInWithCustomToken(__initial_auth_token);
                                console.log("[onAuthStateChanged] signInWithCustomToken chamado.");
                            } else {
                                console.log("[onAuthStateChanged] Tentando fazer login anonimamente...");
                                await auth.signInAnonymously();
                                console.log("[onAuthStateChanged] signInAnonymously chamado.");
                            }
                        } catch (error) {
                            console.error("[onAuthStateChanged] Erro durante a tentativa de login:", error);
                            let errorMessage = 'Erro ao autenticar. Verifique sua conexão ou permissões.';
                            if (error.code === 'auth/admin-restricted-operation') {
                                errorMessage = 'Erro de autenticação: A autenticação anônima pode não estar ativada no seu projeto Firebase ou há um problema com o token de inicialização. Verifique as configurações.';
                            } else if (error.code === 'auth/invalid-custom-token') {
                                errorMessage = 'Erro de autenticação: O token de inicialização é inválido. Tente novamente ou verifique as configurações do Canvas.';
                            }
                            showMessage(errorMessage, 'error');
                            addClientButton.disabled = true;
                            clientTableBody.innerHTML = `<tr><td colspan="16" class="px-6 py-4 text-center text-red-500">Falha na autenticação. Não foi possível carregar os dados.</td></tr>`;
                            isAuthReady = false;
                        }
                    }
                    console.log("--- Fim de onAuthStateChanged ---");
                });

            } catch (error) {
                console.error("[initializeFirebaseAndAuth] Erro crítico ao inicializar o Firebase ou obter instâncias:", error);
                showMessage('Erro crítico ao inicializar o Firebase. Verifique o console para detalhes.', 'error');
                document.getElementById('addClientButton').disabled = true;
                document.getElementById('updateClientButton').disabled = true;
                document.getElementById('deleteClientButton').disabled = true;
                isAuthReady = false;
            }
            console.log("--- Fim de initializeFirebaseAndAuth ---");
        }

        // Chama a função de inicialização quando a janela carrega
        window.onload = () => {
            initializeFirebaseAndAuth();
            initializeSpeechRecognition(); // Inicializa o reconhecimento de fala
        };

        // Adiciona um listener de clique ao corpo do documento para fechar edições rápidas
        document.body.addEventListener('click', (event) => {
            if (activeQuickEditElement && !activeQuickEditElement.contains(event.target)) {
                deactivateQuickEdit(activeQuickEditElement);
            }
        });
    </script>
</body>
</html>
