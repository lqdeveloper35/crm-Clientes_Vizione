<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM de Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-gray-50, similar ao Google Ads */
            color: #1f2937; /* Texto cinza escuro padrão */
        }
        /* Estilo para o spinner de carregamento */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para o modo de edição do formulário */
        .edit-mode-border {
            border: 2px solid #3b82f6; /* Borda azul para indicar modo de edição */
        }
        /* Estilos para campos de edição rápida na tabela */
        .quick-edit-container {
            display: flex;
            align-items: center;
            gap: 4px; /* Espaçamento entre o input e o botão */
        }
        .quick-edit-input {
            width: calc(100% - 40px); /* Ajusta largura para o botão */
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.875rem; /* text-sm */
            background-color: #f0f4f8; /* Um cinza claro para destacar */
        }
        .quick-edit-btn {
            background-color: #10b981; /* Verde */
            color: white;
            padding: 4px 8px;
            border: none; /* Remove borda padrão */
            border-radius: 4px;
            font-size: 0.75rem; /* text-xs */
            cursor: pointer;
            flex-shrink: 0; /* Não encolhe o botão */
        }
        .quick-edit-btn:hover {
            background-color: #059669; /* Verde mais escuro */
        }
        /* Estilos para a barra de mensagens fixa */
        #messageBox {
            position: fixed !important; /* Força a posição fixa */
            bottom: 20px !important;
            right: 20px !important;
            z-index: 1000 !important;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #333 !important; /* Fundo escuro para destacar */
            color: white !important; /* Texto branco */
            padding: 10px 15px; /* Mais padding para ser visível */
            border-radius: 8px; /* Cantos arredondados */
        }
    </style>
</head>
<body class="p-4 bg-gray-50 min-h-screen flex items-center justify-center text-gray-900">
    
    <div id="crmApp" class="container mx-auto p-6 bg-white rounded-xl shadow-lg max-w-4xl w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Cadastro de Clientes CRM</h1>

        <div class="mb-8 p-6 bg-white rounded-lg border border-gray-200">
            <label for="rawDataInput" class="block text-lg font-semibold text-gray-700 mb-3">
                Cole os dados do Google Meu Negócio aqui:
            </label>
            <textarea id="rawDataInput" rows="8"
                      class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900 placeholder-gray-400"
                      placeholder="Ex: Nome da Empresa: Minha Loja Ltda.&#10;Telefone: (11) 98765-4321&#10;Site: www.minhaloja.com.br&#10;Endereço: Rua Exemplo, 123, Centro, Cidade - SP&#10;Email: contato@minhaloja.com.br&#10;Status: Novo&#10;Último Contato: 2023-05-15"></textarea>
            <button id="fillFormButton"
                    class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                Preencher Formulário
            </button>
        </div>

        <div id="clientDetailsContainer" class="mb-8 p-6 bg-white rounded-xl border border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Detalhes do Cliente</h2>
            <form id="clientForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa:</label>
                    <input type="text" id="companyName"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone:</label>
                    <input type="text" id="phone"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                    <input type="email" id="email"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="website" class="block text-sm font-medium text-gray-700 mb-1">Site:</label>
                    <input type="url" id="website"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="md:col-span-2">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Endereço:</label>
                    <input type="text" id="address"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                    <select id="status"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                        <option value="Novo">Novo</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Fechado">Fechado</option>
                        <option value="Perdido">Perdido</option>
                    </select>
                </div>
                <div>
                    <label for="lastContactDate" class="block text-sm font-medium text-gray-700 mb-1">Data Último Contato:</label>
                    <input type="date" id="lastContactDate"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="md:col-span-2">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Observações:</label>
                    <textarea id="notes" rows="4"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900"></textarea>
                </div>
            </form>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="addClientButton"
                        class="w-1/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                    Cadastrar Cliente
                    <span id="loadingSpinner" class="loading-spinner hidden"></span>
                </button>
                <button id="updateClientButton" 
                        class="w-1/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md" disabled> Atualizar Cadastro
                    <span id="updateLoadingSpinner" class="loading-spinner hidden"></span>
                </button>
                <button id="cancelEditButton" 
                        class="w-auto bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                    Cancelar Edição
                </button>
            </div>
        </div>

        <div class="p-6 bg-white rounded-lg border border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Clientes Cadastrados</h2>

            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200 flex flex-wrap items-end gap-4">
                <div class="flex-1 min-w-[150px]">
                    <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Status:</label>
                    <select id="filterStatus"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                        <option value="">Todos</option>
                        <option value="Novo">Novo</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Fechado">Fechado</option>
                        <option value="Perdido">Perdido</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label for="filterDateFrom" class="block text-sm font-medium text-gray-700 mb-1">Último Contato De:</label>
                    <input type="date" id="filterDateFrom"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label for="filterDateTo" class="block text-sm font-medium text-gray-700 mb-1">Último Contato Até:</label>
                    <input type="date" id="filterDateTo"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="flex-none">
                    <button id="applyFiltersButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">
                        Aplicar Filtros
                    </button>
                </div>
                <div class="flex-none">
                    <button id="clearFiltersButton"
                            class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">
                        Limpar Filtros
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label for="generalSearchInput" class="block text-lg font-semibold text-gray-700 mb-3">Pesquisa Geral:</label>
                <div class="flex gap-4">
                    <input type="text" id="generalSearchInput" placeholder="Pesquisar por nome, telefone, email, etc."
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                    <button id="searchButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">
                        Pesquisar
                    </button>
                </div>
            </div>

            <div class="mb-4 text-right flex justify-end space-x-2">
                <button id="exportExcelButton"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">
                    Exportar para Excel
                </button>
                <button id="deleteClientButton"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md" disabled>
                    Excluir Cliente
                    <span id="deleteLoadingSpinner" class="loading-spinner hidden"></span>
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table id="clientTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider rounded-tl-lg">Nome da Empresa</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Telefone</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Site</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Endereço</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Último Contato</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider rounded-tr-lg">Observações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="clientTableBody">
                        </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-4 space-x-4">
                <button id="prevPageButton"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md" disabled>
                    Página Anterior
                </button>
                <button id="nextPageButton"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md" disabled>
                    Próxima Página
                </button>
            </div>
            <div id="messageBox" class="hidden mt-4 p-3 text-center text-sm rounded-lg" role="alert"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyABjUhnHsga9jPyl0Vz57BLam06j8a0KYY",
            authDomain: "crm-vizione-firestore.firebaseapp.com",
            projectId: "crm-vizione-firestore",
            storageBucket: "crm-vizione-firestore.firebasestorage.app",
            messagingSenderId: "232305324276",
            appId: "1:232305324276:web:5bd26e12569449bb5eeea1"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); 
        }
        
        const db = firebase.firestore();

        const CLIENTES_POR_PAGINA = 10; // Define quantos clientes por página
        let clients = []; // Clientes atualmente exibidos na tabela (apenas da página atual)
        let lastVisibleDoc = null; // Último documento da página atual para 'next'
        let firstVisibleDoc = null; // Primeiro documento da página atual para 'prev'
        let paginationHistory = []; // Histórico de documentos de início de página
        let currentPage = 0; // Índice da página atual (0-based)


        let editingClientId = null; 

        const rawDataInput = document.getElementById('rawDataInput');
        const fillFormButton = document.getElementById('fillFormButton');
        const clientForm = document.getElementById('clientForm');
        const addClientButton = document.getElementById('addClientButton');
        const updateClientButton = document.getElementById('updateClientButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const clientTableBody = document.getElementById('clientTableBody');
        const messageBox = document.getElementById('messageBox');
        const exportExcelButton = document.getElementById('exportExcelButton');
        const deleteClientButton = document.getElementById('deleteClientButton'); 
        const loadingSpinner = document.getElementById('loadingSpinner'); 
        const updateLoadingSpinner = document.getElementById('updateLoadingSpinner');
        const deleteLoadingSpinner = document.getElementById('deleteLoadingSpinner');

        const clientDetailsContainer = document.getElementById('clientDetailsContainer');


        const companyNameField = document.getElementById('companyName');
        const phoneField = document.getElementById('phone');
        const emailField = document.getElementById('email');
        const websiteField = document.getElementById('website');
        const addressField = document.getElementById('address');
        const statusField = document.getElementById('status');
        const lastContactDateField = document.getElementById('lastContactDate');
        const notesField = document.getElementById('notes');

        const filterStatusField = document.getElementById('filterStatus');
        const filterDateFromField = document.getElementById('filterDateFrom');
        const filterDateToField = document.getElementById('filterDateTo');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const generalSearchInput = document.getElementById('generalSearchInput'); 
        const searchButton = document.getElementById('searchButton'); 
        const prevPageButton = document.getElementById('prevPageButton'); 
        const nextPageButton = document.getElementById('nextPageButton'); 


        function showMessage(message, type, targetBox = messageBox) {
            targetBox.textContent = message;
            targetBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            if (type === 'success') {
                targetBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                targetBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                targetBox.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            targetBox.classList.remove('hidden');
            setTimeout(() => {
                targetBox.classList.add('hidden');
            }, 3000);
        }

        function clearForm() {
            companyNameField.value = '';
            phoneField.value = '';
            emailField.value = '';
            websiteField.value = '';
            addressField.value = '';
            statusField.value = 'Novo';
            lastContactDateField.value = '';
            notesField.value = '';
            editingClientId = null; 
            
            updateClientButton.disabled = true; 
            deleteClientButton.disabled = true; 
            clientDetailsContainer.classList.remove('edit-mode-border');
        }

        function fillForm(client) {
            companyNameField.value = client.companyName || '';
            phoneField.value = client.phone || '';
            emailField.value = client.email || '';
            websiteField.value = client.website || '';
            addressField.value = client.address || '';
            statusField.value = client.status || 'Novo';
            if (client.lastContactDate && client.lastContactDate.toDate) {
                lastContactDateField.value = client.lastContactDate.toDate().toISOString().split('T')[0];
            } else {
                lastContactDateField.value = '';
            }
            notesField.value = client.notes || '';
            editingClientId = client.id; 

            updateClientButton.disabled = false; 
            deleteClientButton.disabled = false; 
            clientDetailsContainer.classList.add('edit-mode-border');
        }

        function parseRawData(rawText) {
            const data = {};
            const companyNameMatch = rawText.match(/(?:Nome da Empresa:|Empresa:)\s*([^\n]+)/i) || rawText.match(/^([^\n]+)/);
            if (companyNameMatch) {
                data.companyName = companyNameMatch[1].trim();
            }
            const phoneMatch = rawText.match(/(?:\(?\d{2}\)?\s*\d{4,5}[-\s]?\d{4}|\+\d{2}\s*\d{2}\s*\d{4,5}[-\s]?\d{4})/);
            if (phoneMatch) {
                data.phone = phoneMatch[0].trim();
            }
            const emailMatch = rawText.match(/[\w\.-]+@[\w\.-]+\.\w+/);
            if (emailMatch) {
                data.email = emailMatch[0].trim();
            }
            const websiteMatch = rawText.match(/(?:https?:\/\/)?(?:www\.)?([a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+(?:\/[^\s]*)?)/);
            if (websiteMatch) {
                data.website = websiteMatch[0].trim();
                if (!data.website.startsWith('http://') && !data.website.startsWith('https://')) {
                    data.website = 'http://' + data.website;
                }
            }
            const addressMatch = rawText.match(/(?:Endereço:|Rua|Av\.|Avenida|Travessa|Praça)\s*([^\n]+(?:,\s*\d+)?(?:,\s*[^\n]+)?(?:-\s*[^\n]+)?(?:,\s*CEP\s*\d{5}-?\d{3})?)/i);
            if (addressMatch) {
                data.address = addressMatch[0].trim();
            } else {
                const genericAddressMatch = rawText.match(/(\d{1,5}\s+[A-Za-z\s]+\s+(?:Rua|Av\.|Avenida|Travessa|Praça|Bairro|Centro|Cidade|Estado)[^\n]*)/i);
                if (genericAddressMatch) {
                    data.address = genericAddressMatch[0].trim();
                }
            }
            const statusMatch = rawText.match(/(?:Status:)\s*(Novo|Em Andamento|Aguardando Contato|Fechado|Perdido)/i);
            if (statusMatch) {
                data.status = statusMatch[1].charAt(0).toUpperCase() + statusMatch[1].slice(1).toLowerCase();
                const validStatuses = ['Novo', 'Em Andamento', 'Aguardando Contato', 'Fechado', 'Perdido'];
                if (!validStatuses.includes(data.status)) {
                    data.status = 'Novo';
                }
            } else {
                data.status = 'Novo';
            }
            const lastContactDateMatch = rawText.match(/(?:Último Contato:|Data Contato:)\s*(\d{4}-\d{2}-\d{2})/i);
            if (lastContactDateMatch) {
                data.lastContactDate = lastContactDateMatch[1].trim();
            }
            let notes = rawText;
            for (const key in data) {
                if (data[key]) {
                    notes = notes.replace(new RegExp(data[key].replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi'), '').trim();
                }
            }
            data.notes = notes.replace(/\s{2,}/g, ' ').trim();
            return data;
        }

        async function loadClientsFromFirestore(direction = 'current') {
            let scrollPosition = clientTableBody.parentElement.scrollTop;
            clients = []; 
            try {
                let clientsRef = db.collection("clientes");

                const filterStatus = filterStatusField.value;
                const filterDateFrom = filterDateFromField.value;
                const filterDateTo = filterDateToField.value;
                const generalSearchTerm = generalSearchInput.value.trim().toLowerCase(); 

                // Aplicar filtros do Firestore
                if (filterStatus) {
                    clientsRef = clientsRef.where('status', '==', filterStatus);
                }
                if (filterDateFrom) {
                    const dateFrom = new Date(filterDateFrom + 'T00:00:00'); 
                    clientsRef = clientsRef.where('lastContactDate', '>=', dateFrom);
                }
                if (filterDateTo) {
                    const dateTo = new Date(filterDateTo + 'T23:59:59'); 
                    clientsRef = clientsRef.where('lastContactDate', '<=', dateTo);
                }

                // Definir ordenação para a consulta do Firestore
                if (filterDateFrom || filterDateTo) {
                    clientsRef = clientsRef.orderBy('lastContactDate', 'asc'); 
                    clientsRef = clientsRef.orderBy('createdAt', 'desc');     
                } else {
                    clientsRef = clientsRef.orderBy('createdAt', 'desc'); 
                }

                // Lógica de Paginação do Firestore
                let query;
                if (direction === 'next' && lastVisibleDoc) {
                    query = clientsRef.startAfter(lastVisibleDoc).limit(CLIENTES_POR_PAGINA);
                } else if (direction === 'prev' && firstVisibleDoc && paginationHistory.length > 1) {
                    // Remove o último doc de início da história (que é a página atual)
                    paginationHistory.pop(); 
                    // Pega o doc de início da página anterior
                    const prevStartDoc = paginationHistory[paginationHistory.length - 1];
                    query = clientsRef.startAt(prevStartDoc).limit(CLIENTES_POR_PAGINA);
                } else {
                    // Primeira carga ou reset de filtros
                    paginationHistory = []; // Limpa histórico
                    query = clientsRef.limit(CLIENTES_POR_PAGINA);
                }
                
                const querySnapshot = await query.get();

                // Extrair clientes e salvar referências de documentos
                let fetchedClients = [];
                querySnapshot.forEach(doc => {
                    fetchedClients.push({ id: doc.id, ...doc.data(), docRef: doc }); // Guarda a referência do documento
                });

                // Atualizar lastVisibleDoc e firstVisibleDoc
                if (fetchedClients.length > 0) {
                    firstVisibleDoc = fetchedClients[0].docRef;
                    lastVisibleDoc = fetchedClients[fetchedClients.length - 1].docRef;
                    if (direction !== 'prev' && direction !== 'next') { // Se for a primeira carga ou reset, adiciona ao histórico
                        paginationHistory.push(firstVisibleDoc);
                    } else if (direction === 'next') { // Se for next, adiciona o novo lastVisibleDoc ao histórico
                        paginationHistory.push(firstVisibleDoc); // Adiciona o primeiro doc da página atual como início da próxima
                    }
                } else {
                    firstVisibleDoc = null;
                    lastVisibleDoc = null;
                }


                // Filtragem Geral no lado do cliente (para o campo de pesquisa geral)
                let clientsToRender = []; 
                if (generalSearchTerm) {
                    fetchedClients.forEach(clientData => {
                        // Converte Timestamps para objetos Date para facilitar a formatação na busca
                        if (clientData.createdAt && clientData.createdAt.toDate) {
                            clientData.createdAt = clientData.createdAt.toDate();
                        }
                        if (clientData.lastContactDate && clientData.lastContactDate.toDate) {
                            clientData.lastContactDate = clientData.lastContactDate.toDate();
                        }
                        
                        const searchableFields = [
                            clientData.companyName,
                            clientData.phone,
                            clientData.email,
                            clientData.website,
                            clientData.address,
                            clientData.notes,
                            clientData.status 
                        ].filter(Boolean).map(field => String(field).toLowerCase()); 

                        const formattedDateText = (clientData.lastContactDate) ? clientData.lastContactDate.toLocaleDateString('pt-BR').toLowerCase() : '';
                        searchableFields.push(formattedDateText);

                        if (searchableFields.some(field => field.includes(generalSearchTerm))) {
                            clientsToRender.push(clientData);
                        }
                    });
                } else {
                    clientsToRender = fetchedClients; // Se não há termo de pesquisa geral, usa os clientes do Firestore
                }

                clients = clientsToRender; 
                renderClientTable();
                updatePaginationButtons(); 
                clientTableBody.parentElement.scrollTop = scrollPosition; 
                showMessage('Clientes carregados e filtrados/pesquisados com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao carregar clientes do Firestore: ", error);
                showMessage('Erro ao carregar clientes. Verifique as regras de segurança do Firestore e os índices do Firestore (se estiver usando filtros de data ou múltiplos filtros).', 'error');
            }
        }

        function renderClientTable() {
            clientTableBody.innerHTML = '';
            if (clients.length === 0) {
                clientTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Nenhum cliente cadastrado ainda.</td></tr>`;
                return;
            }

            clients.forEach((client, index) => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'cursor-pointer', 'transition', 'duration-150', 'ease-in-out');
                row.dataset.index = index;
                row.dataset.id = client.id;

                let formattedLastContactDate = '';
                // Verificação robusta para lastContactDate
                if (client.lastContactDate instanceof Date) {
                    formattedLastContactDate = client.lastContactDate.toLocaleDateString('pt-BR');
                } else if (client.lastContactDate && typeof client.lastContactDate.toDate === 'function') {
                    formattedLastContactDate = client.lastContactDate.toDate().toLocaleDateString('pt-BR');
                } else if (typeof client.lastContactDate === 'string') {
                    const date = new Date(client.lastContactDate);
                    if (!isNaN(date.getTime())) {
                        formattedLastContactDate = date.toLocaleDateString('pt-BR');
                    }
                }
                // Fim da verificação robusta

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 rounded-bl-lg">${client.companyName || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${client.phone || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${client.email || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${client.website || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${client.address || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 quick-edit-status" data-field="status" data-value="${client.status || 'Novo'}">${client.status || 'Novo'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 quick-edit-date" data-field="lastContactDate" data-value="${client.lastContactDate ? (client.lastContactDate instanceof Date ? client.lastContactDate.toISOString().split('T')[0] : (typeof client.lastContactDate.toDate === 'function' ? client.lastContactDate.toDate().toISOString().split('T')[0] : '')) : ''}">${formattedLastContactDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 rounded-br-lg">${client.notes || ''}</td>
                `;
                clientTableBody.appendChild(row);
            });
        }

        function exportToExcel() {
            if (clients.length === 0) {
                showMessage('Não há clientes para exportar.', 'info');
                return;
            }
            const headers = [
                "Nome da Empresa", "Telefone", "Email", "Site", "Endereço", "Status", "Último Contato", "Observações"
            ];
            const data = clients.map(client => [
                client.companyName,
                client.phone,
                client.email,
                client.website,
                client.address,
                client.status,
                (client.lastContactDate && (client.lastContactDate instanceof Date || typeof client.lastContactDate.toDate === 'function')) ? (client.lastContactDate instanceof Date ? client.lastContactDate.toLocaleDateString('pt-BR') : client.lastContactDate.toDate().toLocaleDateString('pt-BR')) : '', 
                client.notes
            ]);
            const wsData = [headers, ...data];
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Clientes CRM");
            XLSX.writeFile(wb, "clientes_crm.xlsx");
            showMessage('Dados exportados para "clientes_crm.xlsx" com sucesso!', 'success');
        }

        fillFormButton.addEventListener('click', () => {
            const rawText = rawDataInput.value;
            if (rawText.trim() === '') {
                showMessage('Cole os dados brutos para preencher o formulário.', 'info');
                return;
            }
            const parsedData = parseRawData(rawText);
            clearForm(); 
            fillForm(parsedData);
            showMessage('Formulário preenchido com sucesso!', 'success');
        });

        addClientButton.addEventListener('click', async () => {
            const clientData = {
                companyName: companyNameField.value.trim(),
                phone: phoneField.value.trim(),
                email: emailField.value.trim(),
                website: websiteField.value.trim(),
                address: addressField.value.trim(),
                status: statusField.value,
                notes: notesField.value.trim(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (lastContactDateField.value) {
                clientData.lastContactDate = new Date(lastContactDateField.value + 'T00:00:00');
            } else {
                clientData.lastContactDate = firebase.firestore.FieldValue.serverTimestamp(); 
            }


            if (!clientData.companyName) {
                showMessage('O nome da empresa é obrigatório para cadastrar o cliente.', 'error');
                return;
            }

            addClientButton.disabled = true;
            loadingSpinner.classList.remove('hidden');

            try {
                let isDuplicate = false;

                const companyNameQuery = db.collection("clientes").where("companyName", "==", clientData.companyName);
                const companyNameSnapshot = await companyNameQuery.get();
                if (!companyNameSnapshot.empty) {
                    isDuplicate = true;
                }

                if (!isDuplicate && clientData.phone) {
                    const phoneQuery = db.collection("clientes").where("phone", "==", clientData.phone);
                    const phoneSnapshot = await phoneQuery.get();
                    if (!phoneSnapshot.empty) {
                        isDuplicate = true;
                    }
                }

                if (!isDuplicate && clientData.email) {
                    const emailQuery = db.collection("clientes").where("email", "==", clientData.email);
                    const emailSnapshot = await emailQuery.get();
                    if (!emailSnapshot.empty) {
                        isDuplicate = true;
                    }
                }

                if (isDuplicate) {
                    showMessage('Cliente já cadastrado na base de dados (Nome da Empresa, Telefone ou Email duplicado).', 'info');
                    addClientButton.disabled = false;
                    loadingSpinner.classList.add('hidden');
                    return; 
                }

                const docRef = await db.collection("clientes").add(clientData);
                
                currentPage = 0; // Ao adicionar um novo cliente, volta para a primeira página
                await loadClientsFromFirestore(); 
                clearForm();
                rawDataInput.value = '';
                showMessage('Cliente cadastrado e salvo no Firestore com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao adicionar documento no Firestore:', error);
                showMessage(`Erro ao cadastrar cliente no Firestore: ${error.message}. Verifique as regras de segurança do Firestore.`, 'error');
            } finally {
                addClientButton.disabled = false;
                loadingSpinner.classList.add('hidden');
            }
        });

        updateClientButton.addEventListener('click', async () => {
            if (!editingClientId) {
                showMessage('Nenhum cliente selecionado para atualizar.', 'info');
                return;
            }

            const updatedClientData = {
                companyName: companyNameField.value.trim(),
                phone: phoneField.value.trim(),
                email: emailField.value.trim(),
                website: websiteField.value.trim(),
                address: addressField.value.trim(),
                status: statusField.value,
                notes: notesField.value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
            };

            if (lastContactDateField.value) {
                updatedClientData.lastContactDate = new Date(lastContactDateField.value + 'T00:00:00');
            } else {
                updatedClientData.lastContactDate = firebase.firestore.FieldValue.serverTimestamp(); 
            }

            if (!updatedClientData.companyName) {
                showMessage('O nome da empresa é obrigatório para atualizar o cliente.', 'error');
                return;
            }

            updateClientButton.disabled = true;
            updateLoadingSpinner.classList.remove('hidden');

            try {
                await db.collection("clientes").doc(editingClientId).update(updatedClientData);

                await loadClientsFromFirestore();
                clearForm();
                showMessage('Cliente atualizado no Firestore com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao atualizar documento no Firestore:', error);
                showMessage(`Erro ao atualizar cliente no Firestore: ${error.message}. Verifique as regras de segurança.`, 'error');
            } finally {
                updateClientButton.disabled = false;
                updateLoadingSpinner.classList.add('hidden');
            }
        });

        cancelEditButton.addEventListener('click', () => {
            clearForm();
            showMessage('Edição cancelada. Formulário limpo.', 'info');
        });

        clientTableBody.addEventListener('click', (event) => {
            const clickedCell = event.target.closest('td');
            const row = clickedCell ? clickedCell.closest('tr') : null;

            if (!row) return;

            const clientId = row.dataset.id;
            const field = clickedCell ? clickedCell.dataset.field : null;
            const clientData = clients.find(c => c.id === clientId);

            if (!clientData) return;

            if (clickedCell && (clickedCell.classList.contains('quick-edit-status') || clickedCell.classList.contains('quick-edit-date'))) {
                event.stopPropagation();

                if (clickedCell.querySelector('.quick-edit-input')) {
                    return;
                }

                const originalCellContent = clickedCell.innerHTML;

                let inputElement;
                let saveButton = document.createElement('button');
                saveButton.classList.add('quick-edit-btn');
                saveButton.textContent = 'Salvar';

                let cancelButton = document.createElement('button');
                cancelButton.classList.add('quick-edit-btn');
                cancelButton.style.backgroundColor = '#ef4444';
                cancelButton.textContent = 'X';

                let containerDiv = document.createElement('div');
                containerDiv.classList.add('quick-edit-container');

                if (clickedCell.classList.contains('quick-edit-status')) {
                    inputElement = document.createElement('select');
                    inputElement.classList.add('quick-edit-input');
                    inputElement.innerHTML = `
                        <option value="Novo">Novo</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Fechado">Fechado</option>
                        <option value="Perdido">Perdido</option>
                    </select>
                    `;
                    inputElement.value = clientData.status || 'Novo';
                } else if (clickedCell.classList.contains('quick-edit-date')) {
                    inputElement = document.createElement('input');
                    inputElement.type = 'date';
                    inputElement.classList.add('quick-edit-input');
                    if (clientData.lastContactDate && clientData.lastContactDate.toISOString) {
                        inputElement.value = clientData.lastContactDate.toISOString().split('T')[0];
                    } else {
                        inputElement.value = '';
                    }
                }

                containerDiv.appendChild(inputElement);
                containerDiv.appendChild(saveButton);
                containerDiv.appendChild(cancelButton);

                clickedCell.innerHTML = ''; 
                clickedCell.appendChild(containerDiv); 
                inputElement.focus();

                saveButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await updateQuickEditField(clientId, field, inputElement.value);
                });

                cancelButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    clickedCell.innerHTML = originalCellContent; 
                });

                inputElement.addEventListener('blur', () => {
                    if (clickedCell.contains(inputElement)) {
                        clickedCell.innerHTML = originalCellContent;
                    }
                });
                
                inputElement.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); 
                        await updateQuickEditField(clientId, field, inputElement.value);
                    } else if (e.key === 'Escape') { 
                        e.preventDefault();
                        clickedCell.innerHTML = originalCellContent;
                    }
                });

            } else {
                fillForm(clientData);
                showMessage(`Dados de "${clientData.companyName}" carregados para edição.`, 'info');
            }
        });

        async function updateQuickEditField(clientId, field, newValue) {
            let initialScrollTop = clientTableBody.parentElement.scrollTop; 
            try {
                let updateData = {};
                if (field === 'lastContactDate') {
                    updateData[field] = newValue ? new Date(newValue + 'T00:00:00') : firebase.firestore.FieldValue.serverTimestamp(); 
                } else {
                    updateData[field] = newValue;
                }
                updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp(); 

                await db.collection("clientes").doc(clientId).update(updateData);
                showMessage('Campo atualizado com sucesso!', 'success');
                await loadClientsFromFirestore(); 
                clientTableBody.parentElement.scrollTop = initialScrollTop; 
            } catch (error) {
                console.error(`Erro ao atualizar campo ${field} no Firestore:`, error);
                showMessage(`Erro ao atualizar campo: ${error.message}`, 'error');
                await loadClientsFromFirestore(); 
                clientTableBody.parentElement.scrollTop = initialScrollTop; 
            }
        }

        exportExcelButton.addEventListener('click', exportToExcel);

        deleteClientButton.addEventListener('click', async () => {
            if (!editingClientId) {
                showMessage('Selecione um cliente na tabela primeiro para excluí-lo.', 'info');
                return;
            }

            deleteClientButton.disabled = true;
            deleteLoadingSpinner.classList.remove('hidden');

            try {
                await db.collection("clientes").doc(editingClientId).delete();

                currentPage = 0; 
                await loadClientsFromFirestore();
                clearForm(); 
                showMessage('Cliente excluído com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir documento do Firestore:', error);
                showMessage(`Erro ao excluir cliente: ${error.message}. Verifique as regras de segurança do Firestore.`, 'error');
            } finally {
                deleteClientButton.disabled = false;
                deleteLoadingSpinner.classList.add('hidden');
            }
        });

        applyFiltersButton.addEventListener('click', () => {
            currentPage = 0; 
            loadClientsFromFirestore();
        });
        clearFiltersButton.addEventListener('click', () => {
            filterStatusField.value = '';
            filterDateFromField.value = '';
            filterDateToField.value = '';
            generalSearchInput.value = ''; 
            currentPage = 0; 
            loadClientsFromFirestore(); 
            showMessage('Filtros limpos!', 'info');
        });

        searchButton.addEventListener('click', () => {
            currentPage = 0; 
            loadClientsFromFirestore();
        });

        prevPageButton.addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                loadClientsFromFirestore('prev'); 
            }
        });

        nextPageButton.addEventListener('click', () => {
            currentPage++;
            loadClientsFromFirestore('next'); 
        });

        function updatePaginationButtons() {
            prevPageButton.disabled = (currentPage === 0);

            // A lógica para 'nextPageButton' precisa de uma consulta extra para saber se há mais documentos
            // Para evitar uma consulta extra a cada render, vamos desabilitar se a página atual não tiver o número máximo
            // ou se a quantidade de clientes carregados for menor que o limite (indicando que é a última página)
            nextPageButton.disabled = (clients.length < CLIENTES_POR_PAGINA);
            
            // Para uma paginação mais precisa, precisaríamos de uma contagem total de documentos filtrados
            // ou buscar um documento a mais para saber se há uma próxima página.
            // Por enquanto, esta lógica simples funciona se a última página tiver menos que CLIENTES_POR_PAGINA
        }

        document.addEventListener('DOMContentLoaded', loadClientsFromFirestore);
    </script>
</body>
</html>
