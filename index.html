<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM de Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDK - Versão 9.6.0 compat -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* Texto cinza escuro padrão */
            margin: 0; /* Reset margin for full width */
        }
        #crmApp {
            max-width: none !important; /* Override max-w */
            width: 100% !important; /* Ensure full width */
            margin: 0 auto; /* Center if needed */
            padding: 1rem; /* Add some padding around the app */
        }
        @media (min-width: 640px) { /* sm */
            #crmApp {
                padding: 2rem;
            }
        }
        @media (min-width: 768px) { /* md */
            #crmApp {
                padding: 3rem;
            }
        }
        /* Estilo para a coluna fixa */
        #clientTable th:first-child {
            position: sticky;
            left: 0;
            background-color: #f3f4f6; /* Define explicitamente o fundo para o thead fixo */
            z-index: 1; /* Garante que fique acima de outras células durante a rolagem */
            border-right: 1px solid #e5e7eb; /* Opcional: Adiciona uma linha separadora */
        }
        #clientTable td:first-child {
            position: sticky;
            left: 0;
            background-color: #fff; /* Define explicitamente o fundo para as células fixas */
            z-index: 1; /* Garante que fique acima de outras células durante a rolagem */
            border-right: 1px solid #e5e7eb; /* Opcional: Adiciona uma linha separadora */
        }
        /* Adjust padding for visual alignment with the fixed column */
        #clientTable th:not(:first-child),
        #clientTable td:not(:first-child) {
            padding-left: 1rem; /* Adjust as needed */
        }
        /* Estilo para o spinner de carregamento */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para o modo de edição do formulário */
        .edit-mode-border {
            border: 2px solid #3b82f6; /* Borda azul para indicar modo de edição */
        }
        /* Estilos para campos de edição rápida na tabela */
        .quick-edit-container {
            display: flex;
            align-items: center;
            gap: 4px; /* Espaçamento entre o input e o botão */
            flex-wrap: nowrap; /* Impede que os itens quebrem para a próxima linha */
        }
        .quick-edit-input {
            flex-grow: 1; /* Permite que o input cresça para preencher o espaço */
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.75rem; /* text-sm */
            background-color: #f0f4f8; /* Um cinza claro para destacar */
        }
        /* Ajuste específico para o select de status na edição rápida */
        .quick-edit-status .quick-edit-input {
            min-width: 120px; /* Largura mínima para o select de status */
        }

        .quick-edit-btn {
            background-color: #10b981; /* Verde */
            color: white;
            padding: 4px 8px;
            border: none; /* Remove borda padrão */
            border-radius: 4px;
            font-size: 0.625rem; /* text-xs */
            cursor: pointer;
            flex-shrink: 0; /* Não encolhe o botão */
        }
        .quick-edit-btn:hover {
            background-color: #059669; /* Verde mais escuro */
        }
        /* Estilos para a barra de mensagens fixa */
        #messageBox {
            position: fixed !important; /* Força a posição fixa */
            bottom: 20px !important;
            right: 20px !important;
            z-index: 1000 !important;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #333 !important; /* Fundo escuro para destacar */
            color: white !important; /* Texto branco */
            padding: 10px 15px; /* Mais padding para ser visível */
            border-radius: 8px; /* Cantos arredondados */
        }

        /* Novas classes para destaque de linhas */
        .meeting-scheduled-row {
            background-color: #fffbeb; /* bg-amber-100 */
        }
        .contract-signed-row {
            background-color: #dcfce7; /* bg-green-100 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <div id="crmApp" class="bg-white rounded-xl shadow-lg">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 py-6">Cadastro de Clientes CRM</h1>

        <div class="mb-6 p-4 md:p-6 bg-white rounded-lg border border-gray-200">
            <label for="rawDataInput" class="block text-lg font-semibold text-gray-700 mb-3">
                Cole os dados do Google Meu Negócio aqui:
            </label>
            <textarea id="rawDataInput" rows="6" md:rows="8"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900 placeholder-gray-400"
                      placeholder="Ex: Nome da Empresa: Minha Loja Ltda.&#10;Telefone: (11) 98765-4321&#10;Site: www.minhaloja.com.br&#10;Endereço: Rua Exemplo, 123, Centro, Cidade - SP&#10;Email: contato@minhaloja.com.br&#10;Nome de Contato: João Silva&#10;Data de Reunião para Vendas: 2024-07-01&#10;Data de Início do Contrato: 2023-01-15&#10;Status: Novo Contato&#10;Último Contato: 2023-05-15"></textarea>
            <button id="fillFormButton"
                    class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                Preencher Formulário
            </button>
        </div>

        <div id="clientDetailsContainer" class="mb-6 p-4 md:p-6 bg-white rounded-xl border border-gray-200">
            <h2 class="text-xl md:text-2xl font-bold text-center text-gray-800 mb-4 md:mb-6">Detalhes do Cliente</h2>
            <form id="clientForm" class="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-6">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa:</label>
                    <input type="text" id="companyName"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="contactName" class="block text-sm font-medium text-gray-700 mb-1">Nome de Contato:</label>
                    <input type="text" id="contactName"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone:</label>
                    <input type="text" id="phone"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                    <input type="email" id="email"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="website" class="block text-sm font-medium text-gray-700 mb-1">Site:</label>
                    <input type="url" id="website"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="md:col-span-2">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Endereço:</label>
                    <input type="text" id="address"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="salesMeetingDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Reunião para Vendas:</label>
                    <input type="date" id="salesMeetingDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="contractStartDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Início do Contrato:</label>
                    <input type="date" id="contractStartDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                    <select id="status"
                            class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                        <option value="Novo Contato">Novo Contato</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Novo Cliente">Novo Cliente</option>
                        <option value="Perdido">Perdido</option>
                    </select>
                </div>
                <div>
                    <label for="lastContactDate" class="block text-sm font-medium text-gray-700 mb-1">Data Último Contato:</label>
                    <input type="date" id="lastContactDate"
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="md:col-span-2">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Observações:</label>
                    <textarea id="notes" rows="3" md:rows="4"
                              class="w-full p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900"></textarea>
                </div>
            </form>
            <div class="mt-4 md:mt-6 flex justify-center space-x-2 md:space-x-4">
                <button id="addClientButton"
                        class="w-1/2 md:w-1/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center">
                    Cadastrar
                    <span id="loadingSpinner" class="loading-spinner hidden"></span>
                </button>
                <button id="updateClientButton"
                        class="w-1/2 md:w-1/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center" disabled>
                    Atualizar
                    <span id="updateLoadingSpinner" class="loading-spinner hidden"></span>
                </button>
                <button id="cancelEditButton"
                        class="w-full md:w-auto bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                    Cancelar
                </button>
            </div>
        </div>

        <div class="p-4 md:p-6 bg-white rounded-lg border border-gray-200">
            <h2 class="text-xl md:text-2xl font-bold text-center text-gray-800 mb-4 md:mb-6">Clientes Cadastrados</h2>

            <div class="mb-4 p-3 md:p-4 bg-gray-50 rounded-lg border border-gray-200 flex flex-wrap items-end gap-2 md:gap-4">
                <div class="flex-1 min-w-[150px]">
                    <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Status:</label>
                    <select id="filterStatus"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                        <option value="">Todos</option>
                        <option value="Novo Contato">Novo Contato</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Novo Cliente">Novo Cliente</option>
                        <option value="Perdido">Perdido</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label for="filterDateFrom" class="block text-sm font-medium text-gray-700 mb-1">Último Contato De:</label>
                    <input type="date" id="filterDateFrom"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label for="filterDateTo" class="block text-sm font-medium text-gray-700 mb-1">Último Contato Até:</label>
                    <input type="date" id="filterDateTo"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="flex-none mt-2 md:mt-0">
                    <button id="applyFiltersButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                        Aplicar Filtros
                    </button>
                </div>
                <div class="flex-none mt-2 md:mt-0">
                    <button id="clearFiltersButton"
                            class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                        Limpar Filtros
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label for="generalSearchInput" class="block text-lg font-semibold text-gray-700 mb-2">Pesquisa Geral:</label>
                <div class="flex gap-2 md:gap-4">
                    <input type="text" id="generalSearchInput" placeholder="Pesquisar por nome, telefone, email, etc."
                           class="flex-1 p-2 md:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900 text-sm">
                    <button id="searchButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                        Pesquisar
                    </button>
                </div>
            </div>

            <div class="mb-3 md:mb-4 text-right flex justify-end space-x-2">
                <button id="exportExcelButton"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm">
                    Exportar Excel
                </button>
                <button id="deleteClientButton"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm flex items-center justify-center" disabled>
                    Excluir
                    <span id="deleteLoadingSpinner" class="loading-spinner hidden"></span>
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table id="clientTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider rounded-tl-lg">Nome da Empresa</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nome de Contato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider min-w-[120px]">Telefone</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Site</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Endereço</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data Reunião Vendas</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Início Contrato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Tempo de Contrato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider min-w-[120px]">Status</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Último Contato</th>
                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider rounded-tr-lg">Observações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="clientTableBody">
                        </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-3 md:mt-4 space-x-2 md:space-x-4">
                <button id="prevPageButton"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm" disabled>
                    Anterior
                </button>
                <button id="nextPageButton"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 ease-in-out shadow-md text-sm" disabled>
                    Próxima
                </button>
            </div>
            <div id="messageBox" class="hidden mt-2 md:mt-4 p-3 text-center text-sm rounded-lg" role="alert"></div>
        </div>
    </div>

    <script>
        // Define a configuração do Firebase (API Key e outros detalhes)
        // ATENÇÃO: Em um ambiente de produção real, evite expor a API Key diretamente no código frontend.
        // Utilize variáveis de ambiente ou métodos mais seguros para carregá-la.
        const firebaseConfig = {
            apiKey: "AIzaSyABjUhnHsga9jPyl0Vz57BLam06j8a0KYY",
            authDomain: "crm-vizione-firestore.firebaseapp.com",
            projectId: "crm-vizione-firestore",
            storageBucket: "crm-vizione-firestore.firebasestorage.app",
            messagingSenderId: "232305324276",
            appId: "1:232305324276:web:5bd26e12569449bb5eeea1"
        };

        // Inicializa o Firebase, se ainda não foi inicializado
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); // Se já inicializado, apenas pega a instância
        }
        
        // Pega a instância do Firestore
        const db = firebase.firestore();

        // Constantes e variáveis globais
        const CLIENTES_POR_PAGINA = 10; // Define quantos clientes serão exibidos por página
        let clients = []; // Array que armazena os clientes atualmente exibidos na tabela
        let lastVisibleDoc = null; // Referência ao último documento da página atual para paginação 'próxima'
        let firstVisibleDoc = null; // Referência ao primeiro documento da página atual para paginação 'anterior'
        let paginationHistory = []; // Histórico de documentos de início de página para navegação "voltar"
        let currentPage = 0; // Índice da página atual (0-based)

        let editingClientId = null; // Armazena o ID do cliente sendo editado no formulário

        // Mapeamento dos elementos do DOM
        const rawDataInput = document.getElementById('rawDataInput');
        const fillFormButton = document.getElementById('fillFormButton');
        const clientForm = document.getElementById('clientForm');
        const addClientButton = document.getElementById('addClientButton');
        const updateClientButton = document.getElementById('updateClientButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const clientTableBody = document.getElementById('clientTableBody');
        const messageBox = document.getElementById('messageBox'); // Elemento para exibir mensagens ao usuário
        const exportExcelButton = document.getElementById('exportExcelButton');
        const deleteClientButton = document.getElementById('deleteClientButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const updateLoadingSpinner = document.getElementById('updateLoadingSpinner');
        const deleteLoadingSpinner = document.getElementById('deleteLoadingSpinner');

        const clientDetailsContainer = document.getElementById('clientDetailsContainer');

        // Campos do formulário
        const companyNameField = document.getElementById('companyName');
        const contactNameField = document.getElementById('contactName'); // Novo campo
        const phoneField = document.getElementById('phone');
        const emailField = document.getElementById('email');
        const websiteField = document.getElementById('website');
        const addressField = document.getElementById('address');
        const salesMeetingDateField = document.getElementById('salesMeetingDate'); // Novo campo
        const contractStartDateField = document.getElementById('contractStartDate'); // Novo campo
        const statusField = document.getElementById('status');
        const lastContactDateField = document.getElementById('lastContactDate');
        const notesField = document.getElementById('notes');

        // Campos de filtro e pesquisa
        const filterStatusField = document.getElementById('filterStatus');
        const filterDateFromField = document.getElementById('filterDateFrom');
        const filterDateToField = document.getElementById('filterDateTo');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const generalSearchInput = document.getElementById('generalSearchInput');
        const searchButton = document.getElementById('searchButton');
        const prevPageButton = document.getElementById('prevPageButton');
        const nextPageButton = document.getElementById('nextPageButton');

        /**
         * Exibe uma mensagem para o usuário.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - O tipo de mensagem ('success', 'error', 'info').
         * @param {HTMLElement} [targetBox=messageBox] - O elemento HTML onde a mensagem será exibida.
         */
        function showMessage(message, type, targetBox = messageBox) {
            targetBox.textContent = message;
            targetBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            if (type === 'success') {
                targetBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                targetBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                targetBox.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            targetBox.classList.remove('hidden');
            // Oculta a mensagem após 3 segundos
            setTimeout(() => {
                targetBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Limpa todos os campos do formulário e redefine o estado de edição.
         */
        function clearForm() {
            companyNameField.value = '';
            contactNameField.value = '';
            phoneField.value = '';
            emailField.value = '';
            websiteField.value = '';
            addressField.value = '';
            salesMeetingDateField.value = ''; // Limpa o novo campo
            contractStartDateField.value = ''; // Limpa o novo campo
            statusField.value = 'Novo Contato'; // Define o status padrão
            lastContactDateField.value = '';
            notesField.value = '';
            editingClientId = null; // Reseta o ID do cliente em edição
            
            // Desabilita botões de atualização e exclusão
            updateClientButton.disabled = true;
            deleteClientButton.disabled = true;
            clientDetailsContainer.classList.remove('edit-mode-border'); // Remove borda de edição
        }

        /**
         * Preenche o formulário com os dados de um cliente.
         * @param {Object} client - O objeto cliente contendo os dados a serem preenchidos.
         */
        function fillForm(client) {
            companyNameField.value = client.companyName || '';
            contactNameField.value = client.contactName || '';
            phoneField.value = client.phone || '';
            emailField.value = client.email || '';
            websiteField.value = client.website || '';
            addressField.value = client.address || '';

            // Converte o Timestamp do Firestore para o formato de data HTML (YYYY-MM-DD) para os novos campos
            if (client.salesMeetingDate && client.salesMeetingDate.toDate) {
                salesMeetingDateField.value = client.salesMeetingDate.toDate().toISOString().split('T')[0];
            } else {
                salesMeetingDateField.value = '';
            }
            if (client.contractStartDate && client.contractStartDate.toDate) {
                contractStartDateField.value = client.contractStartDate.toDate().toISOString().split('T')[0];
            } else {
                contractStartDateField.value = '';
            }

            statusField.value = client.status || 'Novo Contato';
            if (client.lastContactDate && client.lastContactDate.toDate) {
                lastContactDateField.value = client.lastContactDate.toDate().toISOString().split('T')[0];
            } else {
                lastContactDateField.value = '';
            }
            notesField.value = client.notes || '';
            editingClientId = client.id; // Define o ID do cliente que está sendo editado

            // Habilita botões de atualização e exclusão e adiciona borda de edição
            updateClientButton.disabled = false;
            deleteClientButton.disabled = false;
            clientDetailsContainer.classList.add('edit-mode-border');
        }

        /**
         * Analisa o texto bruto do Google Meu Negócio e extrai informações do cliente.
         * @param {string} rawText - O texto bruto a ser analisado.
         * @returns {Object} Um objeto com os dados do cliente extraídos.
         */
        function parseRawData(rawText) {
            const data = {};
            // Expressões regulares para extrair os dados
            const companyNameMatch = rawText.match(/(?:Nome da Empresa:|Empresa:)\s*([^\n]+)/i) || rawText.match(/^([^\n]+)/);
            if (companyNameMatch) {
                data.companyName = companyNameMatch[1].trim();
            }
            const contactNameMatch = rawText.match(/(?:Nome de Contato:|Contato:)\s*([^\n]+)/i);
            if (contactNameMatch) {
                data.contactName = contactNameMatch[1].trim();
            }
            const phoneMatch = rawText.match(/(?:\(?\d{2}\)?\s*\d{4,5}[-\s]?\d{4}|\+\d{2}\s*\d{2}\s*\d{4,5}[-\s]?\d{4})/);
            if (phoneMatch) {
                data.phone = phoneMatch[0].trim();
            }
            const emailMatch = rawText.match(/[\w\.-]+@[\w\.-]+\.\w+/);
            if (emailMatch) {
                data.email = emailMatch[0].trim();
            }
            const websiteMatch = rawText.match(/(?:https?:\/\/)?(?:www\.)?([a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+(?:\/[^\s]*)?)/);
            if (websiteMatch) {
                data.website = websiteMatch[0].trim();
                // Adiciona http:// se não houver protocolo
                if (!data.website.startsWith('http://') && !data.website.startsWith('https://')) {
                    data.website = 'http://' + data.website;
                }
            }
            const addressMatch = rawText.match(/(?:Endereço:|Rua|Av\.|Avenida|Travessa|Praça)\s*([^\n]+(?:,\s*\d+)?(?:,\s*[^\n]+)?(?:-\s*[^\n]+)?(?:,\s*CEP\s*\d{5}-?\d{3})?)/i);
            if (addressMatch) {
                data.address = addressMatch[0].trim();
            } else {
                // Tenta uma correspondência mais genérica para o endereço se a primeira falhar
                const genericAddressMatch = rawText.match(/(\d{1,5}\s+[A-Za-z\s]+\s+(?:Rua|Av\.|Avenida|Travessa|Praça|Bairro|Centro|Cidade|Estado)[^\n]*)/i);
                if (genericAddressMatch) {
                    data.address = genericAddressMatch[0].trim();
                }
            }
            // Regex para Data de Reunião para Vendas
            const salesMeetingDateMatch = rawText.match(/(?:Data de Reunião para Vendas:|Reunião Vendas:)\s*(\d{4}-\d{2}-\d{2})/i);
            if (salesMeetingDateMatch) {
                data.salesMeetingDate = salesMeetingDateMatch[1].trim();
            }
            // Regex para Data de Início do Contrato
            const contractStartDateMatch = rawText.match(/(?:Data de Início do Contrato:|Início Contrato:)\s*(\d{4}-\d{2}-\d{2})/i);
            if (contractStartDateMatch) {
                data.contractStartDate = contractStartDateMatch[1].trim();
            }

            // Atualiza o regex para capturar os novos valores de status
            const statusMatch = rawText.match(/(?:Status:)\s*(Novo Contato|Em Andamento|Aguardando Contato|Novo Cliente|Perdido)/i);
            if (statusMatch) {
                data.status = statusMatch[1].trim(); // Pega o valor exato que corresponde
                // Garante que o status é um dos valores válidos
                const validStatuses = ['Novo Contato', 'Em Andamento', 'Aguardando Contato', 'Novo Cliente', 'Perdido'];
                if (!validStatuses.includes(data.status)) {
                    data.status = 'Novo Contato'; // Define para 'Novo Contato' se o status for inválido
                }
            } else {
                data.status = 'Novo Contato'; // Padrão se não encontrado
            }
            const lastContactDateMatch = rawText.match(/(?:Último Contato:|Data Contato:)\s*(\d{4}-\d{2}-\d{2})/i);
            if (lastContactDateMatch) {
                data.lastContactDate = lastContactDateMatch[1].trim();
            }
            // Extrai observações removendo os dados já extraídos
            let notes = rawText;
            for (const key in data) {
                if (data[key]) {
                    // Escapa caracteres especiais para uso em RegExp
                    notes = notes.replace(new RegExp(data[key].replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi'), '').trim();
                }
            }
            data.notes = notes.replace(/\s{2,}/g, ' ').trim(); // Remove múltiplos espaços e trim
            return data;
        }

        /**
         * Formata uma data para o formato brasileiro (DD/MM/YYYY).
         * @param {Date|firebase.firestore.Timestamp|string} date - A data a ser formatada.
         * @returns {string} A data formatada ou string vazia se inválido.
         */
        function formatDateToBrazilian(date) {
            if (!date) return '';
            if (date instanceof Date) {
                return date.toLocaleDateString('pt-BR');
            } else if (typeof date.toDate === 'function') { // Firestore Timestamp
                return date.toDate().toLocaleDateString('pt-BR');
            } else if (typeof date === 'string') {
                const d = new Date(date + 'T00:00:00'); // Trata como UTC para evitar problemas de fuso horário
                return !isNaN(d.getTime()) ? d.toLocaleDateString('pt-BR') : '';
            }
            return '';
        }

        /**
         * Calcula a duração do contrato a partir de uma data de início.
         * @param {Date|firebase.firestore.Timestamp|string} startDate - A data de início do contrato.
         * @returns {string} A duração formatada (dias, meses ou anos) ou string vazia se inválido.
         */
        function calculateContractDuration(startDate) {
            if (!startDate) return '';

            let dateObj;
            if (startDate instanceof Date) {
                dateObj = startDate;
            } else if (typeof startDate.toDate === 'function') {
                dateObj = startDate.toDate();
            } else if (typeof startDate === 'string') {
                dateObj = new Date(startDate + 'T00:00:00');
                if (isNaN(dateObj.getTime())) return '';
            } else {
                return '';
            }

            const today = new Date();
            const diffTime = Math.abs(today - dateObj);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 30) {
                return `${diffDays} dia(s)`;
            } else if (diffDays < 365) {
                const diffMonths = Math.floor(diffDays / 30.44); // Média de dias por mês
                return `${diffMonths} mês(es)`;
            } else {
                const diffYears = Math.floor(diffDays / 365.25); // Média de dias por ano
                return `${diffYears} ano(s)`;
            }
        }


        /**
         * Carrega os clientes do Firestore com base nos filtros e na paginação.
         * @param {string} direction - Direção da paginação ('current', 'next', 'prev').
         */
        async function loadClientsFromFirestore(direction = 'current') {
            // Salva a posição atual do scroll para restaurar após a renderização
            let scrollPosition = clientTableBody.parentElement.scrollTop;
            clients = []; // Limpa o array de clientes antes de carregar novos

            try {
                let clientsRef = db.collection("clientes");

                // Pega os valores dos filtros
                const filterStatus = filterStatusField.value;
                const filterDateFrom = filterDateFromField.value;
                const filterDateTo = filterDateToField.value;
                const generalSearchTerm = generalSearchInput.value.trim().toLowerCase();

                // Aplica filtros se existirem
                if (filterStatus) {
                    clientsRef = clientsRef.where('status', '==', filterStatus);
                }
                if (filterDateFrom) {
                    const dateFrom = new Date(filterDateFrom + 'T00:00:00');
                    clientsRef = clientsRef.where('lastContactDate', '>=', dateFrom);
                }
                if (filterDateTo) {
                    const dateTo = new Date(filterDateTo + 'T23:59:59');
                    clientsRef = clientsRef.where('lastContactDate', '<=', dateTo);
                }

                // Ordena por 'lastContactDate' se houver filtro de data, caso contrário, por 'createdAt'
                if (filterDateFrom || filterDateTo) {
                    clientsRef = clientsRef.orderBy('lastContactDate', 'asc');
                    clientsRef = clientsRef.orderBy('createdAt', 'desc'); // Ordem secundária para estabilidade
                } else {
                    clientsRef = clientsRef.orderBy('createdAt', 'desc'); // Ordena os clientes por data de criação (mais novos primeiro)
                }

                // Lógica de Paginação do Firestore
                let queryToExecute;
                if (direction === 'next' && lastVisibleDoc) {
                    // Inicia a consulta após o último documento visível da página anterior
                    queryToExecute = clientsRef.startAfter(lastVisibleDoc).limit(CLIENTES_POR_PAGINA);
                } else if (direction === 'prev' && firstVisibleDoc && paginationHistory.length > 1) {
                    // Remove o documento da página atual do histórico
                    paginationHistory.pop();
                    // Pega o documento de início da página anterior
                    const prevStartDoc = paginationHistory[paginationHistory.length - 1];
                    queryToExecute = clientsRef.startAt(prevStartDoc).limit(CLIENTES_POR_PAGINA);
                } else {
                    // Primeira carga ou aplicação de novos filtros/pesquisa, reinicia a paginação
                    paginationHistory = []; // Limpa o histórico de paginação
                    queryToExecute = clientsRef.limit(CLIENTES_POR_PAGINA);
                }
                
                const querySnapshot = await queryToExecute.get();

                let fetchedClients = [];
                querySnapshot.forEach(doc => {
                    // Adiciona a referência do documento para uso na paginação
                    fetchedClients.push({ id: doc.id, ...doc.data(), docRef: doc });
                });

                // Atualiza as referências de documentos visíveis para paginação
                if (fetchedClients.length > 0) {
                    firstVisibleDoc = fetchedClients[0].docRef;
                    lastVisibleDoc = fetchedClients[fetchedClients.length - 1].docRef;
                    if (direction === 'current' || direction === 'next') {
                        // Adiciona ao histórico apenas se for a primeira carga ou avançando
                        paginationHistory.push(firstVisibleDoc);
                    }
                } else {
                    firstVisibleDoc = null;
                    lastVisibleDoc = null;
                }

                let clientsToRender = [];
                // Aplica a pesquisa geral em memória (após a filtragem do Firestore)
                if (generalSearchTerm) {
                    fetchedClients.forEach(clientData => {
                        // Converte Timestamps para objetos Date para facilitar a formatação na busca
                        if (clientData.createdAt && typeof clientData.createdAt.toDate === 'function') {
                            clientData.createdAt = clientData.createdAt.toDate();
                        }
                        if (clientData.lastContactDate && typeof clientData.lastContactDate.toDate === 'function') {
                            clientData.lastContactDate = clientData.lastContactDate.toDate();
                        }
                        // Converte os novos campos de data para objetos Date para pesquisa
                        if (clientData.salesMeetingDate && typeof clientData.salesMeetingDate.toDate === 'function') {
                            clientData.salesMeetingDate = clientData.salesMeetingDate.toDate();
                        }
                        if (clientData.contractStartDate && typeof clientData.contractStartDate.toDate === 'function') {
                            clientData.contractStartDate = clientData.contractStartDate.toDate();
                        }
                        
                        // Cria um array de campos pesquisáveis em minúsculas
                        const searchableFields = [
                            clientData.companyName,
                            clientData.contactName,
                            clientData.phone,
                            clientData.email,
                            clientData.website,
                            clientData.address,
                            clientData.notes,
                            clientData.status
                        ].filter(Boolean).map(field => String(field).toLowerCase());

                        // Adiciona as datas formatadas para pesquisa
                        searchableFields.push(formatDateToBrazilian(clientData.lastContactDate).toLowerCase());
                        searchableFields.push(formatDateToBrazilian(clientData.salesMeetingDate).toLowerCase());
                        searchableFields.push(formatDateToBrazilian(clientData.contractStartDate).toLowerCase());
                        searchableFields.push(calculateContractDuration(clientData.contractStartDate).toLowerCase());


                        // Verifica se algum campo pesquisável inclui o termo de pesquisa
                        if (searchableFields.some(field => field.includes(generalSearchTerm))) {
                            clientsToRender.push(clientData);
                        }
                    });
                } else {
                    clientsToRender = fetchedClients; // Se não houver pesquisa, todos os clientes filtrados são renderizados
                }

                clients = clientsToRender; // Atualiza o array global de clientes
                renderClientTable(); // Renderiza a tabela com os clientes carregados/filtrados/pesquisados
                updatePaginationButtons(); // Atualiza o estado dos botões de paginação
                // Restaura a posição do scroll
                clientTableBody.parentElement.scrollTop = scrollPosition;
                showMessage('Clientes carregados e filtrados/pesquisados com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao carregar clientes do Firestore: ", error);
                // Sugestão de verificação de regras e índices do Firestore em caso de erro
                showMessage('Erro ao carregar clientes. Verifique as regras de segurança do Firestore e os índices do Firestore (se estiver usando filtros de data ou múltiplos filtros).', 'error');
            }
        }

        /**
         * Renderiza a tabela de clientes com os dados do array `clients`.
         */
        function renderClientTable() {
            clientTableBody.innerHTML = ''; // Limpa o corpo da tabela
            if (clients.length === 0) {
                // Mensagem se não houver clientes
                clientTableBody.innerHTML = `<tr><td colspan="12" class="px-3 md:px-6 py-2 md:py-4 text-center text-gray-500">Nenhum cliente cadastrado ainda.</td></tr>`;
                return;
            }

            clients.forEach((client, index) => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'cursor-pointer', 'transition', 'duration-150', 'ease-in-out');
                row.dataset.index = index; // Armazena o índice do cliente no dataset da linha
                row.dataset.id = client.id; // Armazena o ID do documento do Firestore

                // Adiciona classes condicionais para destaque de linha
                if (client.contractStartDate) {
                    row.classList.add('contract-signed-row');
                } else if (client.salesMeetingDate) {
                    row.classList.add('meeting-scheduled-row');
                }

                const formattedLastContactDate = formatDateToBrazilian(client.lastContactDate);
                const formattedSalesMeetingDate = formatDateToBrazilian(client.salesMeetingDate);
                const formattedContractStartDate = formatDateToBrazilian(client.contractStartDate);
                const contractDuration = calculateContractDuration(client.contractStartDate);

                row.innerHTML = `
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm font-medium text-gray-900 rounded-bl-lg">${client.companyName || ''}</td>
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm text-gray-700">${client.contactName || ''}</td>
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm text-gray-700">${client.phone || ''}</td>
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm text-gray-700">${client.email || ''}</td>
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm text-gray-700">${client.website || ''}</td>
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm text-gray-700">${client.address || ''}</td>
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm text-gray-700 quick-edit-date" data-field="salesMeetingDate" data-value="${client.salesMeetingDate ? (client.salesMeetingDate instanceof Date ? client.salesMeetingDate.toISOString().split('T')[0] : (typeof client.salesMeetingDate.toDate === 'function' ? client.salesMeetingDate.toDate().toISOString().split('T')[0] : '')) : ''}">${formattedSalesMeetingDate}</td>
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm text-gray-700 quick-edit-date" data-field="contractStartDate" data-value="${client.contractStartDate ? (client.contractStartDate instanceof Date ? client.contractStartDate.toISOString().split('T')[0] : (typeof client.contractStartDate.toDate === 'function' ? client.contractStartDate.toDate().toISOString().split('T')[0] : '')) : ''}">${formattedContractStartDate}</td>
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm text-gray-700">${contractDuration}</td>
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm text-gray-700 quick-edit-status" data-field="status" data-value="${client.status || 'Novo Contato'}">${client.status || 'Novo Contato'}</td>
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm text-gray-700 quick-edit-date" data-field="lastContactDate" data-value="${client.lastContactDate ? (client.lastContactDate instanceof Date ? client.lastContactDate.toISOString().split('T')[0] : (typeof client.lastContactDate.toDate === 'function' ? client.lastContactDate.toDate().toISOString().split('T')[0] : '')) : ''}">${formattedLastContactDate}</td>
                    <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-sm text-gray-700 rounded-br-lg">${client.notes || ''}</td>
                `;
                clientTableBody.appendChild(row);
            });
        }

        /**
         * Exporta os dados da tabela de clientes para um arquivo Excel.
         */
        function exportToExcel() {
            if (clients.length === 0) {
                showMessage('Não há clientes para exportar.', 'info');
                return;
            }
            const headers = [
                "Nome da Empresa", "Nome de Contato", "Telefone", "Email", "Site", "Endereço", 
                "Data Reunião Vendas", "Início Contrato", "Tempo de Contrato", "Status", "Último Contato", "Observações"
            ];
            // Mapeia os dados do cliente para o formato da tabela Excel
            const data = clients.map(client => [
                client.companyName,
                client.contactName,
                client.phone,
                client.email,
                client.website,
                client.address,
                formatDateToBrazilian(client.salesMeetingDate),
                formatDateToBrazilian(client.contractStartDate),
                calculateContractDuration(client.contractStartDate), // Tempo de Contrato calculado
                client.status,
                formatDateToBrazilian(client.lastContactDate),
                client.notes
            ]);
            const wsData = [headers, ...data]; // Combina cabeçalhos e dados
            const wb = XLSX.utils.book_new(); // Cria um novo workbook
            const ws = XLSX.utils.aoa_to_sheet(wsData); // Converte array de arrays para sheet
            XLSX.utils.book_append_sheet(wb, ws, "Clientes CRM"); // Adiciona a sheet ao workbook
            XLSX.writeFile(wb, "clientes_crm.xlsx"); // Escreve o arquivo Excel
            showMessage('Dados exportados para "clientes_crm.xlsx" com sucesso!', 'success');
        }

        // --- Listeners de Eventos ---

        // Preenche o formulário a partir dos dados brutos
        fillFormButton.addEventListener('click', () => {
            const rawText = rawDataInput.value;
            if (rawText.trim() === '') {
                showMessage('Cole os dados brutos para preencher o formulário.', 'info');
                return;
            }
            const parsedData = parseRawData(rawText);
            clearForm(); // Limpa o formulário antes de preencher
            fillForm(parsedData);
            showMessage('Formulário preenchido com sucesso!', 'success');
        });

        // Adiciona um novo cliente ao Firestore
        addClientButton.addEventListener('click', async () => {
            const clientData = {
                companyName: companyNameField.value.trim(),
                contactName: contactNameField.value.trim(),
                phone: phoneField.value.trim(),
                email: emailField.value.trim(),
                website: websiteField.value.trim(),
                address: addressField.value.trim(),
                salesMeetingDate: salesMeetingDateField.value ? new Date(salesMeetingDateField.value + 'T00:00:00') : null,
                contractStartDate: contractStartDateField.value ? new Date(contractStartDateField.value + 'T00:00:00') : null,
                status: statusField.value,
                notes: notesField.value.trim(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp() // Define o timestamp de criação
            };

            // Define a data do último contato, ou usa o timestamp do servidor se não houver data
            if (lastContactDateField.value) {
                clientData.lastContactDate = new Date(lastContactDateField.value + 'T00:00:00');
            } else {
                clientData.lastContactDate = firebase.firestore.FieldValue.serverTimestamp();
            }


            if (!clientData.companyName) {
                showMessage('O nome da empresa é obrigatório para cadastrar o cliente.', 'error');
                return;
            }

            addClientButton.disabled = true; // Desabilita o botão para evitar cliques múltiplos
            loadingSpinner.classList.remove('hidden'); // Exibe o spinner de carregamento

            try {
                // Verifica se já existe um cliente com o mesmo nome, telefone ou email
                let isDuplicate = false;

                // Consulta por nome da empresa
                const companyNameQuery = db.collection("clientes").where("companyName", "==", clientData.companyName);
                const companyNameSnapshot = await companyNameQuery.get();
                if (!companyNameSnapshot.empty) {
                    isDuplicate = true;
                }

                // Consulta por telefone (se houver telefone e ainda não for duplicado)
                if (!isDuplicate && clientData.phone) {
                    const phoneQuery = db.collection("clientes").where("phone", "==", clientData.phone);
                    const phoneSnapshot = await phoneQuery.get();
                    if (!phoneSnapshot.empty) {
                        isDuplicate = true;
                    }
                }

                // Consulta por email (se houver email e ainda não for duplicado)
                if (!isDuplicate && clientData.email) {
                    const emailQuery = db.collection("clientes").where("email", "==", clientData.email);
                    const emailSnapshot = await emailQuery.get();
                    if (!emailSnapshot.empty) {
                        isDuplicate = true;
                    }
                }

                if (isDuplicate) {
                    showMessage('Cliente já cadastrado na base de dados (Nome da Empresa, Telefone ou Email duplicado).', 'info');
                    addClientButton.disabled = false;
                    loadingSpinner.classList.add('hidden');
                    return; // Interrompe o processo se for duplicado
                }

                const docRef = await db.collection("clientes").add(clientData);
                
                currentPage = 0; // Ao adicionar um novo cliente, volta para a primeira página
                await loadClientsFromFirestore(); // Recarrega a tabela de clientes
                clearForm(); // Limpa o formulário após o cadastro
                rawDataInput.value = ''; // Limpa a caixa de texto bruta
                showMessage('Cliente cadastrado e salvo no Firestore com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao adicionar documento no Firestore:', error);
                showMessage(`Erro ao cadastrar cliente no Firestore: ${error.message}. Verifique as regras de segurança do Firestore.`, 'error');
            } finally {
                addClientButton.disabled = false; // Reabilita o botão
                loadingSpinner.classList.add('hidden'); // Oculta o spinner
            }
        });

        // Atualiza um cliente existente no Firestore
        updateClientButton.addEventListener('click', async () => {
            if (!editingClientId) {
                showMessage('Nenhum cliente selecionado para atualizar.', 'info');
                return;
            }

            const updatedClientData = {
                companyName: companyNameField.value.trim(),
                contactName: contactNameField.value.trim(),
                phone: phoneField.value.trim(),
                email: emailField.value.trim(),
                website: websiteField.value.trim(),
                address: addressField.value.trim(),
                salesMeetingDate: salesMeetingDateField.value ? new Date(salesMeetingDateField.value + 'T00:00:00') : null,
                contractStartDate: contractStartDateField.value ? new Date(contractStartDateField.value + 'T00:00:00') : null,
                status: statusField.value,
                notes: notesField.value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp() // Atualiza o timestamp de modificação
            };

            if (lastContactDateField.value) {
                updatedClientData.lastContactDate = new Date(lastContactDateField.value + 'T00:00:00');
            } else {
                updatedClientData.lastContactDate = firebase.firestore.FieldValue.serverTimestamp();
            }

            if (!updatedClientData.companyName) {
                showMessage('O nome da empresa é obrigatório para atualizar o cliente.', 'error');
                return;
            }

            updateClientButton.disabled = true;
            updateLoadingSpinner.classList.remove('hidden');

            try {
                await db.collection("clientes").doc(editingClientId).update(updatedClientData);

                await loadClientsFromFirestore(); // Recarrega a tabela para exibir as atualizações
                clearForm(); // Limpa o formulário
                showMessage('Cliente atualizado no Firestore com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao atualizar documento no Firestore:', error);
                showMessage(`Erro ao atualizar cliente: ${error.message}. Verifique as regras de segurança.`, 'error');
            } finally {
                updateClientButton.disabled = false;
                updateLoadingSpinner.classList.add('hidden');
            }
        });

        // Cancela a edição e limpa o formulário
        cancelEditButton.addEventListener('click', () => {
            clearForm();
            showMessage('Edição cancelada. Formulário limpo.', 'info');
        });

        // Lida com cliques na tabela para edição rápida ou preenchimento do formulário
        clientTableBody.addEventListener('click', (event) => {
            const clickedCell = event.target.closest('td'); // Pega a célula clicada
            const row = clickedCell ? clickedCell.closest('tr') : null; // Pega a linha da tabela

            if (!row) return; // Sai se não clicou em uma linha

            const clientId = row.dataset.id; // Pega o ID do cliente da linha
            const field = clickedCell ? clickedCell.dataset.field : null; // Pega o campo a ser editado
            const clientData = clients.find(c => c.id === clientId); // Encontra os dados do cliente

            if (!clientData) return; // Sai se os dados do cliente não forem encontrados

            // Se clicou em uma célula de edição rápida (status ou data)
            if (clickedCell && (clickedCell.classList.contains('quick-edit-status') || clickedCell.classList.contains('quick-edit-date'))) {
                event.stopPropagation(); // Impede que o clique se propague para a linha

                // Se já existe um input de edição, sai (evita múltiplos inputs)
                if (clickedCell.querySelector('.quick-edit-input')) {
                    return;
                }

                const originalCellContent = clickedCell.innerHTML; // Salva o conteúdo original da célula

                let inputElement;
                let saveButton = document.createElement('button');
                saveButton.classList.add('quick-edit-btn');
                saveButton.textContent = 'Salvar';

                let cancelButton = document.createElement('button');
                cancelButton.classList.add('quick-edit-btn');
                cancelButton.style.backgroundColor = '#ef4444'; // Estilo para o botão Cancelar (vermelho)
                cancelButton.textContent = 'X';

                let containerDiv = document.createElement('div');
                containerDiv.classList.add('quick-edit-container');

                // Cria o elemento de input/select apropriado
                if (clickedCell.classList.contains('quick-edit-status')) {
                    inputElement = document.createElement('select');
                    inputElement.classList.add('quick-edit-input');
                    // Opções do select para status (atualizado)
                    inputElement.innerHTML = `
                        <option value="Novo Contato">Novo Contato</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Novo Cliente">Novo Cliente</option>
                        <option value="Perdido">Perdido</option>
                    </select>
                    `;
                    inputElement.value = clientData.status || 'Novo Contato'; // Define o valor atual
                } else if (clickedCell.classList.contains('quick-edit-date')) {
                    inputElement = document.createElement('input');
                    inputElement.type = 'date';
                    inputElement.classList.add('quick-edit-input');
                    // Define o valor da data (formato ISO YYYY-MM-DD)
                    // Usa data-value para preencher o input corretamente
                    inputElement.value = clickedCell.dataset.value || '';
                }

                containerDiv.appendChild(inputElement);
                containerDiv.appendChild(saveButton);
                containerDiv.appendChild(cancelButton);

                clickedCell.innerHTML = ''; // Limpa o conteúdo da célula
                clickedCell.appendChild(containerDiv); // Adiciona o input e botões
                inputElement.focus(); // Foca no input

                // Listener para o botão Salvar da edição rápida
                saveButton.addEventListener('click', async (e) => {
                    e.stopPropagation(); // Impede a propagação do clique
                    await updateQuickEditField(clientId, field, inputElement.value);
                });

                // Listener para o botão Cancelar da edição rápida
                cancelButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    clickedCell.innerHTML = originalCellContent; // Restaura o conteúdo original
                });

                // Listener para quando o input perde o foco (blur)
                inputElement.addEventListener('blur', () => {
                    // Restaura o conteúdo original se o input ainda estiver na célula
                    if (clickedCell.contains(inputElement)) {
                        clickedCell.innerHTML = originalCellContent;
                    }
                });
                
                // Listener para teclas (Enter para salvar, Esc para cancelar)
                inputElement.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Impede a quebra de linha em textareas ou envio de formulário
                        await updateQuickEditField(clientId, field, inputElement.value);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        clickedCell.innerHTML = originalCellContent; // Restaura o conteúdo original
                    }
                });

            } else {
                // Se não for edição rápida, preenche o formulário principal
                fillForm(clientData);
                showMessage(`Dados de "${clientData.companyName}" carregados para edição.`, 'info');
            }
        });

        /**
         * Atualiza um campo específico de um cliente no Firestore (usado para edição rápida na tabela).
         * @param {string} clientId - O ID do cliente a ser atualizado.
         * @param {string} field - O nome do campo a ser atualizado.
         * @param {any} newValue - O novo valor para o campo.
         */
        async function updateQuickEditField(clientId, field, newValue) {
            let initialScrollTop = clientTableBody.parentElement.scrollTop; // Salva a posição do scroll
            try {
                let updateData = {};
                // Converte a data para um objeto Date se o campo for de data
                if (['lastContactDate', 'salesMeetingDate', 'contractStartDate'].includes(field)) {
                    updateData[field] = newValue ? new Date(newValue + 'T00:00:00') : null;
                } else {
                    updateData[field] = newValue;
                }
                updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp(); // Atualiza o timestamp de modificação

                await db.collection("clientes").doc(clientId).update(updateData);
                showMessage('Campo atualizado com sucesso!', 'success');
                await loadClientsFromFirestore(); // Recarrega a tabela para exibir a mudança
                clientTableBody.parentElement.scrollTop = initialScrollTop; // Restaura a posição do scroll
            } catch (error) {
                console.error(`Erro ao atualizar campo ${field} no Firestore:`, error);
                showMessage(`Erro ao atualizar campo: ${error.message}`, 'error');
                await loadClientsFromFirestore(); // Recarrega mesmo em caso de erro para garantir consistência
                clientTableBody.parentElement.scrollTop = initialScrollTop; // Restaura a posição do scroll
            }
        }

        // Exporta os dados para Excel
        exportExcelButton.addEventListener('click', exportToExcel);

        // Exclui um cliente do Firestore
        deleteClientButton.addEventListener('click', async () => {
            if (!editingClientId) {
                showMessage('Selecione um cliente na tabela primeiro para excluí-lo.', 'info');
                return;
            }

            deleteClientButton.disabled = true;
            deleteLoadingSpinner.classList.remove('hidden');

            try {
                await db.collection("clientes").doc(editingClientId).delete();

                currentPage = 0; // Volta para a primeira página após a exclusão
                await loadClientsFromFirestore(); // Recarrega a tabela
                clearForm(); // Limpa o formulário
                showMessage('Cliente excluído com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir documento do Firestore:', error);
                showMessage(`Erro ao excluir cliente: ${error.message}. Verifique as regras de segurança do Firestore.`, 'error');
            } finally {
                deleteClientButton.disabled = false;
                deleteLoadingSpinner.classList.add('hidden');
            }
        });

        // Aplica os filtros e pesquisa
        applyFiltersButton.addEventListener('click', () => {
            currentPage = 0; // Reinicia a paginação ao aplicar filtros
            loadClientsFromFirestore();
        });
        clearFiltersButton.addEventListener('click', () => {
            // Limpa todos os campos de filtro e pesquisa
            filterStatusField.value = '';
            filterDateFromField.value = '';
            filterDateToField.value = '';
            generalSearchInput.value = '';
            currentPage = 0; // Reinicia a paginação
            loadClientsFromFirestore(); // Recarrega a tabela sem filtros
            showMessage('Filtros limpos!', 'info');
        });

        // Inicia a pesquisa geral
        searchButton.addEventListener('click', () => {
            currentPage = 0; // Reinicia a paginação ao fazer uma nova pesquisa
            loadClientsFromFirestore();
        });

        // Navegação de paginação
        prevPageButton.addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                loadClientsFromFirestore('prev'); // Carrega a página anterior
            }
        });

        nextPageButton.addEventListener('click', () => {
            currentPage++;
            loadClientsFromFirestore('next'); // Carrega a próxima página
        });

        /**
         * Atualiza o estado dos botões de paginação (Anterior/Próxima).
         */
        function updatePaginationButtons() {
            // Desabilita o botão "Anterior" na primeira página
            prevPageButton.disabled = (currentPage === 0);

            // Para saber se há uma próxima página, precisaríamos buscar um documento a mais
            // ou ter a contagem total de documentos que correspondem aos filtros.
            // Para manter a simplicidade, vamos desabilitar 'Próxima' se a página atual não tiver o número máximo de clientes.
            // Isso pode significar que o botão 'Próxima' ficará desabilitado prematuramente se a última página tiver menos de CLIENTES_POR_PAGINA.
            // Uma solução mais robusta envolveria uma contagem separada de documentos que satisfazem os filtros
            // ou buscar um item a mais (limit + 1) e verificar se há resultados para o próximo.
            nextPageButton.disabled = (clients.length < CLIENTES_POR_PAGINA);
        }

        // Carrega os clientes do Firestore quando a página é totalmente carregada
        document.addEventListener('DOMContentLoaded', loadClientsFromFirestore);
    </script>
</body>
</html>
