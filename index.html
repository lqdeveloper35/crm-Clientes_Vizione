<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM de Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-gray-50, similar ao Google Ads */
            color: #1f2937; /* Texto cinza escuro padrão */
        }
        /* Estilo para o spinner de carregamento */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para o modo de edição do formulário */
        .edit-mode-border {
            border: 2px solid #3b82f6; /* Borda azul para indicar modo de edição */
        }
        /* Estilos para campos de edição rápida na tabela */
        .quick-edit-container {
            display: flex;
            align-items: center;
            gap: 4px; /* Espaçamento entre o input e o botão */
        }
        .quick-edit-input {
            width: calc(100% - 40px); /* Ajusta largura para o botão */
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.875rem; /* text-sm */
            background-color: #f0f4f8; /* Um cinza claro para destacar */
        }
        .quick-edit-btn {
            background-color: #10b981; /* Verde */
            color: white;
            padding: 4px 8px;
            border: none; /* Remove borda padrão */
            border-radius: 4px;
            font-size: 0.75rem; /* text-xs */
            cursor: pointer;
            flex-shrink: 0; /* Não encolhe o botão */
        }
        .quick-edit-btn:hover {
            background-color: #059669; /* Verde mais escuro */
        }
    </style>
</head>
<body class="p-4 bg-gray-50 min-h-screen flex items-center justify-center text-gray-900">
    
    <div id="crmApp" class="container mx-auto p-6 bg-white rounded-xl shadow-lg max-w-4xl w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Cadastro de Clientes CRM</h1>

        <div class="mb-8 p-6 bg-white rounded-lg border border-gray-200">
            <label for="rawDataInput" class="block text-lg font-semibold text-gray-700 mb-3">
                Cole os dados do Google Meu Negócio aqui:
            </label>
            <textarea id="rawDataInput" rows="8"
                      class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900 placeholder-gray-400"
                      placeholder="Ex: Nome da Empresa: Minha Loja Ltda.&#10;Telefone: (11) 98765-4321&#10;Site: www.minhaloja.com.br&#10;Endereço: Rua Exemplo, 123, Centro, Cidade - SP&#10;Email: contato@minhaloja.com.br&#10;Status: Novo&#10;Último Contato: 2023-05-15"></textarea>
            <button id="fillFormButton"
                    class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                Preencher Formulário
            </button>
        </div>

        <div id="clientDetailsContainer" class="mb-8 p-6 bg-white rounded-xl border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Detalhes do Cliente</h2>
            <form id="clientForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa:</label>
                    <input type="text" id="companyName"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone:</label>
                    <input type="text" id="phone"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                    <input type="email" id="email"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="website" class="block text-sm font-medium text-gray-700 mb-1">Site:</label>
                    <input type="url" id="website"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="md:col-span-2">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Endereço:</label>
                    <input type="text" id="address"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                    <select id="status"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                        <option value="Novo">Novo</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Fechado">Fechado</option>
                        <option value="Perdido">Perdido</option>
                    </select>
                </div>
                <div>
                    <label for="lastContactDate" class="block text-sm font-medium text-gray-700 mb-1">Data Último Contato:</label>
                    <input type="date" id="lastContactDate"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="md:col-span-2">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Observações:</label>
                    <textarea id="notes" rows="4"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900"></textarea>
                </div>
            </form>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="addClientButton"
                        class="w-1/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                    Cadastrar Cliente
                    <span id="loadingSpinner" class="loading-spinner hidden"></span>
                </button>
                <button id="updateClientButton" 
                        class="w-1/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md" disabled>
                    Atualizar Cadastro
                    <span id="updateLoadingSpinner" class="loading-spinner hidden"></span>
                </button>
                <button id="cancelEditButton" 
                        class="w-auto bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                    Cancelar Edição
                </button>
            </div>
        </div>

        <div class="p-6 bg-white rounded-lg border border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Clientes Cadastrados</h2>

            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200 flex flex-wrap items-end gap-4">
                <div class="flex-1 min-w-[150px]">
                    <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Status:</label>
                    <select id="filterStatus"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                        <option value="">Todos</option>
                        <option value="Novo">Novo</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Fechado">Fechado</option>
                        <option value="Perdido">Perdido</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label for="filterDateFrom" class="block text-sm font-medium text-gray-700 mb-1">Último Contato De:</label>
                    <input type="date" id="filterDateFrom"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label for="filterDateTo" class="block text-sm font-medium text-gray-700 mb-1">Último Contato Até:</label>
                    <input type="date" id="filterDateTo"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                </div>
                <div class="flex-none">
                    <button id="applyFiltersButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">
                        Aplicar Filtros
                    </button>
                </div>
                <div class="flex-none">
                    <button id="clearFiltersButton"
                            class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">
                        Limpar Filtros
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label for="generalSearchInput" class="block text-lg font-semibold text-gray-700 mb-3">Pesquisa Geral:</label>
                <div class="flex gap-4">
                    <input type="text" id="generalSearchInput" placeholder="Pesquisar por nome, telefone, email, etc."
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-900">
                    <button id="searchButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">
                        Pesquisar
                    </button>
                </div>
            </div>

            <div class="mb-4 text-right flex justify-end space-x-2">
                <button id="exportExcelButton"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">
                    Exportar para Excel
                </button>
                <button id="deleteClientButton"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md" disabled>
                    Excluir Cliente
                    <span id="deleteLoadingSpinner" class="loading-spinner hidden"></span>
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table id="clientTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider rounded-tl-lg">Nome da Empresa</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Telefone</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Site</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Endereço</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Último Contato</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider rounded-tr-lg">Observações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="clientTableBody">
                        </tbody>
                </table>
            </div>
            <div id="messageBox" class="hidden mt-4 p-3 text-center text-sm rounded-lg" role="alert"></div>
        </div>
    </div>

    <script>
        // SEU OBJETO firebaseConfig DO PASSO 3 DA FASE 1
        const firebaseConfig = {
            apiKey: "AIzaSyABjUhnHsga9jPyl0Vz57BLam06j8a0KYY",
            authDomain: "crm-vizione-firestore.firebaseapp.com",
            projectId: "crm-vizione-firestore",
            storageBucket: "crm-vizione-firestore.firebasestorage.app",
            messagingSenderId: "232305324276",
            appId: "1:232305324276:web:5bd26e12569449bb5eeea1"
        };

        // Inicialize o Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); 
        }
        
        // Obtenha uma referência para o Firestore
        const db = firebase.firestore();

        let clients = [];
        let editingClientId = null; 

        // Referências aos elementos do DOM do CRM (restante)
        const rawDataInput = document.getElementById('rawDataInput');
        const fillFormButton = document.getElementById('fillFormButton');
        const clientForm = document.getElementById('clientForm');
        const addClientButton = document.getElementById('addClientButton');
        const updateClientButton = document.getElementById('updateClientButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const clientTableBody = document.getElementById('clientTableBody');
        const messageBox = document.getElementById('messageBox');
        const exportExcelButton = document.getElementById('exportExcelButton');
        const deleteClientButton = document.getElementById('deleteClientButton'); 
        const loadingSpinner = document.getElementById('loadingSpinner'); 
        const updateLoadingSpinner = document.getElementById('updateLoadingSpinner');
        const deleteLoadingSpinner = document.getElementById('deleteLoadingSpinner');

        // Referência ao container do formulário para a borda de edição
        const clientDetailsContainer = document.getElementById('clientDetailsContainer');


        // Referências aos campos do formulário
        const companyNameField = document.getElementById('companyName');
        const phoneField = document.getElementById('phone');
        const emailField = document.getElementById('email');
        const websiteField = document.getElementById('website');
        const addressField = document.getElementById('address');
        const statusField = document.getElementById('status');
        const lastContactDateField = document.getElementById('lastContactDate');
        const notesField = document.getElementById('notes');

        // Referências aos campos de filtro
        const filterStatusField = document.getElementById('filterStatus');
        const filterDateFromField = document.getElementById('filterDateFrom');
        const filterDateToField = document.getElementById('filterDateTo');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const generalSearchInput = document.getElementById('generalSearchInput'); 
        const searchButton = document.getElementById('searchButton'); 


        /**
         * Exibe uma mensagem na caixa de feedback do usuário.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - O tipo da mensagem ('success', 'error', 'info').
         * @param {HTMLElement} targetBox - A caixa de mensagem a ser usada (ex: messageBox, loginMessageBox).
         */
        function showMessage(message, type, targetBox = messageBox) {
            targetBox.textContent = message;
            targetBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            if (type === 'success') {
                targetBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                targetBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                targetBox.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            targetBox.classList.remove('hidden');
            setTimeout(() => {
                targetBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Limpa todos os campos do formulário e reseta o ID do cliente selecionado.
         */
        function clearForm() {
            console.log("clearForm called.");
            companyNameField.value = '';
            phoneField.value = '';
            emailField.value = '';
            websiteField.value = '';
            addressField.value = '';
            statusField.value = 'Novo';
            lastContactDateField.value = '';
            notesField.value = '';
            editingClientId = null; 
            
            updateClientButton.disabled = true; 
            deleteClientButton.disabled = true; 
            clientDetailsContainer.classList.remove('edit-mode-border');
            console.log("Buttons state reset (Atualizar/Excluir desabilitados).");
        }

        /**
         * Preenche o formulário com os dados de um objeto cliente e define o ID selecionado.
         * @param {object} client - O objeto cliente contendo os dados.
         */
        function fillForm(client) {
            console.log("fillForm called for client:", client.id);
            companyNameField.value = client.companyName || '';
            phoneField.value = client.phone || '';
            emailField.value = client.email || '';
            websiteField.value = client.website || '';
            addressField.value = client.address || '';
            statusField.value = client.status || 'Novo';
            if (client.lastContactDate && client.lastContactDate.toDate) {
                lastContactDateField.value = client.lastContactDate.toDate().toISOString().split('T')[0];
            } else {
                lastContactDateField.value = '';
            }
            notesField.value = client.notes || '';
            editingClientId = client.id; 

            updateClientButton.disabled = false; 
            deleteClientButton.disabled = false; 
            clientDetailsContainer.classList.add('edit-mode-border');
            console.log("Buttons state set for editing (Atualizar/Excluir habilitados).");
        }

        /**
         * Analisa o texto bruto colado e tenta extrair informações do cliente.
         * @param {string} rawText - O texto bruto contido na área de texto.
         * @returns {object} Um objeto contendo os dados do cliente extraídos.
         */
        function parseRawData(rawText) {
            const data = {};
            const companyNameMatch = rawText.match(/(?:Nome da Empresa:|Empresa:)\s*([^\n]+)/i) || rawText.match(/^([^\n]+)/);
            if (companyNameMatch) {
                data.companyName = companyNameMatch[1].trim();
            }
            const phoneMatch = rawText.match(/(?:\(?\d{2}\)?\s*\d{4,5}[-\s]?\d{4}|\+\d{2}\s*\d{2}\s*\d{4,5}[-\s]?\d{4})/);
            if (phoneMatch) {
                data.phone = phoneMatch[0].trim();
            }
            const emailMatch = rawText.match(/[\w\.-]+@[\w\.-]+\.\w+/);
            if (emailMatch) {
                data.email = emailMatch[0].trim();
            }
            const websiteMatch = rawText.match(/(?:https?:\/\/)?(?:www\.)?([a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+(?:\/[^\s]*)?)/);
            if (websiteMatch) {
                data.website = websiteMatch[0].trim();
                if (!data.website.startsWith('http://') && !data.website.startsWith('https://')) {
                    data.website = 'http://' + data.website;
                }
            }
            const addressMatch = rawText.match(/(?:Endereço:|Rua|Av\.|Avenida|Travessa|Praça)\s*([^\n]+(?:,\s*\d+)?(?:,\s*[^\n]+)?(?:-\s*[^\n]+)?(?:,\s*CEP\s*\d{5}-?\d{3})?)/i);
            if (addressMatch) {
                data.address = addressMatch[0].trim();
            } else {
                const genericAddressMatch = rawText.match(/(\d{1,5}\s+[A-Za-z\s]+\s+(?:Rua|Av\.|Avenida|Travessa|Praça|Bairro|Centro|Cidade|Estado)[^\n]*)/i);
                if (genericAddressMatch) {
                    data.address = genericAddressMatch[0].trim();
                }
            }
            const statusMatch = rawText.match(/(?:Status:)\s*(Novo|Em Andamento|Aguardando Contato|Fechado|Perdido)/i);
            if (statusMatch) {
                data.status = statusMatch[1].charAt(0).toUpperCase() + statusMatch[1].slice(1).toLowerCase();
                const validStatuses = ['Novo', 'Em Andamento', 'Aguardando Contato', 'Fechado', 'Perdido'];
                if (!validStatuses.includes(data.status)) {
                    data.status = 'Novo';
                }
            } else {
                data.status = 'Novo';
            }
            const lastContactDateMatch = rawText.match(/(?:Último Contato:|Data Contato:)\s*(\d{4}-\d{2}-\d{2})/i);
            if (lastContactDateMatch) {
                data.lastContactDate = lastContactDateMatch[1].trim();
            }
            let notes = rawText;
            for (const key in data) {
                if (data[key]) {
                    notes = notes.replace(new RegExp(data[key].replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi'), '').trim();
                }
            }
            data.notes = notes.replace(/\s{2,}/g, ' ').trim();
            return data;
        }

        /**
         * Carrega os clientes do Firestore e os renderiza na tabela, aplicando filtros e pesquisa.
         */
        async function loadClientsFromFirestore() {
            console.log("loadClientsFromFirestore called.");
            let scrollPosition = clientTableBody.parentElement.scrollTop; // Salva a posição de rolagem
            clients = []; 
            try {
                let clientsRef = db.collection("clientes");

                // Filtros de Status e Data (aplicados no Firestore)
                const filterStatus = filterStatusField.value;
                const filterDateFrom = filterDateFromField.value;
                const filterDateTo = filterDateToField.value;

                if (filterStatus) {
                    clientsRef = clientsRef.where('status', '==', filterStatus);
                }

                if (filterDateFrom) {
                    const dateFrom = new Date(filterDateFrom + 'T00:00:00'); 
                    clientsRef = clientsRef.where('lastContactDate', '>=', dateFrom);
                }
                if (filterDateTo) {
                    const dateTo = new Date(filterDateTo + 'T23:59:59'); 
                    clientsRef = clientsRef.where('lastContactDate', '<=', dateTo);
                }

                if (filterDateFrom || filterDateTo) {
                    clientsRef = clientsRef.orderBy('lastContactDate', 'asc'); 
                    clientsRef = clientsRef.orderBy('createdAt', 'desc');     
                } else {
                    clientsRef = clientsRef.orderBy('createdAt', 'desc'); 
                }

                const snapshot = await clientsRef.get();

                let clientsToRender = []; 
                const generalSearchTerm = generalSearchInput.value.trim().toLowerCase(); 

                snapshot.forEach(doc => {
                    const clientData = doc.data();
                    if (clientData.createdAt && clientData.createdAt.toDate) {
                        clientData.createdAt = clientData.createdAt.toDate();
                    }
                    if (clientData.lastContactDate && clientData.lastContactDate.toDate) {
                        clientData.lastContactDate = clientData.lastContactDate.toDate();
                    }
                    clientsToRender.push({ id: doc.id, ...clientData });
                });

                if (generalSearchTerm) {
                    clientsToRender = clientsToRender.filter(client => {
                        const searchableFields = [
                            client.companyName,
                            client.phone,
                            client.email,
                            client.website,
                            client.address,
                            client.notes,
                            client.status 
                        ].filter(Boolean).map(field => String(field).toLowerCase()); 

                        const formattedDateText = (client.lastContactDate) ? client.lastContactDate.toLocaleDateString('pt-BR').toLowerCase() : '';
                        searchableFields.push(formattedDateText);

                        return searchableFields.some(field => field.includes(generalSearchTerm));
                    });
                }
                
                clients = clientsToRender; 
                renderClientTable();
                clientTableBody.parentElement.scrollTop = scrollPosition; // Restaura a posição de rolagem
                showMessage('Clientes carregados e filtrados/pesquisados com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao carregar clientes do Firestore: ", error);
                showMessage('Erro ao carregar clientes. Verifique as regras de segurança do Firestore e os índices do Firestore (se estiver usando filtros de data ou múltiplos filtros).', 'error');
            }
        }

        /**
         * Renderiza a tabela de clientes com os dados atuais do array 'clients'.
         */
        function renderClientTable() {
            console.log("renderClientTable called. Clients count:", clients.length);
            clientTableBody.innerHTML = '';
            if (clients.length === 0) {
                clientTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Nenhum cliente cadastrado ainda.</td></tr>`;
                return;
            }

            clients.forEach((client, index) => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'cursor-pointer', 'transition', 'duration-150', 'ease-in-out');
                row.dataset.index = index;
                row.dataset.id = client.id;

                let formattedLastContactDate = '';
                if (client.lastContactDate) { 
                    formattedLastContactDate = client.lastContactDate.toLocaleDateString('pt-BR');
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 rounded-bl-lg">${client.companyName || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${client.phone || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${client.email || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${client.website || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${client.address || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 quick-edit-status" data-field="status" data-value="${client.status || 'Novo'}">${client.status || 'Novo'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 quick-edit-date" data-field="lastContactDate" data-value="${client.lastContactDate ? client.lastContactDate.toISOString().split('T')[0] : ''}">${formattedLastContactDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 rounded-br-lg">${client.notes || ''}</td>
                `;
                clientTableBody.appendChild(row);
            });
        }

        /**
         * Exporta os dados da tabela de clientes para um arquivo XLSX.
         */
        function exportToExcel() {
            if (clients.length === 0) {
                showMessage('Não há clientes para exportar.', 'info');
                return;
            }
            const headers = [
                "Nome da Empresa", "Telefone", "Email", "Site", "Endereço", "Status", "Último Contato", "Observações"
            ];
            const data = clients.map(client => [
                client.companyName,
                client.phone,
                client.email,
                client.website,
                client.address,
                client.status,
                (client.lastContactDate) ? client.lastContactDate.toLocaleDateString('pt-BR') : '', 
                client.notes
            ]);
            const wsData = [headers, ...data];
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Clientes CRM");
            XLSX.writeFile(wb, "clientes_crm.xlsx");
            showMessage('Dados exportados para "clientes_crm.xlsx" com sucesso!', 'success');
        }

        // --- Listeners de Eventos ---

        fillFormButton.addEventListener('click', () => {
            const rawText = rawDataInput.value;
            if (rawText.trim() === '') {
                showMessage('Cole os dados brutos para preencher o formulário.', 'info');
                return;
            }
            const parsedData = parseRawData(rawText);
            clearForm(); 
            fillForm(parsedData);
            showMessage('Formulário preenchido com sucesso!', 'success');
        });

        addClientButton.addEventListener('click', async () => {
            const clientData = {
                companyName: companyNameField.value.trim(),
                phone: phoneField.value.trim(),
                email: emailField.value.trim(),
                website: websiteField.value.trim(),
                address: addressField.value.trim(),
                status: statusField.value,
                notes: notesField.value.trim(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (lastContactDateField.value) {
                clientData.lastContactDate = new Date(lastContactDateField.value + 'T00:00:00');
            } else {
                clientData.lastContactDate = firebase.firestore.FieldValue.serverTimestamp(); 
            }


            if (!clientData.companyName) {
                showMessage('O nome da empresa é obrigatório para cadastrar o cliente.', 'error');
                return;
            }

            addClientButton.disabled = true;
            loadingSpinner.classList.remove('hidden');

            try {
                let isDuplicate = false;

                const companyNameQuery = db.collection("clientes").where("companyName", "==", clientData.companyName);
                const companyNameSnapshot = await companyNameQuery.get();
                if (!companyNameSnapshot.empty) {
                    isDuplicate = true;
                }

                if (!isDuplicate && clientData.phone) {
                    const phoneQuery = db.collection("clientes").where("phone", "==", clientData.phone);
                    const phoneSnapshot = await phoneQuery.get();
                    if (!phoneSnapshot.empty) {
                        isDuplicate = true;
                    }
                }

                if (!isDuplicate && clientData.email) {
                    const emailQuery = db.collection("clientes").where("email", "==", clientData.email);
                    const emailSnapshot = await emailQuery.get();
                    if (!emailSnapshot.empty) {
                        isDuplicate = true;
                    }
                }

                if (isDuplicate) {
                    showMessage('Cliente já cadastrado na base de dados (Nome da Empresa, Telefone ou Email duplicado).', 'info');
                    addClientButton.disabled = false;
                    loadingSpinner.classList.add('hidden');
                    return; 
                }

                const docRef = await db.collection("clientes").add(clientData);
                console.log("Documento escrito com ID: ", docRef.id);
                
                await loadClientsFromFirestore(); 
                clearForm();
                rawDataInput.value = '';
                showMessage('Cliente cadastrado e salvo no Firestore com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao adicionar documento no Firestore:', error);
                showMessage(`Erro ao cadastrar cliente no Firestore: ${error.message}. Verifique as regras de segurança do Firestore.`, 'error');
            } finally {
                addClientButton.disabled = false;
                loadingSpinner.classList.add('hidden');
            }
        });

        updateClientButton.addEventListener('click', async () => {
            if (!editingClientId) {
                showMessage('Nenhum cliente selecionado para atualizar.', 'info');
                return;
            }

            const updatedClientData = {
                companyName: companyNameField.value.trim(),
                phone: phoneField.value.trim(),
                email: emailField.value.trim(),
                website: websiteField.value.trim(),
                address: addressField.value.trim(),
                status: statusField.value,
                notes: notesField.value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
            };

            if (lastContactDateField.value) {
                updatedClientData.lastContactDate = new Date(lastContactDateField.value + 'T00:00:00');
            } else {
                updatedClientData.lastContactDate = firebase.firestore.FieldValue.serverTimestamp(); 
            }

            if (!updatedClientData.companyName) {
                showMessage('O nome da empresa é obrigatório para atualizar o cliente.', 'error');
                return;
            }

            updateClientButton.disabled = true;
            updateLoadingSpinner.classList.remove('hidden');

            try {
                await db.collection("clientes").doc(editingClientId).update(updatedClientData);
                console.log("Documento atualizado com ID: ", editingClientId);

                await loadClientsFromFirestore();
                clearForm();
                showMessage('Cliente atualizado no Firestore com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao atualizar documento no Firestore:', error);
                showMessage(`Erro ao atualizar cliente no Firestore: ${error.message}. Verifique as regras de segurança.`, 'error');
            } finally {
                updateClientButton.disabled = false;
                updateLoadingSpinner.classList.add('hidden');
            }
        });

        cancelEditButton.addEventListener('click', () => {
            console.log("Cancelar Edição button clicked.");
            clearForm();
            showMessage('Edição cancelada. Formulário limpo.', 'info');
        });

        // --- Lógica para Edição Rápida na Tabela e Preenchimento do Formulário Principal ---
        clientTableBody.addEventListener('click', (event) => {
            const clickedCell = event.target.closest('td');
            const row = clickedCell ? clickedCell.closest('tr') : null;

            if (!row) return; // Se não clicou em uma linha válida, sai

            const clientId = row.dataset.id;
            const field = clickedCell ? clickedCell.dataset.field : null; // 'status' ou 'lastContactDate'
            const clientData = clients.find(c => c.id === clientId);

            if (!clientData) return; // Cliente não encontrado na lista local

            // Se o clique foi em uma célula de edição rápida (Status ou Último Contato)
            if (clickedCell && (clickedCell.classList.contains('quick-edit-status') || clickedCell.classList.contains('quick-edit-date'))) {
                event.stopPropagation(); // IMPEDE que o clique na célula acione o fillForm da linha

                // Se já estiver em modo de edição rápida nesta célula, não faz nada
                if (clickedCell.querySelector('.quick-edit-input')) {
                    return;
                }

                const originalCellContent = clickedCell.innerHTML; // Salva o conteúdo original da célula

                let inputElement;
                let saveButton = document.createElement('button');
                saveButton.classList.add('quick-edit-btn');
                saveButton.textContent = 'Salvar';

                let cancelButton = document.createElement('button');
                cancelButton.classList.add('quick-edit-btn');
                cancelButton.style.backgroundColor = '#ef4444'; // Cor vermelha para cancelar
                cancelButton.textContent = 'X';

                let containerDiv = document.createElement('div');
                containerDiv.classList.add('quick-edit-container');

                if (clickedCell.classList.contains('quick-edit-status')) {
                    inputElement = document.createElement('select');
                    inputElement.classList.add('quick-edit-input');
                    inputElement.innerHTML = `
                        <option value="Novo">Novo</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Contato">Aguardando Contato</option>
                        <option value="Fechado">Fechado</option>
                        <option value="Perdido">Perdido</option>
                    `;
                    inputElement.value = clientData.status || 'Novo';
                } else if (clickedCell.classList.contains('quick-edit-date')) {
                    inputElement = document.createElement('input');
                    inputElement.type = 'date';
                    inputElement.classList.add('quick-edit-input');
                    if (clientData.lastContactDate && clientData.lastContactDate.toISOString) {
                        inputElement.value = clientData.lastContactDate.toISOString().split('T')[0];
                    } else {
                        inputElement.value = '';
                    }
                }

                containerDiv.appendChild(inputElement);
                containerDiv.appendChild(saveButton);
                containerDiv.appendChild(cancelButton);

                clickedCell.innerHTML = ''; // Limpa o conteúdo original da célula
                clickedCell.appendChild(containerDiv); // Adiciona o campo de edição e botões
                inputElement.focus();

                // Listener para o botão Salvar da edição rápida
                saveButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await updateQuickEditField(clientId, field, inputElement.value);
                });

                // Listener para o botão Cancelar da edição rápida
                cancelButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    clickedCell.innerHTML = originalCellContent; // Reverte o conteúdo da célula
                });

                // Listener para salvar ao pressionar ENTER
                inputElement.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        await updateQuickEditField(clientId, field, inputElement.value);
                    } else if (e.key === 'Escape') { // Reverter ao pressionar ESC
                        e.preventDefault();
                        clickedCell.innerHTML = originalCellContent;
                    }
                });

                // Listener para reverter ao perder o foco (se não foi salvo)
                inputElement.addEventListener('blur', () => {
                    // Verifica se o input ainda está na célula (ou seja, não foi salvo pelo botão Salvar)
                    if (clickedCell.contains(inputElement) && !clickedCell.querySelector('.save-quick-edit-btn')) {
                        clickedCell.innerHTML = originalCellContent;
                    }
                });

            } else {
                // Se não foi uma célula de edição rápida, aciona a lógica de preencher o formulário principal
                fillForm(clientData);
                showMessage(`Dados de "${clientData.companyName}" carregados para edição.`, 'info');
            }
        });

        // Função para atualizar um campo específico no Firestore via edição rápida
        async function updateQuickEditField(clientId, field, newValue) {
            let initialScrollTop = clientTableBody.parentElement.scrollTop; // Salva a posição de rolagem antes da atualização
            try {
                let updateData = {};
                if (field === 'lastContactDate') {
                    updateData[field] = newValue ? new Date(newValue + 'T00:00:00') : firebase.firestore.FieldValue.serverTimestamp();
                } else {
                    updateData[field] = newValue;
                }
                updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();

                await db.collection("clientes").doc(clientId).update(updateData);
                showMessage('Campo atualizado com sucesso!', 'success');
                await loadClientsFromFirestore(); // Recarrega a tabela para mostrar o valor atualizado e reverter a célula
                clientTableBody.parentElement.scrollTop = initialScrollTop; // Restaura a posição de rolagem
            } catch (error) {
                console.error(`Erro ao atualizar campo ${field} no Firestore:`, error);
                showMessage(`Erro ao atualizar campo: ${error.message}`, 'error');
                await loadClientsFromFirestore(); // Recarrega para reverter visualmente em caso de erro
                clientTableBody.parentElement.scrollTop = initialScrollTop; // Tenta restaurar mesmo em erro
            }
        }
        // --- FIM: Lógica para Edição Rápida na Tabela ---


        exportExcelButton.addEventListener('click', exportToExcel);

        deleteClientButton.addEventListener('click', async () => {
            if (!editingClientId) {
                showMessage('Selecione um cliente na tabela primeiro para excluí-lo.', 'info');
                return;
            }

            deleteClientButton.disabled = true;
            deleteLoadingSpinner.classList.remove('hidden');

            try {
                await db.collection("clientes").doc(editingClientId).delete();
                console.log("Documento excluído com ID: ", editingClientId);

                await loadClientsFromFirestore();
                clearForm(); 
                showMessage('Cliente excluído com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir documento do Firestore:', error);
                showMessage(`Erro ao excluir cliente: ${error.message}. Verifique as regras de segurança do Firestore.`, 'error');
            } finally {
                deleteClientButton.disabled = false;
                deleteLoadingSpinner.classList.add('hidden');
            }
        });

        applyFiltersButton.addEventListener('click', loadClientsFromFirestore);
        clearFiltersButton.addEventListener('click', () => {
            filterStatusField.value = '';
            filterDateFromField.value = '';
            filterDateToField.value = '';
            generalSearchInput.value = ''; 
            loadClientsFromFirestore(); 
            showMessage('Filtros limpos!', 'info');
        });

        searchButton.addEventListener('click', loadClientsFromFirestore);

        document.addEventListener('DOMContentLoaded', loadClientsFromFirestore);
    </script>
</body>
</html>
